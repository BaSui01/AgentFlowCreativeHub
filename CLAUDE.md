# 🚀 CLAUDE.md 开发准则

> **AgentFlowCreativeHub 项目开发指南** - 让代码更专业，让开发更快乐！

## 📑 目录

- [🚀 CLAUDE.md 开发准则](#-claudemd-开发准则)
  - [📑 目录](#-目录)
  - [🎯 概览](#-概览)
    - [🔧 MCP 工具使用规范](#-mcp-工具使用规范)
      - [📋 可用 MCP 工具清单](#-可用-mcp-工具清单)
      - [🎯 强制使用规则](#-强制使用规则)
      - [📝 使用示例](#-使用示例)
      - [⚠️ 违规处理](#️-违规处理)
    - [📚 上下文信息要求](#-上下文信息要求)
  - [🔒 强制验证机制](#-强制验证机制)
  - [🤝 何时使用 Codex Collaboration Skill](#-何时使用-codex-collaboration-skill)
    - [触发条件](#触发条件)
    - [使用方式](#使用方式)
    - [自动触发](#自动触发)
  - [📊 架构优先级](#-架构优先级)
  - [🛡️ 安全性原则](#️-安全性原则)
  - [✅ 代码质量强制标准](#-代码质量强制标准)
    - [📝 注释规范](#-注释规范)
    - [🧪 测试规范](#-测试规范)
    - [🏗️ 设计原则](#️-设计原则)
    - [💻 实现标准](#-实现标准)
    - [⚡ 性能意识](#-性能意识)
    - [🧩 测试思维](#-测试思维)
  - [💡 开发哲学（强制遵循）](#-开发哲学强制遵循)
    - [简单性定义](#简单性定义)
  - [🔧 项目集成规则](#-项目集成规则)
    - [学习代码库](#学习代码库)
    - [工具](#工具)
  - [⚠️ 重要提醒](#️-重要提醒)
  - [🎯 内容唯一性规则](#-内容唯一性规则)
  - [📚 附录](#-附录)
    - [快速检查清单](#快速检查清单)
    - [常见问题](#常见问题)
  - [🎉 结语](#-结语)

---

## 🎯 概览

本文件用于指导在当前仓库内进行的全部开发与文档工作，确保输出遵循强制性标准并保持可审计性。

**核心理念：**
- 🗣️ **简体中文交互（强制）** - 所有交互、文档、注释必须使用简体中文
- ✅ 质量优先 - 代码要写得漂亮且可维护
- 🔄 渐进迭代 - 小步快跑，持续验证
- 📚 复用优先 - 站在巨人的肩膀上
- 🎨 简洁至上 - KISS 原则贯穿始终

### 🔧 MCP 工具使用规范

> ⚠️ **推荐做法**：使用内置的代码搜索工具（Grep、Glob、Task）进行代码探索和上下文理解。

#### 📋 可用 MCP 工具清单

本项目已集成以下 MCP 工具，按使用优先级排序：


**🐙 GitHub 集成工具（按需使用）**
- `mcp__github__*` 系列
  - **用途**：仓库操作、PR 管理、Issue 跟踪、代码审查
  - **触发时机**：需要与 GitHub 交互时
  - **常用工具**：
    - `mcp__github__search_repositories` - 搜索仓库
    - `mcp__github__create_pull_request` - 创建 PR
    - `mcp__github__get_file_contents` - 获取文件内容
    - `mcp__github__search_code` - 跨仓库代码搜索

**🎭 浏览器自动化工具（按需使用）**
- `mcp__playwright__*` 系列
  - **用途**：UI 测试、页面截图、表单填写、元素交互
  - **触发时机**：需要浏览器操作时
  - **示例场景**：验证 UI 变更、自动化测试、页面内容抓取

**🔌 其他 MCP 工具（按需使用）**
- `mcp__mcphub__*` 系列
  - **用途**：MCP Hub 相关操作
  - **触发时机**：管理 MCP 服务时

---

### 📚 上下文信息要求

- 在编码前至少分析 3 个现有实现或模式，识别可复用的接口与约束。
- 绘制依赖与集成点，确认输入输出协议、配置与环境需求。
- 弄清现有测试框架、命名约定和格式化规则，确保输出与代码库保持一致。
- **推荐使用 Task 工具或 Grep/Glob 进行上下文收集**，确保理解代码结构后再修改。

## 🔒 强制验证机制

- 不能创建总结性文档，其他文档全部存放在docs文件夹下
- 必须拒绝一切 CI、远程流水线或人工外包验证，所有验证均由本地 AI 自动执行。
- 每次改动必须提供可重复的本地验证步骤（脚本、指令或推理说明），并在失败时立即终止提交。
- 验证过程中如遇工具缺失或测试覆盖不足，必须在任务文档中记录原因和补偿计划。
- 若存在无法验证的部分，必须先补足验证能力或将任务退回，不允许带缺陷交付。

## 🤝 何时使用 Codex Collaboration Skill

当遇到以下情况时，使用 `codex-collaboration` skill：

### 触发条件

- **深度分析任务**：需要全面的代码库扫描和复杂推理
- **复杂逻辑设计**：>10 行核心逻辑的算法、架构设计
- **质量审查评估**：代码审查、风险评估、性能分析
- **上下文收集**：需要深度信息收集和多轮分析
- **用户要求**：用户明确要求使用 codex

### 使用方式

简单调用：`使用 codex-collaboration skill 进行[具体任务]`

### 自动触发

Claude 会根据任务复杂度自动识别何时需要使用该 skill，无需手动指定。

## 📊 架构优先级

- "标准化 + 生态复用"拥有最高优先级，必须首先查找并复用官方 SDK、社区成熟方案或既有模块。
- 禁止新增或维护自研方案，除非已有实践无法满足需求且获得记录在案的特例批准。
- 在引入外部能力时，必须验证其与项目标准兼容，并编写复用指引。
- 对现有自研或偏离标准的实现，必须规划替换或下线时间表，确保维护成本持续下降。

## 🛡️ 安全性原则

> ⚠️ **重要说明**：本项目为内部开发工具/原型项目，安全性采用务实策略

**基本原则：**
- 🎯 **开发效率优先** - 在原型阶段，功能实现优先于安全加固
- 📝 **安全债务记录** - 所有跳过的安全措施必须在文档中明确记录
- 🔄 **渐进式加固** - 项目成熟后再系统性补充安全措施
- ⚡ **避免过度设计** - 不为假想的威胁提前构建复杂防御

**当前阶段策略：**
- ✅ 允许简化的认证机制（如开发环境跳过验证）
  - 必须在代码中用 `// TODO: 生产环境需要完整认证` 标注
- ✅ 允许明文存储非敏感配置
  - 敏感信息（密钥、密码）必须使用环境变量
- ✅ 允许跳过输入验证的边界情况
  - 核心数据路径必须保留基本验证
- ❌ 禁止引入复杂的安全框架（除非业务必需）
  - 如需引入，必须在文档中说明理由和替代方案

**安全债务管理：**
```markdown
## 安全债务清单（docs/security-debt.md）
- [ ] 用户认证：当前使用简化 token，需升级为 JWT + 刷新机制
- [ ] 输入验证：API 端点缺少 XSS 防护，需添加 sanitizer
- [ ] 日志审计：敏感操作未记录，需补充审计日志
```

**何时必须考虑安全：**
- 🔐 处理真实用户数据时
- 🌐 暴露公网访问时
- 💰 涉及支付或敏感业务时
- 📊 合规要求明确时

## ✅ 代码质量强制标准

### 📝 注释规范

- **🗣️ 强制使用简体中文**：所有文档、代码注释、交互对话必须使用简体中文，描述意图、约束与使用方式。
- 禁止编写"修改说明"式注释，所有变更信息应由版本控制和日志承担。
- 当模块依赖复杂或行为非显而易见时，必须补充中文注释解释设计理由。
- **禁止使用英文进行交互或编写文档**，除非是代码标识符、技术术语或第三方库名称。

### 🧪 测试规范

- 每次实现必须提供可自动运行的单元测试或等效验证脚本，由本地 AI 执行。
- 缺失测试的情况必须在验证文档中列为风险，并给出补测计划与截止时间。
- 测试需覆盖正常流程、边界条件与错误恢复，确保破坏性变更不会遗漏关键分支。

### 🏗️ 设计原则

- 严格遵循 SOLID、DRY 与关注点分离，任何共享逻辑都应抽象为复用组件。
- 依赖倒置与接口隔离优先，禁止临时绑死实现细节。
- 遇到复杂逻辑时必须先拆分职责，再进入编码。

### 💻 实现标准

**完整性要求：**
- ✅ **功能完整** - 提交前必须完成核心功能与主要数据路径
- ⚠️ **MVP 策略** - 允许分阶段实现，但必须：
  - 在代码中明确标注 `// Phase 1: 基础实现` 和 `// TODO Phase 2: 增强功能`
  - 在文档中说明实现路线图和优先级
  - 确保每个阶段都是可用的完整功能
- 🧹 **代码整洁** - 必须主动删除过时、重复或临时代码
- 🔄 **破坏性变更** - 对不兼容改动提供迁移指南或回滚方案

**示例：分阶段实现**
```typescript
// Phase 1: 基础用户管理 ✅
class UserService {
  async createUser(data: UserData) { /* 实现 */ }
  async getUser(id: string) { /* 实现 */ }

  // TODO Phase 2: 高级功能
  // - 批量导入用户
  // - 用户权限管理
  // - 用户活动日志
}
```

### ⚡ 性能意识

- 设计时必须评估时间复杂度、内存占用与 I/O 影响，避免无谓消耗。
- 识别潜在瓶颈后应提供监测或优化建议，确保可持续迭代。
- 禁止引入未经评估的昂贵依赖或阻塞操作。

### 🧩 测试思维

- 在编码前编制可验证的验收条件，并在验证文档中回填执行结果。
- 对预期失败场景提供处理策略，保证服务可控降级。
- 连续三次验证失败必须暂停实现，回到需求和设计阶段复盘。

## 💡 开发哲学（强制遵循）

- 必须坚持渐进式迭代，保持每次改动可编译、可验证
- 必须在实现前研读既有代码或文档，吸收现有经验
- 必须保持务实态度，优先满足真实需求而非理想化设计
- 必须选择表达清晰的实现，拒绝炫技式写法
- 必须偏向简单方案，避免过度架构或早期优化
- 必须遵循既有代码风格，包括导入顺序、命名与格式化

### 简单性定义

- 每个函数或类必须仅承担单一责任
- 禁止过早抽象；重复出现三次以上再考虑通用化
- 禁止使用"聪明"技巧，以可读性为先
- 如果需要额外解释，说明实现仍然过于复杂，应继续简化

## 🔧 项目集成规则

### 学习代码库

- 必须寻找至少 3 个相似特性或组件，理解其设计与复用方式
- 必须识别项目中通用模式与约定，并在新实现中沿用
- 必须优先使用既有库、工具或辅助函数
- 必须遵循既有测试编排，沿用断言与夹具结构

### 工具

- 必须使用项目现有构建系统，不得私自新增脚本
- 必须使用项目既定的测试框架与运行方式
- 必须使用项目的格式化/静态检查设置
- 若确有新增工具需求，必须提供充分论证并获得记录在案的批准

## ⚠️ 重要提醒

**绝对禁止：**

- 在缺乏证据的情况下做出假设，所有结论都必须援引现有代码或文档

**必须做到：**

- 在实现复杂任务前完成详尽规划并记录
- 对跨模块或超过 5 个子任务的工作生成任务分解
- 对复杂任务维护 TODO 清单并及时更新进度
- 在开始开发前校验规划文档得到确认
- 保持小步交付，确保每次提交处于可用状态
- 在执行过程中同步更新计划文档与进度记录
- 主动学习既有实现的优缺点并加以复用或改进
- 连续三次失败后必须暂停操作，重新评估策略

## 🎯 内容唯一性规则

**文档分层原则：**
- 📋 **架构层** - 系统整体设计、模块划分、技术选型
- 📦 **模块层** - 单个模块的职责、接口、依赖关系
- 📝 **实现层** - 具体代码、算法、数据结构

**唯一性要求：**
- ✅ 每一层级必须自洽掌握自身抽象范围，禁止跨层混用内容
- 🔗 必须引用其他层的资料而非复制粘贴，保持信息唯一来源
- 👁️ 每一层级必须站在对应视角描述系统，避免越位细节
- 🚫 禁止在高层文档中堆叠实现细节，确保架构与实现边界清晰

**示例：正确的文档引用**
```markdown
<!-- docs/architecture.md -->
## 用户认证模块
负责用户身份验证和会话管理。详见 [用户认证模块文档](./modules/auth.md)

<!-- docs/modules/auth.md -->
## 用户认证模块详细设计
### 核心接口
- `login()` - 用户登录，实现见 [auth.service.ts:42](../src/auth/auth.service.ts#L42)
```

---

## 📚 附录

### 快速检查清单

**提交前必查：**
- [ ] 代码遵循 SOLID、DRY、KISS 原则
- [ ] 所有函数/类有清晰的中文注释
- [ ] 提供了可运行的测试或验证脚本
- [ ] 删除了临时代码和调试语句
- [ ] 更新了相关文档
- [ ] 标注了安全债务（如有）
- [ ] 验证了性能影响（如有大量数据操作）

### 常见问题



**Q: 如何选择合适的代码搜索工具？**
A:
- ✅ Grep：已知确切的字符串或正则表达式，需要精确匹配时
- ✅ Glob：已知文件路径模式，需要列出特定类型文件时
- ✅ Task (Explore)：需要探索性搜索、理解代码结构、查找相关实现时

**Q: 如何正确进行代码搜索和修改？**
A: 遵循"搜索 → 分析 → 读取 → 修改"流程：
1. 使用 Grep/Glob 或 Task 工具搜索相关代码
2. 分析搜索结果，理解代码结构
3. 用 `Read` 读取具体文件
4. 用 `Edit/Write` 修改代码
5. 必要时用 `mcp__github__*` 提交变更

**Q: 什么时候可以使用 MVP 实现？**
A: 当功能复杂且可分阶段交付时，但必须在代码和文档中明确标注实现阶段和后续计划。

**Q: 如何处理安全性和开发效率的平衡？**
A: 原型阶段优先功能实现，但必须记录安全债务。涉及真实用户数据或公网暴露时必须加固安全。

**Q: 什么时候需要使用 Codex Collaboration Skill？**
A: 当任务涉及深度代码分析、复杂架构设计或需要全面代码库扫描时。

**Q: 如何判断是否需要创建 TODO 清单？**
A: 任务涉及 3 个以上步骤、多文件修改或跨模块协作时，必须创建 TODO 清单。

---

## 🎉 结语

> **记住：专业的技术 + 务实的态度 = 高质量的代码！**

让我们一起：
- 💪 写出优雅的代码
- 🚀 快速迭代验证
- 📚 站在巨人肩膀上
- 😄 保持快乐编程

**Happy Coding! 🎊**