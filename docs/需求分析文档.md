# 需求分析文档

## 1. 项目背景与目标

### 1.1 项目背景
在当前AI技术快速发展的背景下，内容创作领域正在经历深刻变革。传统的内容创作流程存在以下痛点：
- **效率低下**：单一作者创作周期长，难以满足快速迭代的需求
- **质量不稳定**：依赖个人能力，缺乏标准化的质量控制流程
- **协作困难**：多人协作时沟通成本高，版本管理混乱
- **资源浪费**：优秀的创作经验和模板难以复用和传承

**AgentFlowCreativeHub** 应运而生,旨在通过多Agent协作的方式,构建一个智能化、标准化、可扩展的内容创作平台。相较于 Python 生态中的 Dify 或 LangFlow,本项目致力于利用 **Go 语言** 的高并发与部署优势,打造面向企业级内容生产的高性能解决方案。

### 1.2 项目目标
- **提升创作效率**：通过多Agent协作，将创作周期缩短50%以上
- **保证内容质量**：建立标准化的审核流程，确保内容质量稳定可控
- **促进知识复用**：构建提示词模板库，沉淀优秀创作经验
- **支持多租户**：满足不同组织和团队的独立使用需求
- **灵活扩展**：支持多种AI模型和向量检索能力，适应不同场景

### 1.3 关键成果指标（KPI）
- **性能指标**：
  - 单个任务平均处理时间 < 5分钟
  - 系统并发支持 ≥ 100个任务 (目标 10k+ goroutines)
  - API响应时间 < 500ms (P95)
  - 服务启动时间 < 1s (Serverless Ready)

- **质量指标**：
  - 内容审核通过率 ≥ 85%
  - 用户满意度 ≥ 4.5/5.0
  - 系统可用性 ≥ 99.9%

- **业务指标**：
  - 活跃用户数月增长率 ≥ 20%
  - 模板复用率 ≥ 60%
  - 平台日均任务量 ≥ 500个  

## 2. 关键功能需求 (Enhanced)

### 2.1 工作流与编排 (Workflow & Orchestration)
- **可视化流程编排 (Visual Builder)**: 
  - 提供基于节点的拖拽式编辑器 (React Flow)，直观设计 Agent 协作链。
  - 支持串行、并行、条件分支 (Switch)、循环 (Loop) 等控制流。
- **DSL 定义**: 
  - 定义可移植的 YAML/JSON 工作流描述语言，支持导入/导出。
- **人机交互节点 (Human-in-the-Loop)**:
  - **审批节点**: 关键内容发布前需人工审核。
  - **输入节点**: 流程中途请求用户补充信息。
- **状态管理**:
  - 基于状态机 (State Machine) 的任务流转，支持断点续传和持久化。

### 2.2 工具与插件生态 (Tool & Plugin Ecosystem)
- **标准化工具接口**: 
  - 定义 Go 接口 `Tool { Name, Description, Schema, Execute }`，兼容 OpenAI Function Calling 标准。
- **内置核心工具**:
  - **Web Search**: 集成 Google/SerpApi 进行实时信息检索。
  - **Web Scraper**: 网页内容抓取与清洗。
  - **File Reader**: 支持 PDF, Word, Markdown 等多格式文档读取。
  - **Code Interpreter**: (规划中) 安全的沙箱代码执行环境。

### 2.3 RAG 增强检索 (RAG Pipeline)
- **混合检索 (Hybrid Search)**:
  - 结合 **关键词检索 (BM25)** 与 **向量检索 (Vector Search)**，提升召回准确率。
- **重排序 (Rerank)**:
  - 在检索结果后增加 Rerank 步骤 (如 Cohere Rerank 或 BGE-Reranker)，优化上下文相关性。
- **多路召回**: 
  - 支持同时从多个知识库或异构数据源召回信息。

### 2.4 AI 原生可观测性 (AI-Native Observability)
- **全链路追踪 (Traceability)**:
  - 记录完整的 "Input -> Agent -> Tool -> Output" 执行链，支持可视化的 Trace 展示。
- **成本与 Token 审计**:
  - 精确统计每个租户、用户、模型的 Token 消耗与预估成本。
- **质量评估**:
  - 收集用户对生成结果的反馈 (Thumbs up/down)，用于模型优化。

### 2.5 基础管理功能
- **提示词模板库**: 支持版本管理、变量注入、权限控制 (私有/团队/公开)。
- **模型管理**: 统一的模型适配层 (Model Adapter)，支持 OpenAI, Claude, Ollama 等。
- **多租户管理**: 严格的数据隔离与 RBAC 权限控制。

## 3. 非功能需求 (Go Specific)

### 3.1 高并发与性能
- **Goroutine 并发模型**: 
  - 充分利用 Go 语言特性，支持 **10,000+** 并发 Agent 任务执行。
  - 避免 Python GIL 带来的性能瓶颈，实现真正的多核并行。
- **低资源占用**:
  - 保持单实例内存占用 < 500MB (空闲时)，降低部署成本。
- **快速启动**:
  - 优化初始化流程，确保服务启动时间 < 1秒，适配 Serverless 冷启动场景。

### 3.2 可扩展性
- **水平扩展**: 无状态服务设计，支持 K8s HPA 自动扩缩容。
- **插件化架构**: 
  - Agent 能力、Tools 工具、Vector Stores 均采用接口抽象，支持热插拔扩展。
- **多租户隔离**: 
  - 数据库 Row-level security 或 Schema 隔离，确保企业级数据安全。

### 3.3 安全与合规
- **身份认证**: 集成 OAuth2.0 / OIDC，支持企业 SSO。
- **数据加密**: 全链路 TLS 1.3 加密，敏感配置 (API Key) 加密存储 (AES-256)。
- **API 安全**: 内置 Rate Limiting (基于 Token Bucket)，防止恶意刷量。
- **审计日志**: 记录所有关键操作 (Create, Update, Delete, Execute)，满足合规审计。

### 3.4 可维护性与部署
- **单文件交付**: 编译为单一 Binary 文件，简化运维部署 (无需复杂的 Python venv)。
- **结构化日志**: 采用 Zap/Slog 输出 JSON 格式日志，易于 ELK/Loki 采集。
- **健康检查**: 提供 `/health` 和 `/ready` 探针，集成 Prometheus Metrics。

## 4. 业务流程 & 用例  
- 用例 1：作者任务创建流程 (基于 Workflow)
- 用例 2：模板管理流程  
- 用例 3：模型管理流程  
- 用例 4：向量检索流程 (Hybrid Search + Rerank)
- 用例 5：人工审核介入流程 (Human-in-the-Loop)

## 5. 数据模型概览  
- 租户表 (tenants)  
- 用户表 (users)  
- 角色表 (roles) + 用户角色表 (user_roles)  
- 模型表 (models)  
- 提示词模板表 (prompt_templates)  
- 模板版本表 (prompt_template_versions)  
- 任务表 (tasks) + 状态历史 (task_history)  
- 工作流定义表 (workflows) + 节点定义 (workflow_nodes)
- 内容稿件表 (documents)  
- 向量数据库相关元数据表  
- 审核记录表 (reviews)  
- 成本审计表 (token_usages)

## 6. 接口概要 & 权限  
- 登录／注册／租户注册  
- 模型列表拉取接口  
- 模板列表／创建／编辑／共享接口  
- 工作流管理接口 (CRUD, Execute, Debug)
- 任务创建／提交／状态查询接口  
- Agent 调用接口  
- 审核接口  
- 归档接口  
- 管理界面接口（用户、租户、模型、模板）  
- 角色／权限管理接口  

## 7. 排期与里程碑  
- **Phase 1 (MVP)**: 基础 Agent 运行时，线性工作流，CLI/API 调用，Docker 部署。
- **Phase 2 (Enhancement)**: 可视化工作流编辑器，RAG 混合检索，人机交互节点。
- **Phase 3 (Platform)**: 插件市场，SaaS 多租户计费，高级可观测性，企业级安全。

## 8. 风险与假设  
- 假设：Go 生态的 AI 库 (langchaingo 等) 成熟度满足需求，部分可能需要自研封装。
- 风险：复杂工作流 (如循环/递归) 的死锁检测与资源控制。
- 缓解措施：在 Orchestrator 中引入严格的超时与最大步数限制。
