# ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡æ–‡æ¡£

> **ç‰ˆæœ¬**: v1.0  
> **åˆ›å»ºæ—¥æœŸ**: 2025-11-17  
> **æ•°æ®åº“**: PostgreSQL 14+

---

## ğŸ“‹ ç›®å½•

- [è®¾è®¡åŸåˆ™](#è®¾è®¡åŸåˆ™)
- [ER å›¾](#er-å›¾)
- [è¡¨ç»“æ„è¯¦ç»†è®¾è®¡](#è¡¨ç»“æ„è¯¦ç»†è®¾è®¡)
- [ç´¢å¼•ç­–ç•¥](#ç´¢å¼•ç­–ç•¥)
- [åˆ†åŒºç­–ç•¥](#åˆ†åŒºç­–ç•¥)
- [æ•°æ®è¿ç§»](#æ•°æ®è¿ç§»)

---

## ğŸ¯ è®¾è®¡åŸåˆ™

### 1. å¤šç§Ÿæˆ·éš”ç¦»
- æ‰€æœ‰ä¸šåŠ¡è¡¨åŒ…å« `tenant_id` å­—æ®µ
- é€šè¿‡ä¸­é—´ä»¶è‡ªåŠ¨æ³¨å…¥ç§Ÿæˆ·ä¸Šä¸‹æ–‡
- ç´¢å¼•è®¾è®¡ä¼˜å…ˆè€ƒè™‘ç§Ÿæˆ·ç»´åº¦æŸ¥è¯¢

### 2. è½¯åˆ é™¤
- å…³é”®ä¸šåŠ¡è¡¨ä½¿ç”¨ `deleted_at` è½¯åˆ é™¤
- ä¿ç•™å†å²æ•°æ®ç”¨äºå®¡è®¡å’Œåˆ†æ

### 3. æ—¶é—´æˆ³
- æ‰€æœ‰è¡¨åŒ…å« `created_at` å’Œ `updated_at`
- ä½¿ç”¨æ•°æ®åº“è§¦å‘å™¨è‡ªåŠ¨æ›´æ–° `updated_at`

### 4. ä¸»é”®ç­–ç•¥
- ä½¿ç”¨ UUID ä½œä¸ºä¸»é”®
- é¿å…ä¸»é”®æš´éœ²ä¸šåŠ¡è§„æ¨¡
- æ”¯æŒåˆ†å¸ƒå¼ç³»ç»Ÿæ‰©å±•

### 5. å¤–é”®çº¦æŸ
- å…³é”®å…³ç³»ä½¿ç”¨å¤–é”®çº¦æŸ
- çº§è”åˆ é™¤ç­–ç•¥ï¼š`ON DELETE CASCADE` / `ON DELETE SET NULL`

---

## ğŸ”— ER å›¾

```mermaid
erDiagram
    TENANTS ||--o{ USERS : contains
    TENANTS ||--o{ ROLES : contains
    TENANTS ||--o{ TENANT_CONFIGS : has
    TENANTS ||--o{ KNOWLEDGE_BASES : owns
    TENANTS ||--o{ WORKFLOWS : creates
    
    USERS ||--o{ USER_ROLES : has
    USERS ||--o{ AUDIT_LOGS : generates
    USERS ||--o{ MODEL_CALL_LOGS : calls
    
    ROLES ||--o{ USER_ROLES : assigned_to
    ROLES ||--o{ ROLE_PERMISSIONS : has
    
    PERMISSIONS ||--o{ ROLE_PERMISSIONS : granted_to
    
    KNOWLEDGE_BASES ||--o{ KNOWLEDGE_DOCUMENTS : contains
    KNOWLEDGE_DOCUMENTS ||--o{ KNOWLEDGE_CHUNKS : split_into
    
    MODELS ||--o{ AGENT_CONFIGS : used_by
    MODELS ||--o{ MODEL_CALL_LOGS : tracks
    
    WORKFLOWS ||--o{ WORKFLOW_EXECUTIONS : executes
    WORKFLOW_EXECUTIONS ||--o{ WORKFLOW_TASKS : contains
    
    PROMPT_TEMPLATES ||--o{ PROMPT_TEMPLATE_VERSIONS : versioned
    PROMPT_TEMPLATES ||--o{ AGENT_CONFIGS : uses
```

---

## ğŸ“Š è¡¨ç»“æ„è¯¦ç»†è®¾è®¡

### 1. ç§Ÿæˆ·ä¸ç”¨æˆ·ç®¡ç†

#### 1.1 tenants - ç§Ÿæˆ·è¡¨

```sql
CREATE TABLE tenants (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(255) NOT NULL,
    slug VARCHAR(100) UNIQUE NOT NULL,  -- URLå‹å¥½æ ‡è¯†
    status VARCHAR(50) NOT NULL DEFAULT 'active',  -- active, suspended, deleted
    tier VARCHAR(50) NOT NULL DEFAULT 'free',  -- free, pro, enterprise
    
    -- è”ç³»ä¿¡æ¯
    contact_email VARCHAR(255),
    contact_phone VARCHAR(50),
    
    -- é…é¢
    max_users INT DEFAULT 5,
    max_workflows INT DEFAULT 10,
    max_knowledge_bases INT DEFAULT 3,
    
    -- æ—¶é—´æˆ³
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW(),
    deleted_at TIMESTAMP,
    
    -- çº¦æŸ
    CONSTRAINT check_status CHECK (status IN ('active', 'suspended', 'deleted')),
    CONSTRAINT check_tier CHECK (tier IN ('free', 'pro', 'enterprise'))
);

-- ç´¢å¼•
CREATE INDEX idx_tenants_slug ON tenants(slug);
CREATE INDEX idx_tenants_status ON tenants(status) WHERE deleted_at IS NULL;
CREATE INDEX idx_tenants_created_at ON tenants(created_at DESC);

-- æ³¨é‡Š
COMMENT ON TABLE tenants IS 'ç§Ÿæˆ·è¡¨ï¼Œæ”¯æŒå¤šç§Ÿæˆ·éš”ç¦»';
COMMENT ON COLUMN tenants.slug IS 'URLå‹å¥½çš„ç§Ÿæˆ·æ ‡è¯†ï¼Œç”¨äºå­åŸŸå';
COMMENT ON COLUMN tenants.tier IS 'ç§Ÿæˆ·å±‚çº§ï¼Œå†³å®šé…é¢å’ŒåŠŸèƒ½æƒé™';
```

#### 1.2 users - ç”¨æˆ·è¡¨

```sql
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
    
    -- è®¤è¯ä¿¡æ¯
    username VARCHAR(100) NOT NULL,
    email VARCHAR(255) NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    
    -- ä¸ªäººä¿¡æ¯
    full_name VARCHAR(255),
    avatar_url TEXT,
    locale VARCHAR(10) DEFAULT 'zh-CN',  -- zh-CN, en-US
    timezone VARCHAR(50) DEFAULT 'Asia/Shanghai',
    
    -- çŠ¶æ€
    status VARCHAR(50) NOT NULL DEFAULT 'active',  -- active, inactive, locked
    email_verified BOOLEAN DEFAULT FALSE,
    last_login_at TIMESTAMP,
    
    -- æ—¶é—´æˆ³
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW(),
    deleted_at TIMESTAMP,
    
    -- çº¦æŸ
    UNIQUE(tenant_id, email),
    UNIQUE(tenant_id, username),
    CONSTRAINT check_user_status CHECK (status IN ('active', 'inactive', 'locked'))
);

-- ç´¢å¼•
CREATE INDEX idx_users_tenant_id ON users(tenant_id);
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_status ON users(tenant_id, status) WHERE deleted_at IS NULL;

-- æ³¨é‡Š
COMMENT ON TABLE users IS 'ç”¨æˆ·è¡¨ï¼Œæ”¯æŒç§Ÿæˆ·çº§éš”ç¦»';
COMMENT ON COLUMN users.email_verified IS 'é‚®ç®±éªŒè¯çŠ¶æ€ï¼Œå½±å“ç™»å½•æƒé™';
```

#### 1.3 roles - è§’è‰²è¡¨

```sql
CREATE TABLE roles (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
    
    name VARCHAR(100) NOT NULL,
    code VARCHAR(100) NOT NULL,  -- admin, editor, viewer
    description TEXT,
    
    -- ç³»ç»Ÿè§’è‰²æ ‡è¯†
    is_system BOOLEAN DEFAULT FALSE,  -- ç³»ç»Ÿé¢„ç½®è§’è‰²ä¸å¯åˆ é™¤
    
    -- æ—¶é—´æˆ³
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW(),
    
    -- çº¦æŸ
    UNIQUE(tenant_id, code)
);

-- ç´¢å¼•
CREATE INDEX idx_roles_tenant_id ON roles(tenant_id);
CREATE INDEX idx_roles_code ON roles(code);

-- æ’å…¥ç³»ç»Ÿè§’è‰²
INSERT INTO roles (tenant_id, name, code, is_system) VALUES
    ('00000000-0000-0000-0000-000000000000', 'è¶…çº§ç®¡ç†å‘˜', 'super_admin', TRUE),
    ('00000000-0000-0000-0000-000000000000', 'ç®¡ç†å‘˜', 'admin', TRUE),
    ('00000000-0000-0000-0000-000000000000', 'ç¼–è¾‘', 'editor', TRUE),
    ('00000000-0000-0000-0000-000000000000', 'æŸ¥çœ‹è€…', 'viewer', TRUE);
```

#### 1.4 permissions - æƒé™è¡¨

```sql
CREATE TABLE permissions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    resource VARCHAR(100) NOT NULL,  -- tenants, users, workflows, agents
    action VARCHAR(100) NOT NULL,    -- read, create, update, delete, manage
    description TEXT,
    
    -- çº¦æŸ
    UNIQUE(resource, action)
);

-- æ’å…¥ç³»ç»Ÿæƒé™
INSERT INTO permissions (resource, action, description) VALUES
    ('tenants', 'manage', 'ç®¡ç†ç§Ÿæˆ·'),
    ('users', 'manage', 'ç®¡ç†ç”¨æˆ·'),
    ('roles', 'manage', 'ç®¡ç†è§’è‰²'),
    ('workflows', 'read', 'æŸ¥çœ‹å·¥ä½œæµ'),
    ('workflows', 'create', 'åˆ›å»ºå·¥ä½œæµ'),
    ('workflows', 'update', 'æ›´æ–°å·¥ä½œæµ'),
    ('workflows', 'delete', 'åˆ é™¤å·¥ä½œæµ'),
    ('workflows', 'execute', 'æ‰§è¡Œå·¥ä½œæµ'),
    ('agents', 'execute', 'æ‰§è¡Œ Agent'),
    ('templates', 'manage', 'ç®¡ç†æ¨¡æ¿'),
    ('knowledge_bases', 'manage', 'ç®¡ç†çŸ¥è¯†åº“'),
    ('audit_logs', 'read', 'æŸ¥çœ‹å®¡è®¡æ—¥å¿—');
```

#### 1.5 user_roles - ç”¨æˆ·è§’è‰²å…³è”è¡¨

```sql
CREATE TABLE user_roles (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    role_id UUID NOT NULL REFERENCES roles(id) ON DELETE CASCADE,
    
    -- æ—¶é—´æˆ³
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    
    -- çº¦æŸ
    UNIQUE(user_id, role_id)
);

-- ç´¢å¼•
CREATE INDEX idx_user_roles_user_id ON user_roles(user_id);
CREATE INDEX idx_user_roles_role_id ON user_roles(role_id);
```

#### 1.6 role_permissions - è§’è‰²æƒé™å…³è”è¡¨

```sql
CREATE TABLE role_permissions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    role_id UUID NOT NULL REFERENCES roles(id) ON DELETE CASCADE,
    permission_id UUID NOT NULL REFERENCES permissions(id) ON DELETE CASCADE,
    
    -- æ—¶é—´æˆ³
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    
    -- çº¦æŸ
    UNIQUE(role_id, permission_id)
);

-- ç´¢å¼•
CREATE INDEX idx_role_permissions_role_id ON role_permissions(role_id);
```

#### 1.7 tenant_configs - ç§Ÿæˆ·é…ç½®è¡¨

```sql
CREATE TABLE tenant_configs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
    
    -- AI é…ç½®
    default_model VARCHAR(100),  -- gpt-4, claude-3-5-sonnet
    max_tokens_per_request INT DEFAULT 4096,
    temperature DECIMAL(3,2) DEFAULT 0.7,
    
    -- RAG é…ç½®
    default_embedding_model VARCHAR(100),  -- text-embedding-3-large
    vector_search_top_k INT DEFAULT 10,
    vector_search_threshold DECIMAL(3,2) DEFAULT 0.7,
    
    -- å·¥ä½œæµé…ç½®
    max_concurrent_workflows INT DEFAULT 5,
    workflow_timeout_seconds INT DEFAULT 3600,
    
    -- æ‰©å±•é…ç½®ï¼ˆJSONï¼‰
    extra_config JSONB,
    
    -- æ—¶é—´æˆ³
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW(),
    
    -- çº¦æŸ
    UNIQUE(tenant_id)
);
```

---

### 2. AI æ¨¡å‹ç®¡ç†

#### 2.1 models - æ¨¡å‹è¡¨

```sql
CREATE TABLE models (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- æ¨¡å‹ä¿¡æ¯
    name VARCHAR(100) NOT NULL UNIQUE,  -- gpt-4, claude-3-5-sonnet
    provider VARCHAR(50) NOT NULL,      -- openai, anthropic, custom
    model_type VARCHAR(50) NOT NULL,    -- chat, embedding
    
    -- èƒ½åŠ›æè¿°
    description TEXT,
    max_tokens INT,
    supports_streaming BOOLEAN DEFAULT FALSE,
    supports_function_calling BOOLEAN DEFAULT FALSE,
    
    -- æˆæœ¬ï¼ˆæŒ‰ 1000 tokens è®¡ç®—ï¼‰
    input_cost_per_1k DECIMAL(10,6),
    output_cost_per_1k DECIMAL(10,6),
    
    -- çŠ¶æ€
    status VARCHAR(50) NOT NULL DEFAULT 'active',
    
    -- æ—¶é—´æˆ³
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW(),
    
    -- çº¦æŸ
    CONSTRAINT check_provider CHECK (provider IN ('openai', 'anthropic', 'custom')),
    CONSTRAINT check_model_type CHECK (model_type IN ('chat', 'embedding')),
    CONSTRAINT check_status CHECK (status IN ('active', 'deprecated', 'disabled'))
);

-- æ’å…¥é¢„ç½®æ¨¡å‹
INSERT INTO models (name, provider, model_type, max_tokens, supports_streaming, input_cost_per_1k, output_cost_per_1k) VALUES
    ('gpt-4', 'openai', 'chat', 8192, TRUE, 0.03, 0.06),
    ('gpt-3.5-turbo', 'openai', 'chat', 4096, TRUE, 0.0015, 0.002),
    ('claude-3-5-sonnet', 'anthropic', 'chat', 200000, TRUE, 0.003, 0.015),
    ('text-embedding-3-large', 'openai', 'embedding', 8191, FALSE, 0.00013, 0);
```

#### 2.2 model_call_logs - æ¨¡å‹è°ƒç”¨æ—¥å¿—è¡¨

```sql
CREATE TABLE model_call_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
    user_id UUID REFERENCES users(id) ON DELETE SET NULL,
    model_id UUID NOT NULL REFERENCES models(id) ON DELETE CASCADE,
    
    -- è°ƒç”¨ä¿¡æ¯
    prompt_tokens INT NOT NULL,
    completion_tokens INT NOT NULL,
    total_tokens INT NOT NULL,
    
    -- æˆæœ¬
    total_cost DECIMAL(10,6),
    
    -- æ€§èƒ½
    latency_ms INT,
    
    -- å…³è”
    workflow_execution_id UUID,
    task_id UUID,
    
    -- è¿½è¸ª
    trace_id VARCHAR(100),
    
    -- æ—¶é—´æˆ³
    created_at TIMESTAMP NOT NULL DEFAULT NOW()
);

-- ç´¢å¼•ï¼ˆæŒ‰ç§Ÿæˆ·å’Œæ—¶é—´æŸ¥è¯¢ï¼‰
CREATE INDEX idx_model_call_logs_tenant_id_created_at ON model_call_logs(tenant_id, created_at DESC);
CREATE INDEX idx_model_call_logs_user_id ON model_call_logs(user_id);
CREATE INDEX idx_model_call_logs_trace_id ON model_call_logs(trace_id);

-- åˆ†åŒºï¼ˆæŒ‰æœˆåˆ†åŒºï¼Œä¾¿äºå½’æ¡£ï¼‰
CREATE TABLE model_call_logs_2025_11 PARTITION OF model_call_logs
    FOR VALUES FROM ('2025-11-01') TO ('2025-12-01');
```

---

### 3. Prompt æ¨¡æ¿ç®¡ç†

#### 3.1 prompt_templates - æ¨¡æ¿è¡¨

```sql
CREATE TABLE prompt_templates (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
    owner_user_id UUID REFERENCES users(id) ON DELETE SET NULL,
    
    -- æ¨¡æ¿ä¿¡æ¯
    name VARCHAR(255) NOT NULL,
    description TEXT,
    category VARCHAR(100),  -- writing, reviewing, formatting
    
    -- å¯è§æ€§
    visibility VARCHAR(50) NOT NULL DEFAULT 'personal',  -- personal, tenant, public
    
    -- æœ€æ–°ç‰ˆæœ¬
    current_version_id UUID,
    
    -- ç»Ÿè®¡
    usage_count INT DEFAULT 0,
    
    -- æ—¶é—´æˆ³
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW(),
    deleted_at TIMESTAMP,
    
    -- çº¦æŸ
    CONSTRAINT check_visibility CHECK (visibility IN ('personal', 'tenant', 'public'))
);

-- ç´¢å¼•
CREATE INDEX idx_prompt_templates_tenant_id ON prompt_templates(tenant_id);
CREATE INDEX idx_prompt_templates_owner_user_id ON prompt_templates(owner_user_id);
CREATE INDEX idx_prompt_templates_visibility ON prompt_templates(visibility) WHERE deleted_at IS NULL;
CREATE INDEX idx_prompt_templates_category ON prompt_templates(category);
```

#### 3.2 prompt_template_versions - æ¨¡æ¿ç‰ˆæœ¬è¡¨

```sql
CREATE TABLE prompt_template_versions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    template_id UUID NOT NULL REFERENCES prompt_templates(id) ON DELETE CASCADE,
    
    -- ç‰ˆæœ¬ä¿¡æ¯
    version VARCHAR(50) NOT NULL,  -- v1.0, v1.1
    content TEXT NOT NULL,
    variables JSONB,  -- [{"name": "topic", "type": "string", "required": true}]
    
    -- å˜æ›´è¯´æ˜
    changelog TEXT,
    
    -- æ—¶é—´æˆ³
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    
    -- çº¦æŸ
    UNIQUE(template_id, version)
);

-- ç´¢å¼•
CREATE INDEX idx_prompt_template_versions_template_id ON prompt_template_versions(template_id, created_at DESC);
```

---

### 4. Agent ä¸å·¥ä½œæµ

#### 4.1 agent_configs - Agent é…ç½®è¡¨

```sql
CREATE TABLE agent_configs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
    
    -- Agent ä¿¡æ¯
    agent_type VARCHAR(100) NOT NULL,  -- writer, reviewer, planner
    name VARCHAR(255) NOT NULL,
    description TEXT,
    
    -- æ¨¡å‹é…ç½®
    model_id UUID NOT NULL REFERENCES models(id) ON DELETE RESTRICT,
    prompt_template_id UUID REFERENCES prompt_templates(id) ON DELETE SET NULL,
    
    -- å‚æ•°
    temperature DECIMAL(3,2) DEFAULT 0.7,
    max_tokens INT DEFAULT 4096,
    
    -- æ‰©å±•é…ç½®
    extra_config JSONB,
    
    -- æ—¶é—´æˆ³
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW()
);
```

#### 4.2 workflows - å·¥ä½œæµè¡¨

```sql
CREATE TABLE workflows (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
    owner_user_id UUID REFERENCES users(id) ON DELETE SET NULL,
    
    -- å·¥ä½œæµä¿¡æ¯
    name VARCHAR(255) NOT NULL,
    description TEXT,
    
    -- å®šä¹‰ï¼ˆYAML/JSONï¼‰
    definition JSONB NOT NULL,
    
    -- ç‰ˆæœ¬
    version VARCHAR(50) NOT NULL,
    
    -- å¯è§æ€§
    visibility VARCHAR(50) NOT NULL DEFAULT 'personal',
    
    -- ç»Ÿè®¡
    execution_count INT DEFAULT 0,
    success_count INT DEFAULT 0,
    failure_count INT DEFAULT 0,
    
    -- æ—¶é—´æˆ³
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW(),
    deleted_at TIMESTAMP
);

-- ç´¢å¼•
CREATE INDEX idx_workflows_tenant_id ON workflows(tenant_id) WHERE deleted_at IS NULL;
CREATE INDEX idx_workflows_owner_user_id ON workflows(owner_user_id);
```

#### 4.3 workflow_executions - å·¥ä½œæµæ‰§è¡Œè®°å½•è¡¨

```sql
CREATE TABLE workflow_executions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
    workflow_id UUID NOT NULL REFERENCES workflows(id) ON DELETE CASCADE,
    user_id UUID REFERENCES users(id) ON DELETE SET NULL,
    
    -- çŠ¶æ€
    status VARCHAR(50) NOT NULL DEFAULT 'pending',  -- pending, running, completed, failed, paused
    
    -- è¾“å…¥è¾“å‡º
    input JSONB,
    output JSONB,
    error_message TEXT,
    
    -- æ—¶é—´
    started_at TIMESTAMP,
    completed_at TIMESTAMP,
    
    -- è¿½è¸ª
    trace_id VARCHAR(100),
    
    -- æ—¶é—´æˆ³
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    
    -- çº¦æŸ
    CONSTRAINT check_status CHECK (status IN ('pending', 'running', 'completed', 'failed', 'paused'))
);

-- ç´¢å¼•
CREATE INDEX idx_workflow_executions_tenant_id ON workflow_executions(tenant_id, created_at DESC);
CREATE INDEX idx_workflow_executions_workflow_id ON workflow_executions(workflow_id);
CREATE INDEX idx_workflow_executions_status ON workflow_executions(status);
CREATE INDEX idx_workflow_executions_trace_id ON workflow_executions(trace_id);
```

#### 4.4 workflow_tasks - å·¥ä½œæµä»»åŠ¡è¡¨

```sql
CREATE TABLE workflow_tasks (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    execution_id UUID NOT NULL REFERENCES workflow_executions(id) ON DELETE CASCADE,
    
    -- ä»»åŠ¡ä¿¡æ¯
    step_id VARCHAR(100) NOT NULL,
    agent_type VARCHAR(100) NOT NULL,
    
    -- çŠ¶æ€
    status VARCHAR(50) NOT NULL DEFAULT 'pending',
    
    -- è¾“å…¥è¾“å‡º
    input JSONB,
    output JSONB,
    error_message TEXT,
    
    -- æ—¶é—´
    started_at TIMESTAMP,
    completed_at TIMESTAMP,
    
    -- é‡è¯•
    retry_count INT DEFAULT 0,
    
    -- æ—¶é—´æˆ³
    created_at TIMESTAMP NOT NULL DEFAULT NOW()
);

-- ç´¢å¼•
CREATE INDEX idx_workflow_tasks_execution_id ON workflow_tasks(execution_id);
```

---

### 5. RAG çŸ¥è¯†åº“

#### 5.1 knowledge_bases - çŸ¥è¯†åº“è¡¨

```sql
CREATE TABLE knowledge_bases (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
    
    -- çŸ¥è¯†åº“ä¿¡æ¯
    name VARCHAR(255) NOT NULL,
    description TEXT,
    
    -- å¯è§æ€§
    visibility_scope VARCHAR(50) NOT NULL DEFAULT 'tenant',
    
    -- å‘é‡é…ç½®
    default_embedding_model VARCHAR(100),
    
    -- ç»Ÿè®¡
    document_count INT DEFAULT 0,
    chunk_count INT DEFAULT 0,
    
    -- æ—¶é—´æˆ³
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW(),
    deleted_at TIMESTAMP
);

-- ç´¢å¼•
CREATE INDEX idx_knowledge_bases_tenant_id ON knowledge_bases(tenant_id) WHERE deleted_at IS NULL;
```

#### 5.2 knowledge_documents - çŸ¥è¯†æ–‡æ¡£è¡¨

```sql
CREATE TABLE knowledge_documents (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    knowledge_base_id UUID NOT NULL REFERENCES knowledge_bases(id) ON DELETE CASCADE,
    
    -- æ–‡æ¡£ä¿¡æ¯
    source_type VARCHAR(50) NOT NULL,  -- file, url, text
    source_uri TEXT,
    file_name VARCHAR(255),
    file_size BIGINT,
    
    -- ç‰ˆæœ¬
    version VARCHAR(50) DEFAULT 'v1.0',
    
    -- çŠ¶æ€
    status VARCHAR(50) NOT NULL DEFAULT 'pending',  -- pending, processing, completed, failed
    error_message TEXT,
    
    -- ç»Ÿè®¡
    chunk_count INT DEFAULT 0,
    
    -- æ—¶é—´æˆ³
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW(),
    
    -- çº¦æŸ
    CONSTRAINT check_source_type CHECK (source_type IN ('file', 'url', 'text')),
    CONSTRAINT check_status CHECK (status IN ('pending', 'processing', 'completed', 'failed'))
);

-- ç´¢å¼•
CREATE INDEX idx_knowledge_documents_knowledge_base_id ON knowledge_documents(knowledge_base_id);
CREATE INDEX idx_knowledge_documents_status ON knowledge_documents(status);
```

#### 5.3 knowledge_chunks - çŸ¥è¯†åˆ†ç‰‡è¡¨ï¼ˆå«å‘é‡ï¼‰

```sql
-- å¯ç”¨ pgvector æ‰©å±•
CREATE EXTENSION IF NOT EXISTS vector;

CREATE TABLE knowledge_chunks (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    document_id UUID NOT NULL REFERENCES knowledge_documents(id) ON DELETE CASCADE,
    
    -- åˆ†ç‰‡ä¿¡æ¯
    chunk_index INT NOT NULL,
    content TEXT NOT NULL,
    
    -- å‘é‡ï¼ˆ1536 ç»´ for text-embedding-3-largeï¼‰
    embedding vector(1536),
    
    -- å…ƒæ•°æ®
    metadata JSONB,
    
    -- æ—¶é—´æˆ³
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    
    -- çº¦æŸ
    UNIQUE(document_id, chunk_index)
);

-- ç´¢å¼•
CREATE INDEX idx_knowledge_chunks_document_id ON knowledge_chunks(document_id);

-- å‘é‡ç´¢å¼•ï¼ˆHNSWï¼Œç”¨äºé«˜æ•ˆç›¸ä¼¼åº¦æœç´¢ï¼‰
CREATE INDEX idx_knowledge_chunks_embedding ON knowledge_chunks 
    USING hnsw (embedding vector_cosine_ops);
```

#### 5.4 rag_query_logs - RAG æŸ¥è¯¢æ—¥å¿—è¡¨

```sql
CREATE TABLE rag_query_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
    user_id UUID REFERENCES users(id) ON DELETE SET NULL,
    
    -- æŸ¥è¯¢ä¿¡æ¯
    knowledge_base_ids UUID[] NOT NULL,
    query_text TEXT NOT NULL,
    top_k INT DEFAULT 10,
    score_threshold DECIMAL(3,2),
    
    -- ç»“æœ
    retrieved_count INT,
    average_score DECIMAL(3,2),
    
    -- æ€§èƒ½
    latency_ms INT,
    
    -- è¿½è¸ª
    trace_id VARCHAR(100),
    session_id VARCHAR(100),
    
    -- æ—¶é—´æˆ³
    created_at TIMESTAMP NOT NULL DEFAULT NOW()
);

-- ç´¢å¼•
CREATE INDEX idx_rag_query_logs_tenant_id ON rag_query_logs(tenant_id, created_at DESC);
CREATE INDEX idx_rag_query_logs_trace_id ON rag_query_logs(trace_id);
```

---

### 6. å®¡è®¡æ—¥å¿—

#### 6.1 audit_logs - å®¡è®¡æ—¥å¿—è¡¨

```sql
CREATE TABLE audit_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
    user_id UUID REFERENCES users(id) ON DELETE SET NULL,
    
    -- æ“ä½œä¿¡æ¯
    action VARCHAR(100) NOT NULL,  -- create, update, delete, execute
    resource_type VARCHAR(100) NOT NULL,  -- workflow, template, user
    resource_id UUID,
    
    -- è¯¦æƒ…
    details JSONB,
    
    -- è¯·æ±‚ä¿¡æ¯
    ip_address INET,
    user_agent TEXT,
    
    -- è¿½è¸ª
    trace_id VARCHAR(100),
    
    -- æ—¶é—´æˆ³
    created_at TIMESTAMP NOT NULL DEFAULT NOW()
);

-- ç´¢å¼•
CREATE INDEX idx_audit_logs_tenant_id ON audit_logs(tenant_id, created_at DESC);
CREATE INDEX idx_audit_logs_user_id ON audit_logs(user_id, created_at DESC);
CREATE INDEX idx_audit_logs_resource ON audit_logs(resource_type, resource_id);

-- åˆ†åŒºï¼ˆæŒ‰æœˆåˆ†åŒºï¼‰
CREATE TABLE audit_logs_2025_11 PARTITION OF audit_logs
    FOR VALUES FROM ('2025-11-01') TO ('2025-12-01');
```

---

## ğŸ“ˆ ç´¢å¼•ç­–ç•¥

### 1. ç§Ÿæˆ·çº§æŸ¥è¯¢ä¼˜åŒ–
æ‰€æœ‰åŒ…å« `tenant_id` çš„è¡¨ï¼Œä¼˜å…ˆåˆ›å»º `(tenant_id, created_at DESC)` è”åˆç´¢å¼•ã€‚

### 2. å¤–é”®ç´¢å¼•
æ‰€æœ‰å¤–é”®åˆ—è‡ªåŠ¨åˆ›å»ºç´¢å¼•ï¼Œç¡®ä¿å…³è”æŸ¥è¯¢æ€§èƒ½ã€‚

### 3. å‘é‡ç´¢å¼•
ä½¿ç”¨ HNSW ç®—æ³•åˆ›å»ºå‘é‡ç´¢å¼•ï¼Œæ”¯æŒé«˜æ•ˆç›¸ä¼¼åº¦æœç´¢ã€‚

### 4. éƒ¨åˆ†ç´¢å¼•
å¯¹è½¯åˆ é™¤è¡¨ï¼Œä½¿ç”¨ `WHERE deleted_at IS NULL` éƒ¨åˆ†ç´¢å¼•ã€‚

---

## ğŸ—‚ï¸ åˆ†åŒºç­–ç•¥

### 1. æŒ‰æ—¶é—´åˆ†åŒº
å¯¹æ—¥å¿—ç±»è¡¨ï¼ˆ`audit_logs`ã€`model_call_logs`ï¼‰æŒ‰æœˆåˆ†åŒºï¼š

```sql
-- è‡ªåŠ¨åˆ›å»ºåˆ†åŒºçš„å‡½æ•°
CREATE OR REPLACE FUNCTION create_monthly_partition()
RETURNS void AS $$
DECLARE
    start_date DATE;
    end_date DATE;
    partition_name TEXT;
BEGIN
    start_date := DATE_TRUNC('month', NOW());
    end_date := start_date + INTERVAL '1 month';
    partition_name := 'audit_logs_' || TO_CHAR(start_date, 'YYYY_MM');
    
    EXECUTE format(
        'CREATE TABLE IF NOT EXISTS %I PARTITION OF audit_logs FOR VALUES FROM (%L) TO (%L)',
        partition_name, start_date, end_date
    );
END;
$$ LANGUAGE plpgsql;

-- å®šæ—¶ä»»åŠ¡ï¼ˆæ¯æœˆ1å·æ‰§è¡Œï¼‰
SELECT cron.schedule('create-monthly-partitions', '0 0 1 * *', 'SELECT create_monthly_partition()');
```

---

## ğŸ”„ æ•°æ®è¿ç§»

### è¿ç§»å·¥å…·é€‰æ‹©
æ¨èä½¿ç”¨ **golang-migrate** æˆ– **goose**ã€‚

### è¿ç§»è„šæœ¬ç¤ºä¾‹

```bash
# åˆ›å»ºè¿ç§»
migrate create -ext sql -dir db/migrations -seq create_tenants_table

# æ‰§è¡Œè¿ç§»
migrate -path db/migrations -database "postgresql://user:pass@localhost/dbname?sslmode=disable" up

# å›æ»š
migrate -path db/migrations -database "postgresql://user:pass@localhost/dbname?sslmode=disable" down 1
```

---

## ğŸ“Š æ•°æ®é‡ä¼°ç®—

| è¡¨å | é¢„ä¼°è¡Œæ•°ï¼ˆå•ç§Ÿæˆ·ï¼Œ1å¹´ï¼‰ | åˆ†åŒºç­–ç•¥ |
|------|---------------------|---------|
| tenants | 1,000 | æ— éœ€åˆ†åŒº |
| users | 10,000 | æ— éœ€åˆ†åŒº |
| workflows | 5,000 | æ— éœ€åˆ†åŒº |
| workflow_executions | 500,000 | æŒ‰æœˆåˆ†åŒº |
| knowledge_chunks | 1,000,000 | æŒ‰æ–‡æ¡£åˆ†ç‰‡ |
| model_call_logs | 10,000,000 | æŒ‰æœˆåˆ†åŒº |
| audit_logs | 5,000,000 | æŒ‰æœˆåˆ†åŒº |

---

## ğŸ” å®‰å…¨å»ºè®®

1. **æ•æ„Ÿå­—æ®µåŠ å¯†**: `password_hash`ã€API Key ä½¿ç”¨ bcrypt/AES åŠ å¯†
2. **è¡Œçº§å®‰å…¨**: ä½¿ç”¨ PostgreSQL RLSï¼ˆRow Level Securityï¼‰
3. **å®¡è®¡æ—¥å¿—**: è®°å½•æ‰€æœ‰ DDL æ“ä½œ
4. **å¤‡ä»½ç­–ç•¥**: æ¯æ—¥å…¨é‡å¤‡ä»½ + WAL å¢é‡å¤‡ä»½

---

**æ•°æ®åº“è®¾è®¡éµå¾ªç¬¬ä¸‰èŒƒå¼ï¼ˆ3NFï¼‰ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§ä¸å¯ç»´æŠ¤æ€§ã€‚**
