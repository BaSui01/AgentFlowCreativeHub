# 后端更新日志

> 关联文档：[后端功能清单.md](后端功能清单.md)

---

## 2025-11-29 v1.5.4

- **遗漏功能扫描补充**
  - 发现并记录 3 项已实现但未文档化的功能
- **评论系统**（已实现）
  - 文件：`internal/content/comment_service.go`（139 行）
  - 功能：评论列表、发表评论、回复评论、删除评论、点赞
  - API：GET/POST/DELETE `/api/content/works/:id/comments`
- **缓存 API Handler**（已实现）
  - 文件：`api/handlers/cache/cache_handler.go`（129 行）
  - 功能：缓存统计、健康检查
  - API：GET `/api/v1/cache/stats`、`/api/v1/cache/health`
- **API Key Handler**（已实现）
  - 文件：`api/handlers/apikey/handler.go`（124 行）
  - 功能：API Key 创建、列表、删除、验证
  - API：GET/POST/DELETE `/api/apikeys`
- **工作空间模板**（已实现，文档更新）
  - 文件：`internal/workspace/template.go`（550 行）
  - 模型：WorkspaceTemplate、TemplateNode、TemplateStructure
  - 功能：模板 CRUD、模板应用、内置模板（小说/剧本/文章/项目）
  - API：GET/POST/PUT/DELETE `/api/workspace/templates`
- **整体完成度提升**：95% → 96%

## 2025-11-28 v1.5.3

- **工具市场**（完整实现）
  - 新增 `internal/tools/marketplace/models.go` - 数据模型
    - ToolPackage：工具包（名称、描述、分类、标签、状态、统计）
    - ToolVersion：版本管理（语义化版本、更新日志、工具定义）
    - ToolRating：评分评价（1-5 星、评价内容）
    - ToolInstall：安装记录（用户安装状态追踪）
  - 新增 `internal/tools/marketplace/service.go` - 业务逻辑
    - 发布管理：发布工具包、更新信息、删除（软删除）
    - 版本管理：发布新版本、获取版本列表、废弃版本
    - 搜索功能：关键词搜索、分类过滤、标签过滤、排序
    - 评分系统：用户评分、平均分计算
    - 安装管理：安装、卸载、已安装列表
    - 统计功能：市场总览、分类统计、热门工具
    - 管理功能：审核通过/拒绝、废弃、待审核列表
  - 新增 `internal/tools/marketplace/handler.go` - HTTP 处理器
  - 新增 API 路由（18 个端点）
    - `GET /api/marketplace/packages` - 工具列表
    - `GET /api/marketplace/packages/:id` - 工具详情
    - `POST /api/marketplace/search` - 搜索工具
    - `GET /api/marketplace/stats` - 市场统计
    - `POST /api/marketplace/publish` - 发布工具
    - `PUT /api/marketplace/packages/:id` - 更新工具
    - `DELETE /api/marketplace/packages/:id` - 删除工具
    - `POST /api/marketplace/packages/:id/versions` - 发布新版本
    - `GET /api/marketplace/packages/:id/versions` - 版本列表
    - `GET /api/marketplace/packages/:id/versions/:version` - 版本详情
    - `POST /api/marketplace/packages/:id/rate` - 评分
    - `GET /api/marketplace/packages/:id/ratings` - 评分列表
    - `POST /api/marketplace/packages/:id/install` - 安装
    - `POST /api/marketplace/packages/:id/uninstall` - 卸载
    - `GET /api/marketplace/installed` - 已安装列表
    - `GET /api/marketplace/admin/pending` - 待审核列表（管理员）
    - `POST /api/marketplace/admin/packages/:id/approve` - 审核通过（管理员）
    - `POST /api/marketplace/admin/packages/:id/reject` - 审核拒绝（管理员）
    - `POST /api/marketplace/admin/packages/:id/deprecate` - 废弃工具（管理员）

## 2025-11-28 v1.5.2

- **缓存预热机制**（完整实现）
  - 新增 `internal/cache/warmup.go` - 缓存预热服务
  - 功能：并发预热、优先级排序、重试机制、预热进度追踪
  - 配置：启用开关、并发数、超时、重试次数
- **LFU 智能淘汰**（完整实现）
  - 新增 `internal/cache/lfu_cache.go` - LFU 缓存淘汰策略
  - 功能：访问频率统计、LFU + LRU 混合策略、与 DiskCache 集成
  - 配置：容量上限、淘汰阈值
- **自定义 Embedding 模型**（完整实现）
  - 新增 `internal/ai/embedding/custom_embedding.go` - 自定义 Embedding 提供者
  - 功能：OpenAI 兼容格式、自定义请求/响应格式
  - 认证：无认证、API Key、Basic Auth、自定义头
  - 批量处理：支持批量 Embedding
- **短信通知服务**（完整实现）
  - 新增 `internal/notification/sms_service.go` - 短信服务
  - 提供商：阿里云短信、腾讯云短信
  - 功能：模板管理、异步队列、发送日志、批量发送
- **权限继承**（完整实现）
  - 扩展 `internal/auth/permission.go` - RoleHierarchy 角色层级
  - 功能：角色继承链、权限累积、继承链查询
  - 预置角色：guest -> user -> member -> editor -> manager -> admin -> owner
- **工具市场**（完整实现）
  - 新增 `internal/tools/marketplace/` 目录
  - models.go：ToolPackage、ToolVersion、ToolRating、ToolInstall
  - service.go：发布、搜索、版本管理、评分、安装/卸载
  - handler.go：15+ API 端点
- **知识库共享**（完整实现）
  - 新增 `internal/rag/kb_sharing.go` - 知识库共享服务
  - 共享类型：link（公开链接）、tenant（定向租户）、public（完全公开）
  - 权限级别：read（只读）、write（可写）、collaborate（协作）
  - 功能：Token 验证、访问限制、查询次数限制、访问日志
- **整体完成度提升**：93% → 95%

## 2025-11-28 v1.5.1

- **Agent 性能分析工具**（完整实现）
  - 新增 `internal/agent/performance.go` - Agent 性能分析服务
  - 新增 `api/handlers/agents/performance_handler.go` - 8 个 API 端点
  - 功能：执行时间统计、Token 消耗统计、P50/P95/P99 延迟、每日趋势、Agent 对比、Top Agent、最慢执行、失败记录
- **Agent A/B 测试框架**（完整实现）
  - 新增 `internal/agent/abtest.go` - A/B 测试服务
  - 功能：实验管理（创建/启动/暂停/完成）、变体分配（一致性哈希）、结果记录、显著性检验（Z-test）
  - 支持流量分配、对照组设置、中间件包装
- **缓存监控指标**（完整实现）
  - 新增 `internal/cache/prometheus.go` - Prometheus 指标集成
  - 新增 `internal/cache/monitor.go` - 缓存监控器（命中/未命中/淘汰/延迟）
  - 功能：Prometheus 格式导出、实时统计、MonitoredCache 包装器
- **业务指标收集器**
  - 新增 `internal/metrics/business_metrics.go` - Agent/工作流/RAG/用户/Token 指标
  - 功能：直方图、百分位数、Prometheus 格式导出
- **用户管理增强**（3 项功能）
  - 新增 `internal/user/profile.go` - 用户资料服务
  - 用户资料管理：头像、昵称、简介、社交链接、GDPR 数据导出
  - 用户偏好设置：主题、语言、编辑器、AI、通知、隐私偏好
  - 活跃度统计：登录次数、操作统计、连续天数、每日活动
- **细粒度权限控制**
  - 新增 `internal/auth/permission.go` - 资源级别权限服务
  - 功能：资源类型/ID 匹配、条件限制（IP/时间）、权限过期、deny 优先级
- **邮件通知服务**
  - 新增 `internal/notification/email_service.go` - 完整邮件服务
  - 功能：SMTP/TLS 发送、模板引擎、异步队列、发送日志、预置模板
- **合规报告生成**
  - 新增 `internal/audit/compliance_report.go` - 合规报告服务
  - 功能：安全检查、访问审计、数据隐私检查、安全事件、建议生成、Markdown/JSON 导出
- **知识库访问控制**
  - 新增 `internal/rag/access_control.go` - 细粒度权限服务
  - 功能：用户/角色/团队权限、read/write/manage/owner 级别、范围限制（文件夹/标签/文档类型）
- **文档版本管理**
  - 新增 `internal/rag/document_version.go` - 文档版本服务
  - 功能：版本创建、恢复、对比（行级 diff）、历史、自动清理旧版本
- **备忘录增强**
  - 新增 `internal/memo/service.go` - 完整备忘录服务
  - 功能：分类、标签、优先级、状态、置顶、归档、导出（Markdown/JSON/HTML）、导入
- **工具权限控制**
  - 新增 `internal/tools/permission.go` - 工具权限服务
  - 功能：白名单/黑名单、每日/每小时配额、参数限制、审批机制
- **告警服务**
  - 新增 `internal/notification/alert_service.go` - 告警规则引擎
  - 功能：规则管理、静默、多通知器、告警历史
- **整体完成度提升**：90% → 93%

## 2025-11-28 v1.5.0

- **RAG 检索增强**（5 项功能）
  - 新增 `rag/keyword_searcher.go` - PostgreSQL 全文搜索（BM25）
  - 新增 `rag/reranker.go` - 简单重排序器 + Cross-Encoder 接口
  - 新增 `rag/semantic_chunker.go` - 语义分块（段落/章节）
  - 新增 `rag/multi_kb_search.go` - 多知识库联合检索 + RRF 融合
  - 混合检索：向量 + 关键词，RRF 融合算法
- **文档解析增强**（2 项功能）
  - 新增 `rag/parsers/html_parser.go` - HTML 网页解析
  - 新增 `rag/parsers/docx_parser.go` - Word 文档解析（.docx/.doc）
- **模型性能监控**（1 项功能）
  - 新增 `ai/performance_monitor.go` - 延迟 P50/P95/P99、成功率、Token 统计
- **认证安全增强**（4 项功能）
  - 新增 `auth/jwt_key_rotation.go` - JWT 密钥自动轮换
  - 新增 `auth/redis_session.go` - Redis 会话存储（多设备管理、强制下线）
  - 新增 `auth/apikey.go` - 租户 API Key 管理
  - 新增 `middleware/rate_limiter.go` - 限流中间件
  - 新增 `middleware/request_id.go` - 请求 ID 中间件
- **任务队列增强**（2 项功能）
  - 新增 `queue/priority_queue.go` - 4 级优先级队列（critical/high/default/low）
  - 支持任务取消、任务状态查询
- **工作流增强**（5 项功能）
  - 新增 `workflow/io.go` - 工作流导入导出（JSON/YAML）
  - 新增 `workflow/webhook_trigger.go` - Webhook 触发器
  - 新增 `workflow/executor/loop_executor.go` - 循环节点（count/while/foreach）
  - 新增 `workflow/approval/rule_engine.go` - 审批规则引擎
  - 新增 `agent/version.go` - Agent 配置版本管理
- **整体完成度提升**：85% → 90%

## 2025-11-28 v1.4.6

- **世界观构建系统后端完成**（9 项功能）
  - 新增 `internal/worldbuilder/` 服务（models.go, service.go）
  - 新增 `api/handlers/worldbuilder/handler.go` API 处理器
  - 世界观设定 CRUD：WorldSetting 模型，支持多类型（玄幻/科幻/都市等）
  - 结构化实体管理：SettingEntity 模型，8 种实体类型
  - 关系网络：EntityRelation 模型，10 种关系类型
  - AI 生成：POST /generate（世界观）、/generate/character（角色）、/generate/relations（关系）
  - 增量修改：POST /modify，支持 AI 局部调整
  - 版本管理：SettingVersion 快照、版本对比、版本恢复
  - 内置模板：玄幻、都市、科幻三种内置模板
  - 复用组件：WorldBuilderAgent（AI 生成）
- **新增 API 路由**（22 个端点）
  - `GET/POST/PUT/DELETE /api/worldbuilder/settings` - 设定管理
  - `POST /api/worldbuilder/generate` - AI 生成世界观
  - `POST /api/worldbuilder/modify` - 增量修改
  - `POST /api/worldbuilder/generate/character` - AI 生成角色
  - `POST /api/worldbuilder/generate/relations` - AI 生成关系
  - `GET/POST/PUT/DELETE /api/worldbuilder/entities` - 实体管理
  - `GET/POST/DELETE /api/worldbuilder/relations` - 关系管理
  - `GET /api/worldbuilder/relations/graph` - 关系图
  - `GET/POST /api/worldbuilder/versions` - 版本管理
  - `GET /api/worldbuilder/templates` - 模板列表

## 2025-11-28 v1.4.5

- **内容审核系统后端完成**（8 项功能）
  - 新增 `internal/moderation/` 服务（models.go, service.go）
  - 新增 `api/handlers/moderation/handler.go` API 处理器
  - 人工审核：通过/拒绝/修改/升级多种操作
  - AI 辅助审核：ReviewerAgent 自动评估风险等级
  - 审核队列：按优先级排序，支持任务分配
  - 多级审核：初审/复审多级流程支持
  - 敏感词管理：批量导入、自动过滤、替换/屏蔽
  - 违规处理：警告/下架/暂停/封禁
  - 复用组件：ReviewerAgent（AI审核）
- **新增 API 路由**（15 个端点）
  - `POST /api/moderation/submit` - 提交审核
  - `GET /api/moderation/tasks` - 任务列表
  - `GET /api/moderation/queue` - 待审核队列
  - `POST /api/moderation/review` - 审核操作
  - `GET/POST/DELETE /api/moderation/words` - 敏感词管理
  - `POST /api/moderation/filter` - 内容过滤
  - `GET/POST/PUT/DELETE /api/moderation/rules` - 审核规则
  - `GET /api/moderation/stats` - 审核统计

## 2025-11-28 v1.4.4

- **模型定价与计费系统后端完成**（8 项功能）
  - 新增 `internal/billing/` 服务（models.go, service.go）
  - 新增 `api/handlers/billing/handler.go` API 处理器
  - 模型定价管理：CRUD 操作，按 provider + model 维护
  - 成本预估：调用前预估积分消耗
  - 成本报表：按模型/提供商/用户/日期维度生成报表
  - 成本告警：日/周/月/阈值告警，支持邮件/webhook 通知
  - 计费审计：多维过滤查询，摘要统计
  - Token 计价器：支持文本自动估算 token 数
  - 复用组件：credits.CreditPricing、metrics.ModelCallLog
- **新增 API 路由**（18 个端点）
  - `GET/POST/PUT/DELETE /api/billing/pricings` - 定价管理
  - `POST /api/billing/estimate` - 成本预估
  - `POST /api/billing/reports` - 成本报表
  - `GET /api/billing/trend` - 成本趋势
  - `GET/POST/PUT/DELETE /api/billing/alerts` - 告警管理
  - `POST /api/billing/alerts/check` - 检查告警
  - `POST /api/billing/audit` - 计费审计
  - `POST /api/billing/calculator` - Token 计价器
  - `GET/POST/PUT/DELETE /api/billing/strategies` - 定价策略

## 2025-11-28 v1.4.3

- **知识库拆书系统后端完成**（12 项功能）
  - 新增 `internal/bookparser/` 服务（models.go, service.go）
  - 新增 `api/handlers/bookparser/handler.go` API 处理器
  - 6 种分析维度：文风叙事、情节设计、人物塑造、读者情绪、热梗搞笑、章节大纲
  - 任务管理：创建、列表、进度、结果、取消
  - 知识库搜索：按维度、分类、标签搜索提取的知识
  - 复用组件：Analyzer Agent、RAG 服务、异步任务
- **新增 API 路由**（8 个端点）
  - `GET /api/bookparser/dimensions` - 获取分析维度
  - `POST /api/bookparser/tasks` - 创建拆书任务
  - `GET /api/bookparser/tasks` - 任务列表
  - `GET /api/bookparser/tasks/:id` - 任务详情
  - `GET /api/bookparser/tasks/:id/progress` - 任务进度
  - `GET /api/bookparser/tasks/:id/results` - 分析结果
  - `POST /api/bookparser/tasks/:id/cancel` - 取消任务
  - `POST /api/bookparser/knowledge/search` - 知识搜索

## 2025-11-28 v1.4.2

- **层级化内容管理后端支持完成**（9 项功能）
  - 新增 `internal/workspace/content_management.go`
  - 四级内容结构常量（work/volume/chapter/scene）
  - 大纲总览 API：`GetOutlineView()` - 词数统计、结构统计
  - 批量排序 API：`BatchUpdateSortOrder()` - 章节拖拽排序
  - 批量移动 API：`BatchMoveNodes()` - 批量移动到新目录
  - 批量删除 API：`BatchDeleteNodes()` - 批量软删除
  - 批量复制 API：`BatchCopyNodes()` - 递归复制内容
  - 自动保存 API：`AutoSaveContent()` - 防抖保存
  - TXT 导入 API：`ImportFromText()` - 智能解析章节结构
- **新增 API 路由**（7 个端点）
  - `GET /api/workspace/outline/:workId`
  - `POST /api/workspace/batch/sort`
  - `POST /api/workspace/batch/move`
  - `POST /api/workspace/batch/delete`
  - `POST /api/workspace/batch/copy`
  - `POST /api/workspace/autosave`
  - `POST /api/workspace/import/text`

## 2025-11-28 v1.4.1

- **写作分析与统计模块完成**（8 项功能）
  - 新增 `internal/analytics/` 服务（models.go, service.go）
  - 新增 `api/handlers/analytics/dashboard_handler.go` API 处理器
  - 8 个分析 API 端点：仪表盘、月度报告、Token 趋势、功能分布、模型偏好、写作效率、写作习惯、近期活动

## 2025-11-28 v1.4.0

- **文档重组**：20 个模块合并为 12 个
  - 智能 Agent 与工作流（原 2+3）
  - AI 模型与缓存（原 4+17.4）
  - 知识库与搜索（原 5+9）
  - 用户权限与认证（原 6+7）
  - 文件与工作空间（原 10+13）
  - 消息与任务（原 11+15）
  - API 与集成（原 14+16）
  - 业务扩展平台（原 18+19+20）

## 2025-11-28 v1.3.4

- 内容创作增强功能 - Agent 集成（11 项）
- 新增 PlotAgent、WorldBuilderAgent

## 2025-11-28 v1.3.3

- 文件管理模块完成（分片上传、文件预览、文件搜索）

## 2025-11-28 v1.3.2

- 代码搜索 HTTP API 完成（8 个端点）

## 2025-11-28 v1.3.0

- 硬盘缓存系统完成实现（L3 层）
- HTTP 客户端工具库完成实现
