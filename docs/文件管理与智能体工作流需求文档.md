# 文件管理与智能体工作流需求文档

## 1. 概述
AgentFlowCreativeHub 将构建「类 VSCode 文件资源管理器 + 智能体命令/上下文 + 审核与自动归档」体系，使内容生成、审核、归档全流程在统一接口内完成，并对接智能体工具。

### 核心目标
1. 前端提供 VSCode 风格的文件浏览与编辑体验，支持 CRUD、搜索、预览、差异对比与命令操作。
2. 引入命令面板（/、@）和智能体工具，支持上下文注入、自然语言操作与暂存区审核。
3. 建立目录/命名策略 + 审核流程，审核通过后自动命名并归档，未通过则留在暂存区。
4. 后端提供统一的文件服务、审核服务、命名策略器、上下文构建器与审计/权限控制能力。

---

## 2. 功能范围
- **前端**：资源管理器、预览/搜索、命令面板、暂存区与审核 UI、上下文选择器。
- **后端**：文件 API、索引与搜索、审核/暂存 API、命名策略器、上下文构建服务、审计与权限。
- **不包含**：第三方网盘同步、协同编辑、复杂流程编排。

---

## 3. 用户角色与场景
| 角色 | 典型场景 |
|------|----------|
| 作者/创作者 | 通过命令触发智能体生成内容，结果进入暂存区等待审核。 |
| 审核者 | 在暂存区查看差异、批注，批准或驳回，并触发自动归档。 |
| 管理员 | 配置目录策略、命名模板、权限与审核流程，查看审计日志。 |
| 智能体 | 根据命令执行生成/修改操作，遵守目录权限，只能写入授权目录。 |

---

## 4. 信息架构与目录规范
```
/
├─ outline/            # 正式大纲
├─ drafts/{topic}/     # 草稿
├─ final/{topic}/      # 最终稿
├─ assets/{topic}/     # 图片/表格
├─ templates/          # 模板
└─ staging/            # 暂存区（outline/draft/assets 等）
```

- **自动命名策略**：
  - 暂存：`staging/{type}/{user}-{timestamp}.md`
  - 正式：`outline/{yyyy-mm-dd}-{slug}.md`、`drafts/{topic}/{slug}-v{n}.md`
- slug=主题+关键词，冲突追加 `-1/-2`；目录映射可 per-tenant 配置。

---

## 5. 智能体权限矩阵
| Agent | 职责 | 读权限 | 写权限 | 审核要求 |
|-------|------|--------|--------|----------|
| Planner/Outline | 大纲生成 | /outline, /drafts, /staging | /staging/outline | 必须审核 |
| Writer/Drafter | 草稿撰写 | /outline, /drafts, /staging | /staging/draft | 必须审核 |
| Reviewer | 质检审核 | 全部（RBAC 控制） | 可改暂存/正式（若授权） | 可批准/驳回 |
| Formatter | 排版终稿 | /final, /drafts | /staging/final 或 /final | 默认审核 |
| Asset Agent | 生成配图 | /assets | /staging/assets | 审核后归档 |

- 后端保存 `AgentConfig.AllowedDirs` 拦截越权写操作。
- 所有 API 按租户隔离，文件带有 `visibility`（personal/tenant/public）。

---

## 6. 前端功能规格
### 6.1 文件资源管理器
- 树形视图（懒加载）、拖拽移动、右键菜单（新建/重命名/移动/删除/复制路径/新窗口打开）。
- 面包屑与快捷键；空态提示与错误状态。
- 预览：Markdown/纯文本/JSON/图片；支持差异对比（暂存 vs 正式）。
- 搜索：按文件名/内容，支持正则、目录范围与高亮跳转。

### 6.2 命令面板与命令输入
- Ctrl/Cmd+K 打开命令面板；编辑器内支持 `/命令` 与 `@智能体`。
- 常用命令：`/生成大纲`、`/续写`、`/润色`、`/总结`、`@writer` 等。
- 支持参数提示、历史记录、收藏。
- 面板在输入阶段实时校验：命令与 @ 智能体组合是否合法、是否缺少上下文或权限不足；违规组合直接展示错误提示与补救操作。
- 命令执行状态以时间线形式展示（排队/执行中/成功/失败），失败条目必须附带 `traceId` 与快速重试入口。
- 当目标 Agent 离线或超出配额时，面板提供「切换 Agent」「改为草稿模式」的降级选项，避免用户阻塞。

### 6.3 智能体上下文注入
- 可选择注入当前文件全文、选中片段、同目录关联文件、最近 N 条摘要。
- 显示注入项数量与 Token 估算，超限时自动摘要。
- 资源与降级规则：
  - 单次调用默认最大 16k tokens，可在命令参数中覆写；若估算超限，按「选区 > 关联文件 > 历史摘要」顺序回退。
  - 上下文构建执行最长 8s，超过阈值自动降级为摘要模式，并在 UI 中提示“采用摘要”。
  - 支持 `context.preview` JSON，记录实际注入条目、token 消耗与省略原因，供审计 API 查询。
- 异常处理：
  - 构建失败（网络/权限）时向命令面板返回 `context_error`，并提供「重试」「改用手动粘贴」操作。
  - 对加密/受限文件，UI 仅显示摘要引用与「申请权限」入口，不直接暴露正文。
  - 每次手动调整上下文后生成 `ContextRevisionId`，用于溯源与回滚。

### 6.4 暂存区与审核 UI
- 暂存列表：显示类型、标题、提交人、状态、建议目录。
- 列表支持分页、状态/指派人/命令来源筛选，并展示 SLA 倒计时（如高敏复核剩余时间）。
- 预览并排 diff、批注、评论。
- 操作：通过（可编辑最终路径）、驳回（必填原因）、重新提交。
- 审核通知：消息/邮件/系统内提醒。
- 异常态：当 diff 加载失败或版本过期时，UI 提供「刷新版本」和「复制 traceId」用于排障。

### 6.5 可读性
- 列表显示「标题 · 类型 · 日期」，Hover/详情显示完整路径与时间戳。
- 支持“开发者模式”显示原始命名；可切换排序/分组方式。

---

## 7. 后端服务与接口
### 7.1 文件服务
- `GET /api/files/tree`、`GET /api/files/content`
- `POST /api/files`（创建/保存，需携带 `If-Match: version`，乐观锁失败返回 `AFCH-FILE-409`）、`PATCH /api/files`（重命名/移动）、`DELETE /api/files`
- `POST /api/files/search`、`GET /api/files/diff`
- 历史/版本：`GET /api/files/history`、`POST /api/files/revert`
- 树接口默认懒加载 2 层，可传 `depth`/`cursor` 分页；`search` 需要 `limit/offset` 并返回 `totalHits` 以支持前端分页。
- `GET /api/files/diff` 返回 `{baseVersion,targetVersion, hunks[]}`，供 UI diff 复用；若 `targetVersion` 不存在则返回 `AFCH-DIFF-404`。

### 7.2 暂存与审核
- `POST /api/staging/items`（提交暂存）
- `GET /api/staging/items`（按状态/指派筛选）
- `POST /api/staging/{id}/review`（approve/reject）
- 审核通过：命名策略器 → 写入正式目录 → 更新索引 → 记录审计 → 删除暂存。

### 7.3 命令执行/智能体工具
- `POST /api/commands/execute`
  - 输入：commandType、agentType、contextSpec、outputType、namingHints、reviewPolicy。
  - 输出：stagingItemId 或直接路径、预览、token 统计。
- 调用 AgentRuntime：构建上下文 → 执行 → 写入暂存区。
- 执行服务内置队列（基于 Redis Stream），每个 Agent 设定最大并发与速率限制，超过部分进入排队并向前端返回排队位置。
- 相同 `sessionId + commandType + contentHash` 在 60 秒内重复提交将触发去重，直接返回上一次结果，避免误触发大量任务。
- 允许在请求中附带 `deadlineMs`，若 Agent 未在时限内返回则中断并标记为 `agent_timeout`，同时记录可重试的上下文快照。

### 7.4 自动命名与路径策略器
- 输入：type、tenantId、topic/keywords、date、existingPaths、collisionPolicy。
- 输出：finalPath（目录 + 文件名），以及冲突处理策略。

### 7.5 上下文构建
- 汇聚指定文件内容、生成摘要、控制 token 上限。
- 与现有 Agent Context Manager 集成。

### 7.6 审计与日志
- 记录所有写操作、审核动作：actor、agentId、命令、源/目标路径、traceId、tokens。
- 提供查询 API/界面，满足合规与追溯需求。

### 7.7 数据模型（草案）
| 实体 | 关键字段 | 说明 |
|------|----------|------|
| `FileItem` | `id`、`path`、`type`、`tenantId`、`visibility`、`version`、`hash`、`createdBy`、`updatedBy`、`lastReviewedAt` | 代表正式/草稿文件，`version` 采用自增号，写入前需校验最新版本。 |
| `StagingItem` | `id`、`sourceAgent`、`submissionType`、`suggestedPath`、`payloadHash`、`status`、`version`、`reviewToken`、`reviewerId`、`secondaryReviewerId`、`expiresAt`、`metadata` | 暂存区记录，`version` 支持乐观锁，`reviewToken` 用于幂等审核请求，`secondaryReviewerId` 配合双复核场景。`metadata` 包含命令参数、上下文快照、token 使用量。 |
| `ReviewRecord` | `id`、`stagingItemId`、`action`（approve/reject/request_changes） 、`comment`、`actorId`、`createdAt`、`diffRef` | 每次审核动作单独记录，可追溯完整对话。 |
| `CommandRequest` | `id`、`commandType`、`agentType`、`contextSpec`、`timeoutMs`、`status`、`resultRef`、`errorCode` | 命令执行日志，用于前端查询历史与排错。 |
| `AuditEvent` | `auditId`、`actorType`、`scope`、`resourcePath`、`action`、`beforeVersion`、`afterVersion`、`traceId`、`latencyMs`、`securityTags`、`recordedAt` | 全量审计流水，供安全与合规查询，并支撑 180 天保留要求。 |

> API 入参/出参需引用上述字段，所有时间字段使用 ISO8601，体积大的 `payload` 走对象存储并以 `payloadHash` 引用。

### 7.8 暂存与审核状态机
```
Drafted → AwaitingReview →
  ├─(单人审核通过)→ ApprovedPendingArchive → Archived
  ├─(高敏 topic)→ AwaitingSecondaryReview → ApprovedPendingArchive
  ├─(request_changes)→ ChangesRequested → Resubmitted → AwaitingReview
  └─(reject)→ Rejected

Drafted/ChangesRequested → Abandoned（作者主动放弃）
任意状态 → Failed（系统异常/归档失败）
```
- `Drafted`：由 Agent 或用户提交后生成，尚未指派。
- `AwaitingReview`：已指派审核者或进入公共队列，锁定 payload，禁止再次编辑。
- `AwaitingSecondaryReview`：高敏目录必须由第二位审核者确认，首位通过后进入该状态，拒绝或超时则退回 `ChangesRequested`。
- `ApprovedPendingArchive`：审核链路完成，触发命名策略器→写正式目录→更新索引→删除暂存。若写入失败则进入 `Failed` 并记录补偿任务。
- `ChangesRequested`：必须附带原因，作者可「接受并编辑」或「放弃」。
- `Resubmitted`：作者修改后重新提交，保留原链路并递增 `resubmitCount`。
- `Rejected`：审核者认为不具备继续价值，需管理员重开或作者另存新稿。
- `Abandoned`：作者或管理员主动终止暂存条目，保留审计记录不再流转。
- 并发控制：审核时比对 `StagingItem.version`，若作者在审核中修改，系统提示“版本过期”并需重新加载 diff。
- 错误码：
  - `STG_CONFLICT`：版本冲突
  - `STG_PATH_COLLISION`：命名策略无法生成唯一路径
  - `STG_ARCHIVE_ROLLBACK`：归档写入失败，已自动回滚
  - `STG_PERMISSION_DENIED`：越权访问
  - `STG_SECONDARY_TIMEOUT`：第二审核人超时未处理
  - `STG_REVIEW_TOKEN_INVALID`：幂等 token 已被消费或过期

### 7.9 API 错误与补偿策略
- 毫秒级错误码统一为 `AFCH-` 前缀，格式：`AFCH-<域>-<编号>`，例如 `AFCH-FILE-001`（路径不存在）。
- `POST /api/staging/{id}/review` 需要具备幂等键 `reviewToken`，它由暂存项 `version + reviewerId` 生成且一次性使用，前端重复提交不会导致多次审批。
- 高敏目录自动生成 `secondaryReviewToken`，供第二位审核者调用；若超过 SLA（默认 24h）自动转回 `AwaitingReview` 并发送告警。
- 自动归档链路失败时：
  1. 标记 `StagingItem.status=Failed` 并记录 `failureReason`；
  2. 投递补偿任务（重命名、重试写入、回滚索引）；
  3. 向原审核者与管理员发出告警，并允许手动触发 `POST /api/staging/{id}/retry-archive`。
- 所有写接口响应中包含 `traceId`，前端 diff 页面引用该 ID 以定位日志。

### 7.10 暂存生命周期与清理
- 默认暂存 TTL 72 小时，可由租户策略覆盖；超时自动进入 `Abandoned` 并通知提交人。
- 后台 `staging-cleaner` 任务每 30 分钟扫描过期项：
  1. 标记状态并写入审计事件 `staging.auto_abandon`；
  2. 删除关联的临时文件/对象存储；
  3. 若条目仍在审核中则发送提醒并延长 6 小时一次性宽限。
- `metadata.retentionPolicy` 用于描述需长期保留的暂存条目（例如培训示例），清理流程会跳过并由管理员手动归档。

### 7.11 命令执行可观测性
- `CommandRequest` 需记录 `latencyMs`、`tokenCost`、`agentResponseSize`，并暴露 `GET /api/commands/{id}` 供前端查询历史任务。
- 提供 `metrics/commands` 端点聚合「成功率、平均耗时、上下文超限次数」，用于看板与报警。
- 失败分类：`context_error`、`agent_timeout`、`archive_failed`、`permission_denied`，前端据此展示针对性的操作建议。

---

## 8. 性能与系统考虑
- 文件索引入库 + 缓存热点目录；搜索支持分页。
- 大文件预览使用 Range/分页；差异与搜索采用流式处理。
- 批量操作通过后台任务队列，前端展示执行状态。
- 并发控制：乐观锁/版本号；审核时检测最新版本，冲突提示。
- 失败恢复：落盘、索引与审计操作事务化或使用补偿逻辑。

### 8.1 监控与告警
- 指标采集：
  - 文件服务：`files.tree.ttl`、`files.diff.latency`、`files.write.error_rate`；
  - 暂存/审核：`staging.queue.length`、`staging.sla.remaining_hours`、`review.approval.latency`；
  - 命令执行：`commands.success_rate`、`commands.token_cost`、`commands.agent_timeout_ratio`。
- 告警阈值：
  - 暂存队列长度 > 200 或 SLA 剩余 < 4h 时触发黄色告警；
  - Agent 超时率连续 5 分钟 > 5% 时触发红色告警，自动降级为手动提交模式；
  - 文件写入错误率 > 1% 时暂停自动归档并要求人工介入。
- 可观测性集成：所有服务暴露 `/metrics`（Prometheus）与结构化日志，日志包含 `traceId`、`spanId` 以便分布式追踪；Grafana Dashboard 提供实时视图与历史对比。

---

## 9. 权限与安全
- RBAC + 目录映射：角色 → 权限 → 目录，命令与工具同样受限。
- Agent 写权限白名单，禁止越权路径（如 `..`）。
- 内容安全：提交暂存或审核通过时可调用敏感词/PII 扫描。
- 多租户隔离：所有接口携带 tenantId，文件存储标记 visibility。
- 权限配置来源：租户级 `policy.yaml` + 数据库存储的临时授权（例如某篇稿件邀请外部合作），加载后缓存在 Redis，变更需在 60s 内生效。
- 审核授权模型：
  - `Reviewer` 需要 `scope=topic` 或 `scope=tenant`，前者仅能审核指定主题目录。
  - 支持双人复核：若 `topic` 被标记为高敏，系统强制两名审核者依次通过，状态机自动追加 `AwaitingSecondaryReview`。
- 权限校验顺序：命令执行→上下文构建→文件写入，任何一步失败都记录 `AccessDenied` 审计事件并返回友好提示。
- 审计 Schema：`auditId`、`actorType`（user/agent/system）、`action`、`resourcePath`、`beforeVersion`、`afterVersion`、`traceId`、`latencyMs`、`securityTags`，保留 180 天，可导出。 

---

## 10. 验收标准
1. 前端资源管理器具备 CRUD、拖拽、预览、搜索、diff 能力。
2. 命令面板与 /、@ 命令可执行智能体操作，支持上下文注入与暂存。
3. 暂存→审核→自动归档闭环可用，命名/目录符合策略，冲突自动处理。
4. Agent 权限与多租户隔离生效，越权写入被拦截；审计日志完整。
5. IO 可靠：大文件分片预览、批量移动走后台任务、错误可恢复。
6. 性能指标：
   - 文件树加载 TTI ≤ 1.5s（缓存命中），全文检索首包 ≤ 2.5s；
   - 命令执行结果 95th 延迟 ≤ 12s（含 Agent 调用），上下文构建失败率 < 1%。
7. 安全合规：
   - RBAC 政策变更在 60s 内生效；
   - 审计日志具备可查询界面，并可按 `traceId` 关联到单次命令与审核动作；
   - 敏感词扫描命中率与误报率需记录并可导出，供安全团队复核。

---

## 11. 里程碑建议
- **M1（~1.5 周）**：文件服务 + 前端树/预览/搜索基础 + 命名策略基础。
- **M2（~2 周）**：命令面板 + 智能体上下文 + 暂存区 + 审核 API + 自动命名。
- **M3（~1 周）**：审核 UI、diff、权限/审计完善。
- **M4（迭代）**：性能优化、批量操作、配置界面、更多命令与工具。

---

此文档可作为设计、实现与测试的统一依据。如需细化接口、原型或任务拆解，可在此基础上继续扩展。
