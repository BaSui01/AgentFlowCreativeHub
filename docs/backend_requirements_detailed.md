| S-08 | **自定义角色权限** | 代码中有 `rbac.go` 接口，但逻辑较硬编码。 | 设计 `Permissions` 和 `Roles` 数据表，支持用户在 UI 上创建自定义角色并勾选具体权限点（如 `workflow:create`, `kb:delete`）。 | P1 |

### 🔄 二、工作流引擎 (Workflow Engine)

| ID | 需求名称 | 现状分析 | 详细需求描述 | 优先级 |
| :--- | :--- | :--- | :--- | :--- |
| W-01 | **工作流版本控制** | 仅有 `Version` 字符串字段。 | 实现完整版本管理，每次发布生成快照（Snapshot）。支持查看历史版本、回滚（Rollback）到旧版本，以及多版本灰度运行。 | P0 |
| W-02 | **条件分支逻辑** | 仅支持线性或基于 `depends_on` 的依赖。 | 在 DSL 中支持 `if/else` 或 `switch` 结构，根据前一步 Agent 的输出结果（如“评分>60”）动态决定下一步走向。 | P0 |
| W-03 | **循环执行支持** | 不支持。 | 支持 `ForEach`（遍历列表处理）和 `While`（条件循环）模式，用于批量生成内容或多轮优化直至达标。 | P1 |
| W-04 | **试运行模式 (Dry Run)** | 无。 | 提供 Dry Run 接口，解析工作流结构并模拟执行路径，验证参数传递和依赖关系，但不消耗真实 Token 或产生副作用。 | P2 |
| W-05 | **步骤级超时与重试** | 无。 | 在 DSL 中支持为每个 Step 配置 `timeout`（如 30s）和 `retry_policy`（重试次数、退避策略 backoff），增强稳定性。 | P1 |
| W-06 | **人机交互节点** | 全自动。 | 引入 `Approval` 或 `Input` 类型的节点。工作流运行到此节点时挂起（Suspend），等待人工审核或补全信息后继续（Resume）。 | P0 |
| W-07 | **子工作流** | 单一扁平结构。 | 允许一个工作流调用另一个已发布的工作流作为子步骤，实现逻辑复用和模块化编排。 | P2 |
| W-08 | **工作流模板库** | 代码中有 `ExampleWorkflowDefinition`。 | 区分“系统模板”和“用户自定义模板”，支持模板的实例化、分类管理和从现有工作流“另存为模板”。 | P1 |

### 📚 三、RAG 知识库 (RAG & Knowledge Base)

| ID | 需求名称 | 现状分析 | 详细需求描述 | 优先级 |
| :--- | :--- | :--- | :--- | :--- |
| R-01 | **多格式文档解析** | 仅支持文本文件。 | 集成 `unidoc` 或类似库，支持 PDF、DOCX、PPTX、HTML、Markdown 等常见格式的解析与元数据提取。 | P0 |
| R-02 | **混合检索 (Hybrid)** | 仅向量检索。 | 引入关键词检索（BM25/Elasticsearch），实现 向量检索 + 关键词检索 的加权融合（RRF），提升专有名词匹配准确度。 | P1 |
| R-03 | **重排序 (Reranking)** | 无。 | 在检索召回 Top-K 后，引入 Cross-Encoder 模型（如 BGE-Reranker）对结果进行精细重排序，大幅提升上下文相关性。 | P1 |
| R-04 | **高级分块策略** | 基础分块。 | 实现“语义分块”（基于段落/标题）、“滑动窗口分块”以及“父子索引”（检索小块，返回大块上下文）策略。 | P2 |
| R-05 | **元数据过滤** | 搜索接口无过滤参数。 | Search API 支持传入 `filter` 条件（如 `year > 2023`, `author == "admin"`），利用向量库的标量过滤能力。 | P1 |
| R-06 | **文档版本与增量更新** | 上传即创建新记录。 | 支持同名文档覆盖更新或版本共存，支持仅更新文档变更部分的向量索引（增量索引）。 | P2 |
| R-07 | **多模态支持** | 仅文本。 | 解析文档中的图片，利用多模态模型（如 CLIP）生成图片向量，支持“以文搜图”或图文混合 RAG。 | P3 |
| R-08 | **引用溯源** | 返回 Chunk 内容。 | RAG 响应中精确标注引用的 Chunk 来源（文件名、页码、段落位置），便于前端高亮展示原文。 | P1 |

### 🤖 四、Agent 与 AI 能力

| ID | 需求名称 | 现状分析 | 详细需求描述 | 优先级 |
| :--- | :--- | :--- | :--- | :--- |
| A-01 | **模型降级与熔断** | 硬编码或配置单一模型。 | 配置模型优先级链（如 GPT-4 -> Claude-3 -> GPT-3.5），当主模型超时或报错时自动切换备用模型。 | P1 |
| A-02 | **长短期记忆管理** | 主要依赖上下文拼接。 | 引入 Summary Memory（对话摘要）、Vector Memory（长期记忆检索）和 Entity Memory（实体提取），解决长对话 Context Window 限制。 | P2 |
| A-03 | **工具调用安全策略** | Agent 只有基础定义。 | 为 Agent 的 Tool Call 增加权限控制（如只读/读写）、人工确认机制（Sensitive Tools require confirmation）和参数清洗。 | P1 |
---

## 📅 实施计划 (Implementation Plan)

### 第一阶段：核心基石 (Core Foundation) - 预计 2 周
**目标**：确保系统安全、稳定，核心流程跑通，支持流式输出。

1.  **安全加固**：
    *   [S-01] 实现 Token 黑名单与撤销机制。
    *   [S-08] 完善 RBAC，实现基于角色的权限控制。
2.  **工作流增强**：
    *   [W-06] 实现人机交互节点（Approval），打通“半自动”工作流。
    *   [W-02] 支持基础的条件分支（If/Else）。
3.  **AI 体验优化**：
    *   [A-04] 全链路改造为 SSE 流式响应。
4.  **RAG 基础**：
    *   [R-01] 集成多格式文档解析（PDF/Word）。
    *   [R-08] 增加引用溯源信息。

### 第二阶段：能力进阶 (Advanced Capabilities) - 预计 3 周
**目标**：提升 RAG 准确率，增强工作流灵活性，完善运维监控。

1.  **RAG 优化**：
    *   [R-02] 引入混合检索（Keyword + Vector）。
    *   [R-03] 增加重排序（Rerank）步骤。
    *   [R-05] 支持元数据过滤搜索。
2.  **工作流高级特性**：
    *   [W-01] 实现工作流版本控制与快照。
    *   [W-05] 添加步骤级超时与重试机制。
3.  **运维与安全**：
    *   [S-03] 实现 API Key 管理。
    *   [O-02] 完善审计日志记录。
    *   [O-03] 实现动态限流策略。

### 第三阶段：企业级特性 (Enterprise Features) - 预计 3 周
**目标**：支持大规模并发，复杂编排，以及精细化运营。

1.  **复杂编排**：
    *   [W-03] 支持循环（Loop）与子工作流（Sub-workflow）。
    *   [W-04] 实现试运行（Dry Run）模式。
2.  **高级 AI 能力**：
    *   [A-01] 模型降级与熔断。
    *   [A-02] 长短期记忆管理。
    *   [A-05] 成本计算与配额管理。
3.  **系统增强**：
    *   [O-01] 集成 OpenTelemetry 链路追踪。
    *   [O-04] 实现 Webhook 通知系统。
    *   [S-02] 集成 MFA 多因素认证。
