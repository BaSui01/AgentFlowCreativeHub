# AgentFlowCreativeHub 算法与数据结构文档

> 本文档记录项目后端使用的核心算法和数据结构

---

## 一、缓存与存储算法

### 1.1 LFU 缓存淘汰算法
- **文件**: `internal/cache/lfu_cache.go`
- **原理**: 基于访问频率的缓存淘汰策略
- **实现细节**:
  - 使用 `频率 → 双向链表` 映射，相同频率的条目放在同一链表
  - 维护 `minFreq` 指针快速定位最低频率
  - 频率相同时按 FIFO 顺序淘汰（时间戳）
- **时间复杂度**: O(1) 查找、插入、删除

### 1.2 磁盘缓存 + LRU 淘汰
- **文件**: `internal/cache/disk_cache.go`
- **原理**: SQLite 持久化 + LRU 淘汰
- **实现细节**:
  - SQLite WAL 模式提升并发性能
  - 缓存大小超限时淘汰最久未访问的 10%
  - 支持 Gzip 压缩（超过 1KB 自动压缩）
- **缓存键生成**: `MD5(model:prompt)`

### 1.3 两级向量缓存 (L1 + L2)
- **文件**: `internal/rag/embedding_cache.go`
- **原理**: 本地内存 + Redis 两级缓存
- **实现细节**:
  - L1: `sync.Map` 本地缓存（最多 1 万条）
  - L2: Redis 持久化缓存（默认 7 天 TTL）
  - L1 满时淘汰 50% 条目
- **缓存键**: `SHA256(text)[:16]` 前 16 字节

### 1.4 令牌桶限流算法
- **文件**: `internal/middleware/rate_limiter.go`
- **原理**: Token Bucket 算法
- **实现细节**:
  - 支持每秒/每分钟双重限制
  - 突发容量 (Burst Size) 控制
  - 支持按用户/租户/端点三种维度限流
- **公式**: `tokens += elapsed_seconds × requests_per_second`

---

## 二、向量检索与 RAG 算法

### 2.1 余弦相似度搜索
- **文件**: `internal/rag/pgvector_store.go`
- **原理**: pgvector 扩展的向量相似度搜索
- **实现细节**:
  - 使用 `<=>` 操作符计算余弦距离
  - 相似度 = `1 - 余弦距离`
- **SQL**: `ORDER BY embedding <=> query_vector LIMIT k`

### 2.2 BM25 全文检索
- **文件**: `internal/rag/keyword_searcher.go`
- **原理**: PostgreSQL 全文搜索 + BM25 排序
- **实现细节**:
  - 使用 `ts_rank_cd` 函数进行 BM25 风格排序
  - GIN 索引加速全文搜索
  - 支持高亮显示匹配片段

### 2.3 RRF 融合排序
- **文件**: `internal/rag/multi_kb_search.go`
- **原理**: Reciprocal Rank Fusion 多路结果融合
- **公式**: `score(d) = Σ 1/(k + rank_i(d))`
- **参数**: k = 60（RRF 常数）

### 2.4 重排序算法 (Reranking)
- **文件**: `internal/rag/reranker.go`
- **原理**: 多因素加权重排序
- **评分因子**:
  - Jaccard 相似度 (40%)
  - TF-IDF 简化版 (10%)
  - 位置权重: `exp(-2 × position_ratio)` (30%)
  - 长度惩罚: 理想长度 50-500 词 (10%)
- **最终分数**: `0.3 × 原始分数 + 0.7 × 重排序分数`

### 2.5 语义分块算法
- **文件**: `internal/rag/semantic_chunker.go`
- **原理**: 按语义边界（段落/章节）分块
- **实现细节**:
  - 支持 Markdown 标题识别 (`# ## ###`)
  - 支持中文章节识别 (`第一章、第二节`)
  - 重叠窗口保证上下文连贯性
  - 大段落自动按句子二次分割

### 2.6 固定窗口分块
- **文件**: `internal/rag/chunker.go`
- **原理**: 按字符数分块 + 句子边界对齐
- **实现细节**:
  - 默认分块大小: 500 字符
  - 重叠大小: 不超过分块的 10%
  - 句子结束标记: `。！？.`

### 2.7 增量索引算法
- **文件**: `internal/rag/incremental_indexer.go`
- **原理**: 基于内容哈希的差异检测
- **流程**:
  1. 计算新内容的 SHA256 哈希
  2. 与旧哈希比对，识别变更分块
  3. 只对变更的分块重新向量化
- **变更类型**: add / update / delete

### 2.8 Token 估算
- **文件**: `internal/rag/chunker.go`
- **公式**:
  - 英文: `token ≈ 单词数`
  - 中文: `token ≈ 字符数 ÷ 1.5`

---

## 三、工作流调度算法

### 3.1 Kahn 拓扑排序
- **文件**: `internal/workflow/executor/scheduler.go`
- **原理**: 基于入度的 DAG 拓扑排序
- **实现细节**:
  - 事件驱动调度（任务完成触发后继任务）
  - 死锁检测（无法继续执行时报错）
  - 支持断点恢复 (Resume)

### 3.2 并行执行器
- **文件**: `internal/workflow/executor/parallel_executor.go`
- **原理**: Goroutine + Semaphore 并发控制
- **实现细节**:
  - 信号量限制最大并发数（默认 5）
  - Best-effort 模式：部分失败不影响其他任务
  - 支持超时控制

### 3.3 条件表达式引擎
- **文件**: `internal/workflow/executor/condition_executor.go`
- **原理**: 基于 govaluate 的表达式求值
- **支持的操作符**: `== != > >= < <= in contains regex`
- **内置函数**: `any_of() all_of() none_of() contains() empty() not_empty() len()`

### 3.4 循环执行器
- **文件**: `internal/workflow/executor/loop_executor.go`
- **循环类型**:
  - `count`: 固定次数循环
  - `while`: 条件循环
  - `foreach`: 遍历循环
- **安全限制**: 最大 1000 次迭代

### 3.5 优先级队列
- **文件**: `internal/infra/queue/priority_queue.go`
- **原理**: 基于 Asynq 的多队列优先级调度
- **优先级**: Critical(6) > High(4) > Normal(2) > Low(1)
- **权重调度**: 高优先级队列获得更多处理机会

---

## 四、规则与评估引擎

### 4.1 审批规则引擎
- **文件**: `internal/workflow/approval/rule_engine.go`
- **原理**: 条件匹配 + 优先级排序
- **支持的条件**: `eq ne gt gte lt lte in not_in contains starts_with ends_with regex is_null is_not_null`
- **匹配模式**: `all`（全部满足）/ `any`（任一满足）
- **动作类型**: `auto_approve auto_reject assign escalate skip`

### 4.2 质量评估器
- **文件**: `internal/workflow/executor/quality_evaluator.go`
- **原理**: 调用 Analyzer Agent 评估输出质量
- **输出**: 0-100 分
- **触发重写**: 分数低于阈值时自动重写

---

## 五、A/B 测试与统计

### 5.1 一致性哈希分桶
- **文件**: `internal/agent/abtest.go`
- **原理**: SHA256 哈希 → [0, 1) 区间映射
- **公式**: `bucket = hash(expID:userID) / 2^32`
- **保证**: 同一用户始终分配到相同变体

### 5.2 Z-test 显著性检验
- **文件**: `internal/agent/abtest.go`
- **原理**: 双样本比例 Z 检验
- **公式**:
  ```
  pooled_p = (p1×n1 + p2×n2) / (n1 + n2)
  SE = sqrt(pooled_p × (1-pooled_p) × (1/n1 + 1/n2))
  Z = (p2 - p1) / SE
  ```
- **显著性阈值**: |Z| > 1.96（95% 置信度）

### 5.3 增量平均计算
- **文件**: `internal/agent/abtest.go`
- **公式**: `new_avg = old_avg × (n-1)/n + new_value/n`
- **用途**: 实时更新延迟、Token 等指标的平均值

---

## 六、代码搜索算法

### 6.1 符号解析
- **文件**: `internal/codesearch/ace_search.go`
- **原理**: 正则表达式匹配函数/类/接口定义
- **支持语言**: Go, TypeScript, JavaScript, Python

### 6.2 模糊匹配评分
- **文件**: `internal/codesearch/ace_search.go`
- **评分规则**:
  - 精确匹配: 100 分
  - 前缀匹配: 80 分
  - 包含匹配: 60 分
  - 子序列匹配: 20 × 匹配字符数

### 6.3 多引擎文本搜索
- **文件**: `internal/codesearch/ace_search.go`
- **优先级**: git grep → ripgrep → Go 原生实现
- **自动降级**: 工具不可用时自动切换

---

## 七、上下文与会话管理

### 7.1 Token 截断算法
- **文件**: `internal/agent/runtime/context_manager.go`
- **原理**: 基于 tiktoken 的消息历史截断
- **策略**:
  1. 始终保留 System Prompt（如有）
  2. 从最新消息开始，向前添加直到超限
  3. 极端情况：至少保留最后一条消息

### 7.2 会话存储
- **文件**: `internal/agent/runtime/context_manager.go`
- **后端**: 内存 / Redis
- **数据结构**: `Session { ID, History, Data, CreatedAt, UpdatedAt }`

---

## 八、模板引擎

### 8.1 模板缓存
- **文件**: `internal/workflow/executor/template.go`
- **原理**: `sync.Map` 缓存已解析模板
- **键**: 模板字符串本身

### 8.2 递归模板渲染
- **文件**: `internal/workflow/executor/template.go`
- **支持类型**: 字符串、嵌套 Map、数组
- **内置函数**: `upper lower trim title json default join first last isnil`

---

## 九、认证与安全

### 9.1 JWT 密钥轮换
- **文件**: `internal/auth/jwt_key_rotation.go`
- **原理**: 双密钥重叠验证
- **参数**:
  - 轮换间隔: 7 天
  - 重叠时间: 24 小时
  - 密钥长度: 32 字节

### 9.2 随机密钥生成
- **文件**: `internal/auth/jwt_key_rotation.go`
- **算法**: `crypto/rand.Read()`
- **编码**: Base64 URL Safe

### 9.3 RBAC 权限检查
- **文件**: `internal/auth/rbac.go`
- **模型**: 资源 + 动作
- **上下文**: TenantContext (TenantID, UserID, Roles)

---

## 十、实时通信

### 10.1 WebSocket Hub
- **文件**: `internal/notification/hub.go`
- **数据结构**: 三层嵌套 Map `tenant → user → conn`
- **功能**: 注册、注销、按用户推送、租户广播

### 10.2 离线消息队列
- **文件**: `internal/notification/hub.go`
- **原理**: 连接断开时存储消息，重连后重放
- **存储**: 内存 / Redis

### 10.3 心跳保活
- **文件**: `internal/notification/hub.go`
- **机制**: 定时发送 Ping 帧
- **默认间隔**: 30 秒

---

## 十一、内容审核

### 11.1 敏感词过滤
- **文件**: `internal/moderation/service.go`
- **算法**: 字符串匹配（大小写不敏感）
- **动作**: replace（替换）/ block（屏蔽为 *）/ flag（标记）
- **缓存**: 按租户缓存敏感词列表

### 11.2 AI 预审
- **文件**: `internal/moderation/service.go`
- **原理**: 调用 Reviewer Agent 评估风险
- **输出**: `risk_level` (safe/low/medium/high) + `risk_score` (0-100)

### 11.3 多级审核流程
- **文件**: `internal/moderation/service.go`
- **状态机**: pending → reviewing → approved/rejected/revision/escalated

---

## 十二、配额管理

### 12.1 悲观锁配额控制
- **文件**: `internal/tenant/service_quota.go`
- **原理**: `SELECT ... FOR UPDATE` 锁定记录
- **目的**: 防止并发操作导致配额超卖

### 12.2 周期性配额重置
- **文件**: `internal/tenant/service_quota.go`
- **周期**:
  - Token: 每月重置
  - API 调用: 每日重置
- **触发**: 读取时检查 + 异步更新

### 12.3 套餐分级配额
- **文件**: `internal/tenant/service_quota.go`
- **套餐**: free / basic / pro / enterprise
- **资源**: 用户数、存储、工作流、知识库、Token、API 调用

---

## 十三、核心数据结构

| 数据结构 | 使用位置 | 用途 |
|---------|---------|------|
| DAG (有向无环图) | 工作流调度 | 步骤依赖关系 |
| 双向链表 | LFU 缓存 | 频率分组 |
| 三层嵌套 Map | WebSocket Hub | 连接管理 |
| sync.Map | 多处 | 线程安全缓存 |
| Channel + Semaphore | 并行执行器 | 并发控制 |
| 优先级队列 | 任务调度 | 按优先级处理 |

---

## 十四、算法复杂度汇总

| 算法 | 时间复杂度 | 空间复杂度 |
|------|-----------|-----------|
| LFU 缓存操作 | O(1) | O(n) |
| 向量相似度搜索 | O(n) / O(log n) with IVF | O(n×d) |
| Kahn 拓扑排序 | O(V+E) | O(V) |
| RRF 融合 | O(k×m) | O(m) |
| 一致性哈希 | O(1) | O(1) |
| BM25 搜索 | O(n) with GIN index | O(n) |

---

*文档版本: 1.0*
*更新时间: 2024-11*
