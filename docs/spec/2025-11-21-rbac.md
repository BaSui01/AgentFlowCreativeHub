# 自定义角色权限（S-08）实现方案

## 1. 数据模型与迁移
- 新建 `permissions`、`roles`、`role_permissions`、`user_roles` 四张表：
  - `permissions(code, name, category)` 预置系统权限点，如 `workflow:create`。
  - `roles(id, tenant_id, name, description, is_system)` 支持系统与租户自定义角色。
  - `role_permissions(role_id, permission_code)` 关联多对多。
  - `user_roles(user_id, role_id)` 支持多角色赋权。
- 提供 GORM AutoMigrate + 种子脚本：启动时注入系统默认权限与管理员角色。

## 2. 服务层改造
- 新建 `internal/auth/rbac/service.go`：封装 `CreateRole`, `UpdateRole`, `ListRoles`, `AssignRoleToUser`, `CheckPermission`。
- 在 `auth.Middleware` / `PermissionChecker` 中改为查询数据库角色与权限缓存（Prefer Redis + 本地内存，带 5 min TTL）。
- 在用户登录或角色更新后刷新缓存，确保变更即时生效。

## 3. API 与路由
- 新增 `/api/tenants/:id/roles` REST：
  - `POST` 创建角色（校验名称唯一、权限点合法）。
  - `GET` 列出角色及权限。
  - `PUT` 更新角色描述及权限集合。
  - `DELETE` 禁止删除系统角色，允许删除自定义角色。
- 新增 `/api/tenants/:id/users/:userId/roles`：支持批量赋权/撤权。
- 所有操作需 `rbac:manage_roles` 权限；接口返回结构与前端现有 `TenantHandler` 兼容。

## 4. 权限点覆盖
- 梳理现有敏感操作（工作流管理、知识库 CRUD、命令执行等），在对应 handler 上标注 `RequirePermission([]string{"workflow:create"})`。
- 默认管理员角色包含全部权限，普通成员保留基础读取。

## 5. 验证与测试
- 数据层：为 role/permission service 编写单测覆盖创建、更新、冲突校验、权限判断。
- 集成：对权限中间件新增测试，模拟无权限访问返回 403。
- 迁移：`go test ./...` + 手动运行 `go run cmd/server` 验证种子数据。

## 6. 后续 UI（可选提示）
- 前端后续在租户设置页调用新 API，展示角色列表与复选框权限矩阵（此阶段先完成后端能力）。

确认后我会按以上步骤实施。