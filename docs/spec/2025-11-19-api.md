## 目标
在已完成的 OpenAPI 基础上，继续聚焦后端认证链路与 API 质量，确保下一阶段交付包括：完善本地用户体系、OAuth2 流程、路由注释覆盖率、以及可回归的自动化验证。

## 1. 认证模块深化（`backend/api/handlers/auth/auth_handler.go`）
1. **用户源统一**：替换临时 `tempUser` 逻辑，补齐 `users/user_roles` CRUD，整理默认租户与角色赋值策略。
2. **OAuth2 全流程**：
   - 实现 state 持久化和回收（Redis 失效策略、重放保护）。
   - `createUserFromOAuth2` 重构为 service 并接入事务 + 幂等约束。
3. **Session & Refresh Token**：为 `sessionService` 加 redis/backing store，补齐刷新/吊销接口，提供自动过期清理。
4. **JWT/RBAC 强化**：扩展 `internal/auth/middleware.go` 支持多租户隔离、权限映射缓存，以及调试模式下的 bypass 选项。

## 2. API 注释与契约覆盖
1. **Swagger 注解推广**：对 auth、tenant、workflow、knowledge、tools 等 Handler 的核心路由补齐 `@Summary/@Param/@Success`；抽象公共响应结构避免重复。
2. **错误响应规范化**：设计统一 `ErrorResponse` DTO，在所有 handler 中落地，同时更新 Swagger schema。
3. **自动校验**：在 `Makefile` 加 `swagger` 与 `lint` 组合任务，CI 中通过 `swag fmt+init` + `npm run generate:api` 校验契约一致性。

## 3. 自动化验证与可观测
1. **测试基线**：为 auth service/handler 编写 table-driven unit test（mock DB、Redis），并辅以集成测试脚本（例如 httpc/insomnia collection）。
2. **监控指标**：在认证与 OAuth2 路径埋点 Prometheus counter/latency，结合 `metrics.PrometheusMiddleware` 形成可视化指标。
3. **审计与安全日志**：完善 `auditpkg` 的元数据设置，确保登录、刷新、登出、OAuth2 回调均记录上下文。

## 4. 交付与风险
- **阶段性交付**：优先实现本地用户+Refresh Token -> OAuth2 -> Swagger & Tests，保证每一步可独立验证。
- **风险控制**：明确开发/生产配置差异（JWT 密钥、Redis 可用性），引入 feature flag 防止未完成功能泄露。
- **验证脚本**：在最终阶段运行 `go test ./...`, `make swagger`, `npm run generate:api && npm run build`, 以及针对 auth 路由的回归脚本。

> 确认此规划后，可按顺序执行：先构建用户/Session service，再扩展 handler 与 Swagger，最后补测试和监控。