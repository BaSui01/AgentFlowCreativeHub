# ğŸ” æ•°æ®æ¨¡å‹å®Œå–„æ€§åˆ†æä¸æ”¹è¿›æ–¹æ¡ˆ

## ğŸ“Š ç°çŠ¶åˆ†æ

### âœ… å·²æœ‰è®¾è®¡ï¼ˆä¼˜ç‚¹ï¼‰

**æ¶æ„è®¾è®¡è‰¯å¥½**ï¼š
- å¤šç§Ÿæˆ·éš”ç¦»è®¾è®¡å®Œæ•´
- å¤–é”®çº¦æŸä½¿ç”¨å¾—å½“
- ç´¢å¼•ç­–ç•¥åˆç†

**æ—¶é—´æˆ³ç®¡ç†**ï¼š
- æ‰€æœ‰è¡¨éƒ½æœ‰ `created_at` å’Œ `updated_at`
- ä½¿ç”¨ PostgreSQL çš„ `TIMESTAMPTZ` ç±»å‹

### âŒ å…³é”®ç¼ºå¤±ï¼ˆéœ€ç«‹å³è¡¥å……ï¼‰

#### 1. **è½¯åˆ é™¤æœºåˆ¶ç¼ºå¤±** âš ï¸ ä¸¥é‡é—®é¢˜

**ç°çŠ¶**ï¼š
- Go Model ä¸­ï¼šæ‰€æœ‰æ¨¡å‹éƒ½**ç¼ºå°‘** `DeletedAt` å­—æ®µ
- SQL è¿ç§»è„šæœ¬ä¸­ï¼šæ‰€æœ‰è¡¨éƒ½**ç¼ºå°‘** `deleted_at` åˆ—
- æ•°æ®åº“è®¾è®¡æ–‡æ¡£ä¸­ï¼šæåˆ°äº†è½¯åˆ é™¤åŸåˆ™ï¼Œä½†å®é™…æœªå®ç°

**å½±å“**ï¼š
- æ— æ³•å®ç°é€»è¾‘åˆ é™¤ï¼Œåªèƒ½ç‰©ç†åˆ é™¤
- æ— æ³•æ¢å¤è¯¯åˆ æ•°æ®
- å®¡è®¡æ—¥å¿—æ— æ³•è¿½æº¯å·²åˆ é™¤è®°å½•
- å¤–é”®çº§è”åˆ é™¤ä¼šå¯¼è‡´æ•°æ®æ°¸ä¹…ä¸¢å¤±

#### 2. **ç”¨æˆ·æ¨¡å‹å­—æ®µä¸å®Œå–„** âš ï¸ ä¸­ç­‰é—®é¢˜

**Go Model ç¼ºå¤±å­—æ®µ**ï¼š
```go
// ç°æœ‰ User æ¨¡å‹ç¼ºå°‘ï¼š
- FullName      string    // çœŸå®å§“å
- AvatarURL     string    // å¤´åƒ
- Phone         string    // æ‰‹æœºå·
- Locale        string    // è¯­è¨€åå¥½
- Timezone      string    // æ—¶åŒº
- EmailVerified bool      // é‚®ç®±éªŒè¯çŠ¶æ€
- LastLoginAt   *time.Time // æœ€åç™»å½•æ—¶é—´
- LastLoginIP   string    // æœ€åç™»å½• IP
- LoginAttempts int       // ç™»å½•å¤±è´¥æ¬¡æ•°ï¼ˆå®‰å…¨ï¼‰
- LockedUntil   *time.Time // é”å®šæˆªæ­¢æ—¶é—´
- DeletedAt     *time.Time // è½¯åˆ é™¤æ—¶é—´
- DeletedBy     string    // åˆ é™¤æ“ä½œäºº
```

#### 3. **ç§Ÿæˆ·æ¨¡å‹å­—æ®µä¸å®Œå–„** âš ï¸ ä¸­ç­‰é—®é¢˜

**Go Model ç¼ºå¤±å­—æ®µ**ï¼š
```go
// ç°æœ‰ Tenant æ¨¡å‹ç¼ºå°‘ï¼š
- Tier            string    // å¥—é¤å±‚çº§ï¼ˆfree/pro/enterpriseï¼‰
- ContactEmail    string    // è”ç³»é‚®ç®±
- ContactPhone    string    // è”ç³»ç”µè¯
- ContactPerson   string    // è”ç³»äºº
- Industry        string    // è¡Œä¸š
- CompanySize     string    // å…¬å¸è§„æ¨¡
- Country         string    // å›½å®¶/åœ°åŒº
- TrialEndsAt     *time.Time // è¯•ç”¨ç»“æŸæ—¶é—´
- SubscriptionEndsAt *time.Time // è®¢é˜…ç»“æŸæ—¶é—´
- DeletedAt       *time.Time // è½¯åˆ é™¤æ—¶é—´
- DeletedBy       string    // åˆ é™¤æ“ä½œäºº
```

#### 4. **è§’è‰²æ¨¡å‹å­—æ®µä¸å®Œå–„**

**Go Model ç¼ºå¤±å­—æ®µ**ï¼š
```go
// ç°æœ‰ Role æ¨¡å‹ç¼ºå°‘ï¼š
- Code         string  // è§’è‰²ä»£ç ï¼ˆadmin/editor/viewerï¼‰
- IsSystem     bool    // ç³»ç»Ÿè§’è‰²æ ‡è¯†ï¼ˆä¸å¯åˆ é™¤ï¼‰
- IsDefault    bool    // é»˜è®¤è§’è‰²ï¼ˆæ–°ç”¨æˆ·è‡ªåŠ¨åˆ†é…ï¼‰
- Priority     int     // ä¼˜å…ˆçº§ï¼ˆç”¨äºè§’è‰²å†²çªè§£å†³ï¼‰
- DeletedAt    *time.Time // è½¯åˆ é™¤æ—¶é—´
```

#### 5. **å®¡è®¡æ—¥å¿—å­—æ®µä¸å®Œå–„** âš ï¸ ä¸­ç­‰é—®é¢˜

**Go Model ç¼ºå¤±å­—æ®µ**ï¼š
```go
// ç°æœ‰ AuditLog æ¨¡å‹ç¼ºå°‘ï¼š
- IPAddress     string    // æ“ä½œ IP åœ°å€
- UserAgent     string    // ç”¨æˆ·ä»£ç†
- RequestID     string    // è¯·æ±‚ ID
- SessionID     string    // ä¼šè¯ ID
- ResourceID    string    // èµ„æº ID
- OldValue      any       // ä¿®æ”¹å‰çš„å€¼
- NewValue      any       // ä¿®æ”¹åçš„å€¼
- Status        string    // æ“ä½œçŠ¶æ€ï¼ˆsuccess/failureï¼‰
- ErrorMessage  string    // é”™è¯¯ä¿¡æ¯
```

#### 6. **çŸ¥è¯†åº“ç›¸å…³æ¨¡å‹å­—æ®µä¸å®Œå–„**

**KnowledgeBase ç¼ºå¤±å­—æ®µ**ï¼š
```go
- CreatedBy     string    // åˆ›å»ºäºº
- UpdatedBy     string    // æ›´æ–°äºº
- Status        string    // çŠ¶æ€ï¼ˆactive/archived/deletedï¼‰
- DocumentCount int       // æ–‡æ¡£æ•°é‡
- ChunkCount    int       // åˆ†ç‰‡æ•°é‡
- TotalSize     int64     // æ€»å¤§å°ï¼ˆå­—èŠ‚ï¼‰
- DeletedAt     *time.Time // è½¯åˆ é™¤æ—¶é—´
```

**KnowledgeDocument ç¼ºå¤±å­—æ®µ**ï¼š
```go
- Title         string    // æ–‡æ¡£æ ‡é¢˜
- Author        string    // ä½œè€…
- FileSize      int64     // æ–‡ä»¶å¤§å°
- FileMimeType  string    // MIME ç±»å‹
- FileHash      string    // æ–‡ä»¶å“ˆå¸Œï¼ˆå»é‡ï¼‰
- UploadedBy    string    // ä¸Šä¼ äºº
- ProcessedAt   *time.Time // å¤„ç†å®Œæˆæ—¶é—´
- ErrorMessage  string    // é”™è¯¯ä¿¡æ¯
- DeletedAt     *time.Time // è½¯åˆ é™¤æ—¶é—´
```

**KnowledgeChunk ç¼ºå¤±å­—æ®µ**ï¼š
```go
- Embedding     []float32  // å‘é‡ï¼ˆPostgreSQL vector ç±»å‹ï¼‰
- TokenCount    int        // Token æ•°é‡
- CreatedAt     time.Time  // åˆ›å»ºæ—¶é—´
```

---

## ğŸ¯ æ”¹è¿›æ–¹æ¡ˆ

### ä¼˜å…ˆçº§ P0ï¼šè½¯åˆ é™¤æœºåˆ¶ï¼ˆå¿…é¡»ç«‹å³å®ç°ï¼‰

#### 1. æ›´æ–° Go Models

**åˆ›å»ºè½¯åˆ é™¤åŸºç¡€ç»“æ„**ï¼š
```go
// backend/internal/common/models.go
package common

import "time"

// SoftDeleteModel è½¯åˆ é™¤åŸºç¡€æ¨¡å‹
type SoftDeleteModel struct {
    DeletedAt *time.Time `json:"deletedAt,omitempty" gorm:"index"`
    DeletedBy string     `json:"deletedBy,omitempty"`
}

// IsDeleted æ£€æŸ¥æ˜¯å¦å·²åˆ é™¤
func (m *SoftDeleteModel) IsDeleted() bool {
    return m.DeletedAt != nil
}

// SoftDelete æ‰§è¡Œè½¯åˆ é™¤
func (m *SoftDeleteModel) SoftDelete(operatorID string) {
    now := time.Now()
    m.DeletedAt = &now
    m.DeletedBy = operatorID
}
```

**æ›´æ–°æ‰€æœ‰å…³é”® Model**ï¼š
```go
// backend/internal/tenant/models.go

// Tenant ç§Ÿæˆ·æ¨¡å‹ï¼ˆå®Œå–„ç‰ˆï¼‰
type Tenant struct {
    ID        string    `json:"id" gorm:"primaryKey;type:uuid"`
    Name      string    `json:"name" gorm:"size:255;not null"`
    Slug      string    `json:"slug" gorm:"size:100;uniqueIndex;not null"`
    Status    string    `json:"status" gorm:"size:50;not null;default:active"`
    
    // å¥—é¤ä¿¡æ¯
    Tier              string     `json:"tier" gorm:"size:50;not null;default:free"`
    TrialEndsAt       *time.Time `json:"trialEndsAt"`
    SubscriptionEndsAt *time.Time `json:"subscriptionEndsAt"`
    
    // è”ç³»ä¿¡æ¯
    ContactEmail  string `json:"contactEmail" gorm:"size:255"`
    ContactPhone  string `json:"contactPhone" gorm:"size:50"`
    ContactPerson string `json:"contactPerson" gorm:"size:100"`
    
    // å…¬å¸ä¿¡æ¯
    Industry    string `json:"industry" gorm:"size:100"`
    CompanySize string `json:"companySize" gorm:"size:50"`
    Country     string `json:"country" gorm:"size:100"`
    
    // æ—¶é—´æˆ³
    CreatedAt time.Time  `json:"createdAt" gorm:"not null"`
    UpdatedAt time.Time  `json:"updatedAt" gorm:"not null"`
    DeletedAt *time.Time `json:"deletedAt,omitempty" gorm:"index"`
    DeletedBy string     `json:"deletedBy,omitempty" gorm:"size:100"`
}

// User ç”¨æˆ·æ¨¡å‹ï¼ˆå®Œå–„ç‰ˆï¼‰
type User struct {
    ID       string `json:"id" gorm:"primaryKey;type:uuid"`
    TenantID string `json:"tenantId" gorm:"type:uuid;not null;index"`
    
    // è®¤è¯ä¿¡æ¯
    Email        string `json:"email" gorm:"size:255;not null"`
    Username     string `json:"username" gorm:"size:100;not null"`
    PasswordHash string `json:"-" gorm:"size:255;not null"`
    
    // ä¸ªäººä¿¡æ¯
    FullName  string `json:"fullName" gorm:"size:255"`
    AvatarURL string `json:"avatarUrl" gorm:"type:text"`
    Phone     string `json:"phone" gorm:"size:50"`
    
    // åå¥½è®¾ç½®
    Locale   string `json:"locale" gorm:"size:10;default:zh-CN"`
    Timezone string `json:"timezone" gorm:"size:50;default:Asia/Shanghai"`
    
    // çŠ¶æ€ç®¡ç†
    Status        string `json:"status" gorm:"size:50;not null;default:active"`
    EmailVerified bool   `json:"emailVerified" gorm:"default:false"`
    
    // å®‰å…¨ç›¸å…³
    LastLoginAt   *time.Time `json:"lastLoginAt"`
    LastLoginIP   string     `json:"lastLoginIp" gorm:"size:50"`
    LoginAttempts int        `json:"-" gorm:"default:0"`
    LockedUntil   *time.Time `json:"lockedUntil"`
    
    // æ—¶é—´æˆ³
    CreatedAt time.Time  `json:"createdAt" gorm:"not null"`
    UpdatedAt time.Time  `json:"updatedAt" gorm:"not null"`
    DeletedAt *time.Time `json:"deletedAt,omitempty" gorm:"index"`
    DeletedBy string     `json:"deletedBy,omitempty" gorm:"size:100"`
}

// Role è§’è‰²æ¨¡å‹ï¼ˆå®Œå–„ç‰ˆï¼‰
type Role struct {
    ID       string `json:"id" gorm:"primaryKey;type:uuid"`
    TenantID string `json:"tenantId" gorm:"type:uuid;not null;index"`
    
    Name        string `json:"name" gorm:"size:100;not null"`
    Code        string `json:"code" gorm:"size:100;not null"`
    Description string `json:"description" gorm:"type:text"`
    
    // è§’è‰²å±æ€§
    IsSystem  bool `json:"isSystem" gorm:"default:false"`
    IsDefault bool `json:"isDefault" gorm:"default:false"`
    Priority  int  `json:"priority" gorm:"default:0"`
    
    // æ—¶é—´æˆ³
    CreatedAt time.Time  `json:"createdAt" gorm:"not null"`
    UpdatedAt time.Time  `json:"updatedAt" gorm:"not null"`
    DeletedAt *time.Time `json:"deletedAt,omitempty" gorm:"index"`
}

// AuditLog å®¡è®¡æ—¥å¿—æ¨¡å‹ï¼ˆå®Œå–„ç‰ˆï¼‰
type AuditLog struct {
    ID       string `json:"id" gorm:"primaryKey;type:uuid"`
    TenantID string `json:"tenantId" gorm:"type:uuid;not null;index"`
    UserID   string `json:"userId" gorm:"type:uuid"`
    
    // æ“ä½œä¿¡æ¯
    Action   string `json:"action" gorm:"size:255;not null"`
    Resource string `json:"resource" gorm:"size:255;not null"`
    ResourceID string `json:"resourceId" gorm:"size:100"`
    
    // å˜æ›´è®°å½•
    OldValue any `json:"oldValue" gorm:"type:jsonb"`
    NewValue any `json:"newValue" gorm:"type:jsonb"`
    Details  any `json:"details" gorm:"type:jsonb"`
    
    // è¯·æ±‚ä¸Šä¸‹æ–‡
    IPAddress string `json:"ipAddress" gorm:"size:50"`
    UserAgent string `json:"userAgent" gorm:"size:500"`
    RequestID string `json:"requestId" gorm:"size:100;index"`
    SessionID string `json:"sessionId" gorm:"size:100"`
    
    // ç»“æœ
    Status       string `json:"status" gorm:"size:50;not null"`
    ErrorMessage string `json:"errorMessage" gorm:"type:text"`
    
    // æ—¶é—´æˆ³
    CreatedAt time.Time `json:"createdAt" gorm:"not null;index"`
}
```

#### 2. æ›´æ–°æ•°æ®åº“è¿ç§»è„šæœ¬

**åˆ›å»ºè¡¥å……è¿ç§»è„šæœ¬**ï¼š
```sql
-- db/migrations/0003_add_soft_delete.sql

-- ä¸º tenants è¡¨æ·»åŠ è½¯åˆ é™¤å’Œè¡¥å……å­—æ®µ
ALTER TABLE tenants 
    ADD COLUMN tier VARCHAR(50) NOT NULL DEFAULT 'free',
    ADD COLUMN contact_email VARCHAR(255),
    ADD COLUMN contact_phone VARCHAR(50),
    ADD COLUMN contact_person VARCHAR(100),
    ADD COLUMN industry VARCHAR(100),
    ADD COLUMN company_size VARCHAR(50),
    ADD COLUMN country VARCHAR(100),
    ADD COLUMN trial_ends_at TIMESTAMPTZ,
    ADD COLUMN subscription_ends_at TIMESTAMPTZ,
    ADD COLUMN deleted_at TIMESTAMPTZ,
    ADD COLUMN deleted_by VARCHAR(100);

CREATE INDEX idx_tenants_deleted_at ON tenants(deleted_at) WHERE deleted_at IS NULL;

-- ä¸º users è¡¨æ·»åŠ è½¯åˆ é™¤å’Œè¡¥å……å­—æ®µ
ALTER TABLE users
    ADD COLUMN full_name VARCHAR(255),
    ADD COLUMN avatar_url TEXT,
    ADD COLUMN phone VARCHAR(50),
    ADD COLUMN locale VARCHAR(10) DEFAULT 'zh-CN',
    ADD COLUMN timezone VARCHAR(50) DEFAULT 'Asia/Shanghai',
    ADD COLUMN email_verified BOOLEAN DEFAULT FALSE,
    ADD COLUMN last_login_at TIMESTAMPTZ,
    ADD COLUMN last_login_ip VARCHAR(50),
    ADD COLUMN login_attempts INT DEFAULT 0,
    ADD COLUMN locked_until TIMESTAMPTZ,
    ADD COLUMN deleted_at TIMESTAMPTZ,
    ADD COLUMN deleted_by VARCHAR(100);

CREATE INDEX idx_users_deleted_at ON users(deleted_at) WHERE deleted_at IS NULL;
CREATE INDEX idx_users_email_verified ON users(tenant_id, email_verified);
CREATE INDEX idx_users_last_login_at ON users(last_login_at DESC);

-- ä¸º roles è¡¨æ·»åŠ è½¯åˆ é™¤å’Œè¡¥å……å­—æ®µ
ALTER TABLE roles
    ADD COLUMN code VARCHAR(100),
    ADD COLUMN is_system BOOLEAN DEFAULT FALSE,
    ADD COLUMN is_default BOOLEAN DEFAULT FALSE,
    ADD COLUMN priority INT DEFAULT 0,
    ADD COLUMN deleted_at TIMESTAMPTZ;

CREATE INDEX idx_roles_deleted_at ON roles(deleted_at) WHERE deleted_at IS NULL;
CREATE UNIQUE INDEX idx_roles_tenant_code ON roles(tenant_id, code) WHERE deleted_at IS NULL;

-- ä¸º knowledge_bases è¡¨æ·»åŠ è½¯åˆ é™¤å’Œè¡¥å……å­—æ®µ
ALTER TABLE knowledge_bases
    ADD COLUMN created_by VARCHAR(100),
    ADD COLUMN updated_by VARCHAR(100),
    ADD COLUMN status VARCHAR(50) NOT NULL DEFAULT 'active',
    ADD COLUMN document_count INT DEFAULT 0,
    ADD COLUMN chunk_count INT DEFAULT 0,
    ADD COLUMN total_size BIGINT DEFAULT 0,
    ADD COLUMN deleted_at TIMESTAMPTZ;

CREATE INDEX idx_kb_deleted_at ON knowledge_bases(deleted_at) WHERE deleted_at IS NULL;

-- ä¸º knowledge_documents è¡¨æ·»åŠ è½¯åˆ é™¤å’Œè¡¥å……å­—æ®µ
ALTER TABLE knowledge_documents
    ADD COLUMN title VARCHAR(500),
    ADD COLUMN author VARCHAR(255),
    ADD COLUMN file_size BIGINT,
    ADD COLUMN file_mime_type VARCHAR(100),
    ADD COLUMN file_hash VARCHAR(64),
    ADD COLUMN uploaded_by VARCHAR(100),
    ADD COLUMN processed_at TIMESTAMPTZ,
    ADD COLUMN error_message TEXT,
    ADD COLUMN deleted_at TIMESTAMPTZ;

CREATE INDEX idx_kd_deleted_at ON knowledge_documents(deleted_at) WHERE deleted_at IS NULL;
CREATE INDEX idx_kd_file_hash ON knowledge_documents(file_hash) WHERE file_hash IS NOT NULL;

-- ä¸º audit_logs è¡¨æ·»åŠ è¡¥å……å­—æ®µ
ALTER TABLE audit_logs
    ADD COLUMN resource_id VARCHAR(100),
    ADD COLUMN old_value JSONB,
    ADD COLUMN new_value JSONB,
    ADD COLUMN ip_address VARCHAR(50),
    ADD COLUMN user_agent VARCHAR(500),
    ADD COLUMN request_id VARCHAR(100),
    ADD COLUMN session_id VARCHAR(100),
    ADD COLUMN status VARCHAR(50) NOT NULL DEFAULT 'success',
    ADD COLUMN error_message TEXT;

CREATE INDEX idx_audit_logs_request_id ON audit_logs(request_id);
CREATE INDEX idx_audit_logs_session_id ON audit_logs(session_id);
CREATE INDEX idx_audit_logs_status ON audit_logs(tenant_id, status, created_at DESC);
```

#### 3. å®ç°è½¯åˆ é™¤æŸ¥è¯¢èŒƒå›´ï¼ˆGORM Scopeï¼‰

```go
// backend/internal/common/scopes.go
package common

import "gorm.io/gorm"

// NotDeleted è¿‡æ»¤å·²åˆ é™¤è®°å½•
func NotDeleted() func(db *gorm.DB) *gorm.DB {
    return func(db *gorm.DB) *gorm.DB {
        return db.Where("deleted_at IS NULL")
    }
}

// WithDeleted åŒ…å«å·²åˆ é™¤è®°å½•
func WithDeleted() func(db *gorm.DB) *gorm.DB {
    return func(db *gorm.DB) *gorm.DB {
        return db.Unscoped()
    }
}

// OnlyDeleted ä»…æŸ¥è¯¢å·²åˆ é™¤è®°å½•
func OnlyDeleted() func(db *gorm.DB) *gorm.DB {
    return func(db *gorm.DB) *gorm.DB {
        return db.Where("deleted_at IS NOT NULL")
    }
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```go
// é»˜è®¤æŸ¥è¯¢ï¼ˆè‡ªåŠ¨è¿‡æ»¤å·²åˆ é™¤ï¼‰
db.Model(&User{}).Where("tenant_id = ?", tenantID).Find(&users)

// åŒ…å«å·²åˆ é™¤è®°å½•
db.Scopes(WithDeleted()).Model(&User{}).Find(&users)

// ä»…æŸ¥è¯¢å·²åˆ é™¤è®°å½•
db.Scopes(OnlyDeleted()).Model(&User{}).Find(&users)
```

---

### ä¼˜å…ˆçº§ P1ï¼šè¡¥å……ä¸šåŠ¡å­—æ®µ

#### 1. åˆ›å»ºå®Œæ•´çš„ RAG æ¨¡å‹

```go
// backend/internal/rag/models.goï¼ˆå®Œå–„ç‰ˆï¼‰

// KnowledgeBase çŸ¥è¯†åº“æ¨¡å‹ï¼ˆå®Œå–„ç‰ˆï¼‰
type KnowledgeBase struct {
    ID        string `json:"id" gorm:"primaryKey;type:uuid"`
    TenantID  string `json:"tenantId" gorm:"type:uuid;not null;index"`
    
    Name        string `json:"name" gorm:"size:255;not null"`
    Description string `json:"description" gorm:"type:text"`
    
    // å¯è§æ€§
    VisibilityScope string `json:"visibilityScope" gorm:"size:50;not null;default:tenant"`
    
    // é…ç½®
    DefaultEmbeddingModel string `json:"defaultEmbeddingModel" gorm:"size:100"`
    
    // ç»Ÿè®¡ä¿¡æ¯
    DocumentCount int   `json:"documentCount" gorm:"default:0"`
    ChunkCount    int   `json:"chunkCount" gorm:"default:0"`
    TotalSize     int64 `json:"totalSize" gorm:"default:0"` // å­—èŠ‚
    
    // çŠ¶æ€
    Status string `json:"status" gorm:"size:50;not null;default:active"`
    
    // åˆ›å»ºäºº/æ›´æ–°äºº
    CreatedBy string `json:"createdBy" gorm:"size:100"`
    UpdatedBy string `json:"updatedBy" gorm:"size:100"`
    
    // æ—¶é—´æˆ³
    CreatedAt time.Time  `json:"createdAt" gorm:"not null"`
    UpdatedAt time.Time  `json:"updatedAt" gorm:"not null"`
    DeletedAt *time.Time `json:"deletedAt,omitempty" gorm:"index"`
}

// KnowledgeDocument çŸ¥è¯†æ–‡æ¡£æ¨¡å‹ï¼ˆå®Œå–„ç‰ˆï¼‰
type KnowledgeDocument struct {
    ID              string `json:"id" gorm:"primaryKey;type:uuid"`
    KnowledgeBaseID string `json:"knowledgeBaseId" gorm:"type:uuid;not null;index"`
    
    // æ–‡æ¡£ä¿¡æ¯
    Title  string `json:"title" gorm:"size:500"`
    Author string `json:"author" gorm:"size:255"`
    
    // æ–‡ä»¶ä¿¡æ¯
    SourceType   string `json:"sourceType" gorm:"size:50;not null"` // pdf, markdown, txt, url
    SourceURI    string `json:"sourceUri" gorm:"type:text;not null"`
    FileSize     int64  `json:"fileSize"`
    FileMimeType string `json:"fileMimeType" gorm:"size:100"`
    FileHash     string `json:"fileHash" gorm:"size:64;index"` // SHA-256
    
    // ç‰ˆæœ¬ä¸çŠ¶æ€
    Version string `json:"version" gorm:"size:50"`
    Status  string `json:"status" gorm:"size:50;not null;default:pending"` // pending, processing, indexed, failed
    
    // å¤„ç†ä¿¡æ¯
    UploadedBy   string     `json:"uploadedBy" gorm:"size:100"`
    ProcessedAt  *time.Time `json:"processedAt"`
    ErrorMessage string     `json:"errorMessage" gorm:"type:text"`
    
    // æ—¶é—´æˆ³
    CreatedAt time.Time  `json:"createdAt" gorm:"not null"`
    UpdatedAt time.Time  `json:"updatedAt" gorm:"not null"`
    DeletedAt *time.Time `json:"deletedAt,omitempty" gorm:"index"`
}

// KnowledgeChunk çŸ¥è¯†åˆ†ç‰‡æ¨¡å‹ï¼ˆå®Œå–„ç‰ˆï¼‰
type KnowledgeChunk struct {
    ID         string `json:"id" gorm:"primaryKey;type:uuid"`
    DocumentID string `json:"documentId" gorm:"type:uuid;not null;index"`
    
    ChunkIndex int    `json:"chunkIndex" gorm:"not null"`
    Content    string `json:"content" gorm:"type:text;not null"`
    TokenCount int    `json:"tokenCount" gorm:"default:0"`
    
    // å‘é‡ï¼ˆPostgreSQL pgvector ç±»å‹ï¼‰
    Embedding  string         `json:"-" gorm:"type:vector(1536)"` // OpenAI embedding ç»´åº¦
    Metadata   map[string]any `json:"metadata" gorm:"type:jsonb"`
    
    // æ—¶é—´æˆ³
    CreatedAt time.Time `json:"createdAt" gorm:"not null"`
}
```

---

### ä¼˜å…ˆçº§ P2ï¼šæ•°æ®åº“è§¦å‘å™¨ä¸çº¦æŸ

#### 1. è‡ªåŠ¨æ›´æ–° updated_at è§¦å‘å™¨

```sql
-- db/migrations/0004_add_triggers.sql

-- åˆ›å»ºé€šç”¨çš„ updated_at è§¦å‘å™¨å‡½æ•°
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- ä¸ºæ‰€æœ‰è¡¨æ·»åŠ è§¦å‘å™¨
CREATE TRIGGER update_tenants_updated_at BEFORE UPDATE ON tenants
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_users_updated_at BEFORE UPDATE ON users
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_roles_updated_at BEFORE UPDATE ON roles
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_knowledge_bases_updated_at BEFORE UPDATE ON knowledge_bases
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_knowledge_documents_updated_at BEFORE UPDATE ON knowledge_documents
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

#### 2. è½¯åˆ é™¤æŸ¥è¯¢è§†å›¾ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰

```sql
-- åˆ›å»ºæ´»è·ƒç§Ÿæˆ·è§†å›¾
CREATE VIEW active_tenants AS
SELECT * FROM tenants WHERE deleted_at IS NULL;

-- åˆ›å»ºæ´»è·ƒç”¨æˆ·è§†å›¾
CREATE VIEW active_users AS
SELECT * FROM users WHERE deleted_at IS NULL;

-- åˆ›å»ºæ´»è·ƒçŸ¥è¯†åº“è§†å›¾
CREATE VIEW active_knowledge_bases AS
SELECT * FROM knowledge_bases WHERE deleted_at IS NULL;
```

---

## ğŸ“‹ å®æ–½æ£€æŸ¥æ¸…å•

### ç¬¬ 1 æ­¥ï¼šæ›´æ–° Go Modelsï¼ˆ1 å¤©ï¼‰
- [ ] åˆ›å»º `backend/internal/common/models.go` - è½¯åˆ é™¤åŸºç¡€ç»“æ„
- [ ] æ›´æ–° `backend/internal/tenant/models.go` - Tenant/User/Role å®Œå–„ç‰ˆ
- [ ] æ›´æ–° `backend/internal/rag/models.go` - RAG ç›¸å…³æ¨¡å‹å®Œå–„ç‰ˆ
- [ ] åˆ›å»º `backend/internal/common/scopes.go` - GORM æŸ¥è¯¢èŒƒå›´

### ç¬¬ 2 æ­¥ï¼šæ›´æ–°æ•°æ®åº“è¿ç§»è„šæœ¬ï¼ˆ1 å¤©ï¼‰
- [ ] åˆ›å»º `db/migrations/0003_add_soft_delete.sql` - æ·»åŠ è½¯åˆ é™¤å­—æ®µ
- [ ] åˆ›å»º `db/migrations/0004_add_triggers.sql` - æ·»åŠ è§¦å‘å™¨
- [ ] åˆ›å»º `db/migrations/0005_add_views.sql` - æ·»åŠ è§†å›¾
- [ ] æµ‹è¯•è¿ç§»è„šæœ¬ï¼ˆup/downï¼‰

### ç¬¬ 3 æ­¥ï¼šæ›´æ–°æ•°æ®åº“è®¾è®¡æ–‡æ¡£ï¼ˆ0.5 å¤©ï¼‰
- [ ] æ›´æ–° `docs/æ•°æ®åº“è®¾è®¡æ–‡æ¡£.md` - è¡¥å……æ‰€æœ‰æ–°å­—æ®µ
- [ ] æ›´æ–° ER å›¾ - åæ˜ æœ€æ–°ç»“æ„
- [ ] æ·»åŠ å­—æ®µè¯´æ˜å’Œçº¦æŸæ–‡æ¡£

### ç¬¬ 4 æ­¥ï¼šæ›´æ–° Service å±‚ï¼ˆ1 å¤©ï¼‰
- [ ] æ›´æ–° `backend/internal/tenant/service_tenant.go` - æ”¯æŒè½¯åˆ é™¤
- [ ] æ›´æ–° `backend/internal/tenant/service_user.go` - æ”¯æŒè½¯åˆ é™¤
- [ ] æ›´æ–° `backend/internal/tenant/service_role.go` - æ”¯æŒè½¯åˆ é™¤
- [ ] æ·»åŠ æ¢å¤ï¼ˆRestoreï¼‰æ–¹æ³•

### ç¬¬ 5 æ­¥ï¼šæ›´æ–° API å±‚ï¼ˆ0.5 å¤©ï¼‰
- [ ] æ·»åŠ è½¯åˆ é™¤ APIï¼š`DELETE /api/users/:id` (è½¯åˆ é™¤)
- [ ] æ·»åŠ æ¢å¤ APIï¼š`POST /api/users/:id/restore`
- [ ] æ·»åŠ æ°¸ä¹…åˆ é™¤ APIï¼š`DELETE /api/users/:id/permanent` (ä»…ç®¡ç†å‘˜)
- [ ] æ›´æ–°æŸ¥è¯¢ APIï¼šæ”¯æŒ `?include_deleted=true` å‚æ•°

### ç¬¬ 6 æ­¥ï¼šç¼–å†™æµ‹è¯•ï¼ˆ1 å¤©ï¼‰
- [ ] æµ‹è¯•è½¯åˆ é™¤åŠŸèƒ½
- [ ] æµ‹è¯•æŸ¥è¯¢è¿‡æ»¤ï¼ˆå·²åˆ é™¤/æœªåˆ é™¤ï¼‰
- [ ] æµ‹è¯•æ¢å¤åŠŸèƒ½
- [ ] æµ‹è¯•è§¦å‘å™¨è‡ªåŠ¨æ›´æ–° updated_at

---

## ğŸ¯ éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶
- âœ… æ‰€æœ‰å…³é”®è¡¨æ”¯æŒè½¯åˆ é™¤
- âœ… æŸ¥è¯¢é»˜è®¤è¿‡æ»¤å·²åˆ é™¤è®°å½•
- âœ… æ”¯æŒæ¢å¤å·²åˆ é™¤è®°å½•
- âœ… ç”¨æˆ·æ¨¡å‹åŒ…å«å®Œæ•´ä¸ªäººä¿¡æ¯å’Œå®‰å…¨å­—æ®µ
- âœ… ç§Ÿæˆ·æ¨¡å‹åŒ…å«å®Œæ•´å¥—é¤å’Œè”ç³»ä¿¡æ¯
- âœ… å®¡è®¡æ—¥å¿—åŒ…å«å®Œæ•´æ“ä½œä¸Šä¸‹æ–‡

### æ€§èƒ½éªŒæ”¶
- âœ… è½¯åˆ é™¤æŸ¥è¯¢æ€§èƒ½ä¸ä½äºç¡¬åˆ é™¤ï¼ˆé€šè¿‡ç´¢å¼•ä¼˜åŒ–ï¼‰
- âœ… updated_at è‡ªåŠ¨æ›´æ–°ï¼ˆè§¦å‘å™¨ï¼‰
- âœ… å·²åˆ é™¤è®°å½•ä¸å½±å“ä¸»æŸ¥è¯¢æ€§èƒ½ï¼ˆéƒ¨åˆ†ç´¢å¼•ï¼‰

### æ–‡æ¡£éªŒæ”¶
- âœ… æ•°æ®åº“è®¾è®¡æ–‡æ¡£å®Œæ•´æ›´æ–°
- âœ… API æ–‡æ¡£åŒ…å«è½¯åˆ é™¤ç›¸å…³æ¥å£
- âœ… ä»£ç æ³¨é‡Šå®Œæ•´

---

## âš ï¸ é£é™©ä¸æ³¨æ„äº‹é¡¹

### è¿ç§»é£é™©
- **ç°æœ‰æ•°æ®**ï¼šè¿ç§»è„šæœ¬éœ€è¦ä¸ºç°æœ‰è®°å½•æ·»åŠ é»˜è®¤å€¼
- **å¤–é”®çº¦æŸ**ï¼šè½¯åˆ é™¤å¯èƒ½å¯¼è‡´å¤–é”®å¼•ç”¨å·²åˆ é™¤è®°å½•
- **æŸ¥è¯¢æ€§èƒ½**ï¼šéœ€è¦æ·»åŠ  `WHERE deleted_at IS NULL` æ¡ä»¶

### è§£å†³æ–¹æ¡ˆ
1. **ä½¿ç”¨éƒ¨åˆ†ç´¢å¼•**ï¼š`WHERE deleted_at IS NULL` æå‡æŸ¥è¯¢æ€§èƒ½
2. **GORM è‡ªåŠ¨æ³¨å…¥**ï¼šä½¿ç”¨ Scope è‡ªåŠ¨æ·»åŠ è¿‡æ»¤æ¡ä»¶
3. **å¤–é”®ç­–ç•¥**ï¼šå®¡è®¡æ—¥å¿—ç­‰ä½¿ç”¨ `ON DELETE SET NULL`

---

## ğŸ“Š é¢„è®¡å·¥æ—¶

| ä»»åŠ¡ | å·¥æ—¶ | ä¼˜å…ˆçº§ |
|------|------|--------|
| æ›´æ–° Go Models | 1 å¤© | P0 |
| æ›´æ–°æ•°æ®åº“è¿ç§»è„šæœ¬ | 1 å¤© | P0 |
| æ›´æ–° Service å±‚ | 1 å¤© | P0 |
| æ›´æ–° API å±‚ | 0.5 å¤© | P1 |
| æ›´æ–°æ–‡æ¡£ | 0.5 å¤© | P1 |
| ç¼–å†™æµ‹è¯• | 1 å¤© | P1 |
| **æ€»è®¡** | **5 å¤©** | |

---

## ğŸ“ åç»­å»ºè®®

1. **GORM é’©å­å‡½æ•°**ï¼šå®ç° BeforeDelete é’©å­ï¼Œè‡ªåŠ¨å¤„ç†è½¯åˆ é™¤é€»è¾‘
2. **å®šæœŸæ¸…ç†**ï¼šå®ç°å®šæ—¶ä»»åŠ¡ï¼Œå®šæœŸå½’æ¡£æˆ–æ°¸ä¹…åˆ é™¤è¿‡æœŸçš„è½¯åˆ é™¤è®°å½•
3. **å®¡è®¡é›†æˆ**ï¼šè½¯åˆ é™¤/æ¢å¤æ“ä½œè‡ªåŠ¨è®°å½•åˆ°å®¡è®¡æ—¥å¿—
4. **æƒé™æ§åˆ¶**ï¼šæ°¸ä¹…åˆ é™¤æƒé™ä»…å¼€æ”¾ç»™è¶…çº§ç®¡ç†å‘˜