## ğŸ¯ ç›®æ ‡
åœ¨ç°æœ‰å®¡æ‰¹ & WebSocket é€šçŸ¥éª¨æ¶ä¹‹ä¸Šï¼Œè¡¥é½å®é™…ç”Ÿäº§å¯ç”¨èƒ½åŠ›ï¼šåŠ¨æ€é€šçŸ¥ç›®æ ‡è§£æã€å®æ—¶é€šé“å¯é æ€§ã€è‡ªåŠ¨å®¡æ‰¹è§„åˆ™ã€å¯è§‚æµ‹æ€§ä¸æµ‹è¯•ã€‚

## 1. é€šçŸ¥ç›®æ ‡è§£æä¸æ¸ é“ç­–ç•¥
1. **ç§Ÿæˆ·çº§é€šçŸ¥é…ç½®æº**ï¼š
   - åœ¨ `tenant_config` å¢åŠ  `approval.notification_targets`ï¼Œæ”¯æŒé»˜è®¤ email/webhook/websocket ç”¨æˆ·åˆ—è¡¨æˆ–è§’è‰²ã€‚
   - æ–°å»º `NotificationTargetResolver`ï¼ˆä¾èµ–ç§Ÿæˆ·æœåŠ¡ + ç”¨æˆ·ç›®å½•ï¼‰ï¼Œå…œåº•åˆ°è¯·æ±‚äººã€å®¡æ‰¹äººè§’è‰²ã€‚
2. **æ¸ é“å›é€€ç­–ç•¥**ï¼š
   - `approval.Manager.sendNotification` å†…éƒ¨æ ¹æ® resolver è¾“å‡º {channel -> targets[]}ï¼Œä¸ºç©ºæ—¶å›é€€é¡ºåº websocket â†’ email â†’ webhookã€‚
   - è®°å½•è½åœ°çš„æ¸ é“ä¸å¤±è´¥åŸå› ï¼Œä¾›å®¡è®¡/é‡è¯•ä½¿ç”¨ã€‚
3. **å•å…ƒæµ‹è¯•**ï¼šMock resolverï¼Œè¦†ç›–ã€Œæ˜¾å¼é…ç½®ã€ã€Œæ— é…ç½®å›é€€ã€ã€Œéƒ¨åˆ†å¤±è´¥å›é€€ã€ä¸‰ç±»åœºæ™¯ã€‚

## 2. WebSocket ä¼šè¯å¯é æ€§
1. **è¿æ¥ç”Ÿå‘½å‘¨æœŸ**ï¼š
   - `WebSocketHub` è®°å½• `lastSeen`ã€`userAgent`ï¼Œæ–°å¢ `KeepAlive(interval)` ä¾‹ç¨‹ï¼ˆæœåŠ¡ç«¯ pingã€å®¢æˆ·ç«¯ pongï¼‰ã€‚
   - åœ¨ `/api/ws/notifications` å¢åŠ  `?channels=approvals,...` è®¢é˜…å‚æ•°ï¼ŒHub å†…éƒ¨æŒ‰é¢‘é“æŒ‚è½½ã€‚
2. **æ–­çº¿ä¸é‡æ”¾**ï¼š
   - ç»´æŠ¤æ¯ç”¨æˆ·æœ€è¿‘ N æ¡é€šçŸ¥ï¼ˆRedis listï¼‰ï¼Œ`SendToUser` å¤±è´¥æ—¶å†™å…¥ç¼“å­˜ï¼›æ–°è¿æ¥æ—¶è‡ªåŠ¨è¡¥å‘ã€‚
3. **æŒ‡æ ‡ä¸æ—¥å¿—**ï¼š
   - Prometheus è®¡æ•°å™¨ï¼š`ws_connections{tenant}`ã€`ws_send_error{reason}`ï¼›åœ¨ logger ä¸­è®°å½•æ³¨å†Œ/æ³¨é”€ã€‚
4. **æµ‹è¯•**ï¼šä½¿ç”¨å†…å­˜ hub + fake connï¼ˆå®ç° `WriteJSON`ï¼‰éªŒè¯æ³¨å†Œ/æ³¨é”€ã€é‡æ”¾é€»è¾‘ã€‚

## 3. è‡ªåŠ¨å®¡æ‰¹è§„åˆ™å¼ºåŒ–
1. **æ¡ä»¶è§£æå¢å¼º**ï¼š
   - å°† `ConditionExecutor` æ³¨å…¥ `AutomatedTaskExecutor`ï¼Œå…è®¸è¡¨è¾¾å¼è®¿é—® `task.Result`ã€`state.StepResults` ç­‰ã€‚
   - æ”¯æŒ `any_of([])`ã€`all_of([])` è¾…åŠ©å‡½æ•°ï¼Œè¦†ç›–å¤šæ¡ä»¶å®¡æ‰¹éœ€æ±‚ã€‚
2. **å®¡æ‰¹ä¸Šä¸‹æ–‡å†™å…¥**ï¼š
   - `ApprovalRequest.StepOutput` å†™å…¥æœ€è¿‘ä»»åŠ¡è¾“å‡ºæ‘˜è¦ï¼ˆé™å®š sizeï¼‰ï¼Œä¾›å®¡æ‰¹ UI å±•ç¤ºã€‚
   - è®°å½• `AutoApproved` æ ‡å¿—å¹¶åœ¨ `AutomationLog` ä¸­è¿½åŠ æ¡ç›®ã€‚
3. **æµ‹è¯•**ï¼štable-driven ç”¨ä¾‹éªŒè¯ä¸åŒè¡¨è¾¾å¼ã€å‡½æ•°ã€å®¹é”™ï¼ˆæ— å˜é‡ã€ç±»å‹ä¸åŒ¹é…ï¼‰è·¯å¾„ã€‚

## 4. è§‚æµ‹ä¸å›æº¯
1. **æŒ‡æ ‡**ï¼š
   - `approvals_pending_total{tenant}`ã€`approvals_auto_ratio`ã€`notification_channel_failures`ã€‚
   - `WebSocketHub.ConnectedCount` æš´éœ²åˆ° `/metrics`ã€‚
2. **å®¡è®¡/é‡è¯•é¢æ¿**ï¼š
   - æ–°å¢ `POST /api/workflows/approvals/:id/resend`ï¼Œå¤ç”¨ resolver + channel ç­–ç•¥ã€‚
   - å®¡æ‰¹è¯·æ±‚å®ä½“è®°å½• `LastNotifiedAt`ã€`NotificationAttempts`ã€‚
3. **é›†æˆæµ‹è¯•**ï¼š
   - sqlite + fake notifier ç»„åˆéªŒè¯ API ç«¯ç‚¹ã€çŠ¶æ€è¿ç§»ï¼›worker å±‚å¢åŠ  `approve via auto rule` happy pathã€‚

## 5. å‘å¸ƒéªŒè¯
- `go test ./internal/notification ./internal/workflow/... ./api/handlers/...`
- e2e: å¯åŠ¨ dev server + websocket client è„šæœ¬ï¼Œç¡®è®¤å®¡æ‰¹äº‹ä»¶å®æ—¶æ¨é€ä¸ç¦»çº¿è¡¥å‘ã€‚
- æ–‡æ¡£ï¼šæ›´æ–° `docs/spec/*` é‡Œçš„å®¡æ‰¹ç« èŠ‚ã€é…ç½®ç¤ºä¾‹ï¼›è¡¥å…… `automation_example.yaml` æ–°å­—æ®µã€‚
