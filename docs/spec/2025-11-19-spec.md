## 🎯 目标
对现有后端中仍未实现或带有明显 TODO 的功能进行盘点与修复，优先补齐阻塞主路径的接口与能力，同时建立可验证的回归策略。

## 1. 工具管理 API 补全
- **问题**：`api/setup.go` 的工具路由只暴露查询/执行，`register/unregister`、按分类查询仍为 TODO。
- **方案**：
  1. 查阅 `toolHandlers` 和 `toolRegistry` 现状，设计 `RegisterToolRequest`/`UnregisterRequest` DTO，校验必填字段、唯一约束。
  2. 在 handler 中调用 registry/executor，为注册的工具落库或入内存；考虑幂等（存在即更新、删除前校验引用）。
  3. 分类查询新增 `GET /tools/categories/:category`，支持分页/模糊匹配。
  4. 为新增 API 编写最少 2 条集成测试（可使用 gin 的 httptest）。

## 2. 工作流执行历史查询落地
- **问题**：《2025-11-18-api.md》指出 `workflowExecuteHandler.GetExecution/ListExecutions` 仍是占位，导致前端无法查看运行结果。
- **方案**：
  1. 对接 `workflowSvc` 或直接访问 `workflow_executions` 表实现查询，支持按 `workflow_id/tenant_id` 过滤及分页。
  2. `GetExecution` 返回包含步骤日志、Agent 结果；必要时组合查询 `workflow_execution_steps`。
  3. 若 service 缺方法，先在 `workflow/executor` 层补仓储函数并复用 `common.NotDeleted`。
  4. 增补 Swagger 注解与示例响应，确保 OpenAPI 可生成客户端。

## 3. 租户/角色管理 API 对接真实 Service
- **问题**：setup 中租户 CRUD、用户/角色 API 目前直接调用 handler，但 handler 内仍存在 TODO，占位 JSON。
- **方案**：
  1. 走查 `tenantHandlers`，比对 `tenantSvc`、`userService`、`roleService` 替换硬编码返回。
  2. 设计统一的错误响应 DTO（现阶段多处 `gin.H{"error":...}`），结合 CLAUDE.md 要求输出中文描述。
  3. 加入请求体验证（binding tag）及 `auditpkg` 记录。
  4. 编写表格驱动单测覆盖创建/列出用户、角色。

## 4. 模型调用日志缺失 provider 信息 BUG
- **问题**：`internal/ai/db_logger.go` 将 `ModelProvider` 误写为 `ModelID`（TODO 标记）。
- **方案**：
  1. 扩展 `ModelCallLog` 结构或在调用处补充 Provider 字段。
  2. 修改 `DBLogger.Log` 按真实 provider/model 填值，补充单元测试验证写入内容。
  3. 若数据库 schema 缺字段，对照迁移脚本补充。

## 5. OAuth2/Session 回归测试与 Redis 存储
- **问题**：虽已落地 `IdentityStore`、`StateStore`，但缺少端到端验证以及 Redis 连接降级日志。
- **方案**：
  1. 编写 HTTP 级集成测试模拟 OAuth2 state 保存/回调链路（可 mock OAuth2 service + Redis client）。
  2. 验证刷新令牌轮换：通过 session service 插入记录 -> 调用 `/api/auth/refresh` -> 确认 `RotateRefreshToken` 生效。
  3. 若 Redis 连接失败，目前仅 Warn 日志，需加 metrics（如 `oauth_state_store_downgrade_total`）。

## 6. 验证与观测
- **测试**：`go test ./...` + 针对新增 HTTP handler 的 httptest；如需数据库交互，使用 `sqlite` 内存库。
- **验证脚本**：在 `docs/testing.md` 记录命令；必要时提供 `make backend-test` 入口。
- **可观测性**：为关键新增路径增加 Prometheus 指标/审计记录，保证问题可追溯。

## 7. 交付节奏
1. **阶段 A（工具/工作流）**：解锁工具注册 & 执行历史，两项完成后回归测试。
2. **阶段 B（租户/角色）**：补齐 CRUD + 测试。
3. **阶段 C（AI 日志 & OAuth2 验证）**：修复日志 BUG、完善认证回归。
4. 每阶段结束前运行全量单测与 `swag init`，更新前端生成脚本。