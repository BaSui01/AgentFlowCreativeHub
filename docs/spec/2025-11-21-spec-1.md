## 下一步实施方案
1. **命令执行与上下文调度层**
   - 实现 `POST /api/commands/execute`：参数校验、去重 (sessionId+command+hash)，写入 `CommandRequest` 日志并返回排队信息。
   - 集成 AgentRuntime 队列：构建上下文（调用现有 Context Manager + workspace 快照），按 agent 并发/配额入 Redis Stream，提供排队位置与 traceId。
   - 失败分类：context_error / agent_timeout / archive_failed / permission_denied，对应写入 `CommandRequest` 与审计日志。

2. **暂存与审核状态机升级**
   - 扩展 `WorkspaceStagingFile` 字段：`reviewToken`、`secondaryReviewerId`、`slaExpiresAt`、`auditTrail` JSON。
   - Service 层实现状态流转（AwaitingReview→ApprovedPendingArchive 等），增加 `POST /api/staging/{id}/review` 幂等逻辑与 `secondaryReviewToken`。
   - 引入自动命名策略冲突处理（多次尝试 + -1/-2 后回传 `STG_PATH_COLLISION`）。
   - 定时任务/接口支持 `staging-cleaner`：扫描 TTL、自动标记 Abandoned 并写入审计。

3. **前端命令面板与审核体验**
   - 在 Dashboard 中为命令控制台接入 `/api/commands/execute`，展示排队/执行状态时间线、降级按钮（切换 Agent / 草稿模式）。
   - 暂存面板扩展为表格视图，支持筛选（状态/指派/命令来源）、SLA 倒计时、diff 预览及二次复核提示。
   - 文件预览区域加入 diff/历史 tab，复用 `/api/files/history`、`/api/files/diff`。

4. **权限与审计**
   - 在所有写 API (files/staging/commands) 前调用目录权限校验：依据 `AgentConfig.AllowedDirs`、用户 RBAC。
   - 统一审计 helper：写入 `AuditEvent`（actor、resourcePath、action、traceId、latencyMs、安全标签），并确保命令/审核/归档动作均落日志。

5. **验证与监控**
   - 新增单元测试：命令去重、状态机流转、审核幂等 token、命名冲突。
   - e2e/集成测试覆盖：命令→暂存→审核→归档闭环。
   - 暴露 Prometheus 指标：`commands.success_rate`、`staging.queue.length`、`files.write.error_rate`，并在日志中附加 traceId。

请确认以上计划或指出希望调整/优先的部分，确认后我再进入实现阶段。