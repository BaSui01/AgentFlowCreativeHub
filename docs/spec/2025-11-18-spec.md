# é¡¹ç›®åŸæœ‰é—®é¢˜ä¿®å¤å®æ–½æ–¹æ¡ˆ

## ğŸ“‹ ä¿®å¤èŒƒå›´

æœ¬æ¬¡ä¿®å¤å°†è§£å†³**12ä¸ªé¡¹ç›®åŸæœ‰é—®é¢˜**ï¼Œåˆ†3ä¸ªé˜¶æ®µå®æ–½ï¼Œé¢„è®¡è€—æ—¶**2-3å°æ—¶**ã€‚

---

## ğŸ¯ Phase 1: ç´§æ€¥ä¿®å¤ - è§£å†³ç¼–è¯‘é˜»å¡é—®é¢˜ (45åˆ†é’Ÿ)

### ä»»åŠ¡1.1: åˆ›å»ºç¼ºå¤±çš„åŸºç¡€ç±»å‹å®šä¹‰ (30åˆ†é’Ÿ)

#### 1.1.1 åˆ›å»º Pagination ç±»å‹
**æ–‡ä»¶**: `backend/pkg/types/pagination.go`
```go
package types

// PaginationRequest åˆ†é¡µè¯·æ±‚
type PaginationRequest struct {
    Page     int `json:"page"`
    PageSize int `json:"page_size"`
}

// PaginationResponse åˆ†é¡µå“åº”
type PaginationResponse struct {
    Page       int   `json:"page"`
    PageSize   int   `json:"page_size"`
    Total      int64 `json:"total"`
    TotalPages int   `json:"total_pages"`
}
```

**å½±å“**: ä¿®å¤6å¤„ç¼–è¯‘é”™è¯¯
- `models/audit_log.go:101, 105`
- `models/document.go:130` (2å¤„)
- `models/knowledge_base.go:83` (2å¤„)

#### 1.1.2 åˆ›å»º JSONMap ç±»å‹åˆ«å
**æ–‡ä»¶**: `backend/pkg/types/common.go`
```go
package types

// JSONMap JSONæ˜ å°„ç±»å‹
type JSONMap map[string]interface{}
```

**å½±å“**: ä¿®å¤4å¤„ç¼–è¯‘é”™è¯¯
- `models/document.go:28, 71`
- `models/knowledge_base.go:19, 20`

#### 1.1.3 åˆ›å»º ClientFactory æ¥å£
**æ–‡ä»¶**: `backend/pkg/aiinterface/factory.go`
```go
package aiinterface

// ClientFactory AIå®¢æˆ·ç«¯å·¥å‚æ¥å£
type ClientFactory interface {
    // CreateClient åˆ›å»ºAIå®¢æˆ·ç«¯
    CreateClient(modelType string, config *ClientConfig) (ModelClient, error)
    
    // GetSupportedModels è·å–æ”¯æŒçš„æ¨¡å‹åˆ—è¡¨
    GetSupportedModels() []string
}
```

**å½±å“**: ä¿®å¤2å¤„ç¼–è¯‘é”™è¯¯
- `models/discovery.go:21, 25`

#### 1.1.4 æ›´æ–° models åŒ…çš„ import
**æ–‡ä»¶**: `backend/internal/models/*.go` (éœ€è¦æ›´æ–°import)
- `audit_log.go`: æ·»åŠ  `import "backend/pkg/types"`
- `document.go`: æ·»åŠ  `import "backend/pkg/types"`
- `knowledge_base.go`: æ·»åŠ  `import "backend/pkg/types"`

**ä¿®æ”¹**: å°† `PaginationRequest` â†’ `types.PaginationRequest`, `JSONMap` â†’ `types.JSONMap`

---

### ä»»åŠ¡1.2: åˆ é™¤RAGæ¨¡å—é‡å¤å®šä¹‰ (15åˆ†é’Ÿ)

#### 1.2.1 æ–¹æ¡ˆA: åˆ é™¤ vector_store.go ä¸­çš„é‡å¤å®šä¹‰
**æ–‡ä»¶**: `backend/internal/rag/vector_store.go`

**åˆ é™¤å†…å®¹** (è¡Œ49-106):
- `type PGVectorStore struct`
- `func NewPGVectorStore`
- `func (s *PGVectorStore) IndexChunks`
- `func (s *PGVectorStore) Search`

**ä¿ç•™**: 
- `type VectorStore interface` (æ¥å£å®šä¹‰)
- `type ChunkEmbedding struct`
- `type ScoredChunk struct`

#### 1.2.2 æ–¹æ¡ˆB: é‡å‘½åä»¥é¿å…å†²çª (å¤‡é€‰)
å¦‚æœéœ€è¦ä¿ç•™ä¸¤ä¸ªå®ç°,å¯ä»¥é‡å‘½å:
- `vector_store.go` â†’ `type InfraDBVectorStore` (åŸºäºinfra.DB)
- `pgvector_store.go` â†’ `type PGVectorStore` (åŸºäºgorm.DB)

**æ¨è**: ä½¿ç”¨æ–¹æ¡ˆA,åˆ é™¤éª¨æ¶å®ç°,ä¿ç•™å®Œæ•´å®ç°

---

## ğŸ¯ Phase 2: æ•°æ®æ¨¡å‹å­—æ®µä¿®å¤ (1å°æ—¶)

### ä»»åŠ¡2.1: ä¿®å¤ AgentConfig ç¼ºå°‘ SystemPrompt å­—æ®µ (10åˆ†é’Ÿ)

**æ–‡ä»¶**: `backend/internal/agent/models.go`

**ä¿®æ”¹** (åœ¨ç¬¬16è¡Œåæ·»åŠ ):
```go
type AgentConfig struct {
    // ... ç°æœ‰å­—æ®µ
    
    ModelID          string `json:"modelId" gorm:"type:uuid;not null"`
    PromptTemplateID string `json:"promptTemplateId" gorm:"type:uuid"`
    
    // æ·»åŠ ç³»ç»Ÿæç¤ºè¯å­—æ®µ
    SystemPrompt     string `json:"systemPrompt" gorm:"type:text"`  // ğŸ†• æ–°å¢
    
    // RAG é…ç½®
    KnowledgeBaseID string `json:"knowledgeBaseId" gorm:"type:uuid"`
    // ...
}
```

**éªŒè¯**: `agent/service.go:176, 226` ä¸å†æŠ¥é”™

---

### ä»»åŠ¡2.2: ç»Ÿä¸€ Workflow ç»Ÿè®¡å­—æ®µå (20åˆ†é’Ÿ)

**æ–‡ä»¶**: `backend/internal/workflow/models.go`

**é€‰é¡¹A: ä¿®æ”¹æ¨¡å‹å®šä¹‰** (æ¨è):
```go
type Workflow struct {
    // ... å…¶ä»–å­—æ®µ
    
    // ç»Ÿè®¡ï¼ˆé€šè¿‡è§¦å‘å™¨è‡ªåŠ¨ç»´æŠ¤ï¼‰
    TotalExecutions   int `json:"totalExecutions" gorm:"column:execution_count;default:0"`
    SuccessExecutions int `json:"successExecutions" gorm:"column:success_count;default:0"`
    FailedExecutions  int `json:"failedExecutions" gorm:"column:failure_count;default:0"`
    
    // æ·»åŠ åˆ›å»ºäººå­—æ®µ
    CreatedBy string `json:"createdBy" gorm:"size:100"`  // ğŸ†• æ–°å¢
    
    // ...
}
```

**é€‰é¡¹B: ä¿®æ”¹ service.go ä½¿ç”¨** (å¤‡é€‰):
ä¿®æ”¹ `workflow/service.go:166-169, 322-329` ä½¿ç”¨ `ExecutionCount` ç­‰å­—æ®µ

**æ¨è**: é€‰é¡¹A,ä½¿ç”¨GORMçš„columnæ ‡ç­¾æ˜ å°„æ•°æ®åº“å­—æ®µ

---

### ä»»åŠ¡2.3: ä¿®å¤ PromptTemplate å­—æ®µé—®é¢˜ (15åˆ†é’Ÿ)

**æ–‡ä»¶**: `backend/internal/template/models.go`

**é—®é¢˜1**: ç¼ºå°‘ `CreatedBy` å­—æ®µ

**ä¿®æ”¹** (åœ¨ç¬¬23è¡Œåæ·»åŠ ):
```go
type PromptTemplate struct {
    // ... ç°æœ‰å­—æ®µ
    
    // ç»Ÿè®¡
    UsageCount int `json:"usageCount" gorm:"default:0"`
    
    // åˆ›å»ºäºº
    CreatedBy string `json:"createdBy" gorm:"size:100"`  // ğŸ†• æ–°å¢
    
    // æ—¶é—´æˆ³
    CreatedAt time.Time  `json:"createdAt" gorm:"not null;autoCreateTime"`
    // ...
}
```

**é—®é¢˜2**: `CurrentVersionID` ç±»å‹é—®é¢˜

**ä¿®æ”¹** (è¡Œ20):
```go
// ä¿®æ”¹å‰
CurrentVersionID string `json:"currentVersionId" gorm:"type:uuid"`

// ä¿®æ”¹å
CurrentVersionID *string `json:"currentVersionId" gorm:"type:uuid"`  // æ”¹ä¸ºæŒ‡é’ˆ
```

**æ–‡ä»¶**: `backend/internal/template/service.go`

**ä¿®æ”¹** (è¡Œ308):
```go
// ä¿®æ”¹å‰
Update("current_version_id", version.ID).Error

// ä¿®æ”¹å
Update("current_version_id", &version.ID).Error  // ä¼ æŒ‡é’ˆ
```

---

### ä»»åŠ¡2.4: ä¿®å¤ PromptTemplateVersion å­—æ®µ (10åˆ†é’Ÿ)

**æ–‡ä»¶**: `backend/internal/template/models.go`

**æŸ¥æ‰¾** `type PromptTemplateVersion struct`:

**ä¿®æ”¹å­—æ®µå** (ChangeLog â†’ Changelog):
```go
type PromptTemplateVersion struct {
    // ... å…¶ä»–å­—æ®µ
    
    Changelog string `json:"changelog" gorm:"type:text"`  // ä¿®æ­£æ‹¼å†™
    CreatedBy string `json:"createdBy" gorm:"size:100"`    // æ·»åŠ å­—æ®µ
    
    // ...
}
```

**æ–‡ä»¶**: `backend/internal/template/service.go`

**ä¿®æ”¹** (è¡Œ298):
```go
// ä¿®æ”¹å‰
ChangeLog:  req.ChangeLog,

// ä¿®æ”¹å
Changelog:  req.Changelog,  // ç»Ÿä¸€å­—æ®µå
```

---

### ä»»åŠ¡2.5: ä¿®å¤ KnowledgeChunk å­—æ®µåŒ¹é… (15åˆ†é’Ÿ)

**æ–‡ä»¶**: `backend/internal/rag/models.go`

**å½“å‰å®šä¹‰** (è¡Œ69-83):
```go
type KnowledgeChunk struct {
    ID         string `json:"id" gorm:"primaryKey;type:uuid"`
    DocumentID string `json:"documentId" gorm:"type:uuid;not null;index"`
    
    ChunkIndex int    `json:"chunkIndex" gorm:"not null"`
    Content    string `json:"content" gorm:"type:text;not null"`
    TokenCount int    `json:"tokenCount" gorm:"default:0"`
    
    // å‘é‡
    Embedding   string         `json:"-" gorm:"type:vector(1536)"`
    MetadataRaw map[string]any `json:"metadata" gorm:"type:jsonb;serializer:json"`
    
    CreatedAt time.Time `json:"createdAt" gorm:"not null;autoCreateTime"`
}
```

**ä¿®æ”¹ä¸º**:
```go
type KnowledgeChunk struct {
    ID              string `json:"id" gorm:"primaryKey;type:uuid"`
    DocumentID      string `json:"documentId" gorm:"type:uuid;not null;index"`
    KnowledgeBaseID string `json:"knowledgeBaseId" gorm:"type:uuid;not null;index"`  // ğŸ†• æ–°å¢
    
    ChunkIndex  int    `json:"chunkIndex" gorm:"not null"`
    Content     string `json:"content" gorm:"type:text;not null"`
    ContentHash string `json:"contentHash" gorm:"size:64;index"`  // ğŸ†• æ–°å¢
    TokenCount  int    `json:"tokenCount" gorm:"default:0"`
    
    // ä½ç½®ä¿¡æ¯
    StartOffset int `json:"startOffset" gorm:"column:start_pos"`  // ğŸ†• æ–°å¢,æ˜ å°„åˆ°start_pos
    EndOffset   int `json:"endOffset" gorm:"column:end_pos"`      // ğŸ†• æ–°å¢,æ˜ å°„åˆ°end_pos
    
    // å‘é‡
    Embedding         string         `json:"-" gorm:"type:vector(1536)"`
    EmbeddingModel    string         `json:"embeddingModel" gorm:"size:100"`     // ğŸ†• æ–°å¢
    EmbeddingProvider string         `json:"embeddingProvider" gorm:"size:50"`   // ğŸ†• æ–°å¢
    MetadataRaw       map[string]any `json:"metadata" gorm:"type:jsonb;serializer:json"`
    
    CreatedAt time.Time `json:"createdAt" gorm:"not null;autoCreateTime"`
}
```

---

## ğŸ¯ Phase 3: ç±»å‹è½¬æ¢å’Œä¼˜åŒ– (30åˆ†é’Ÿ)

### ä»»åŠ¡3.1: ä¿®å¤ Embedding ç±»å‹è½¬æ¢ (15åˆ†é’Ÿ)

**æ–‡ä»¶**: `backend/internal/rag/openai_embeddings.go`

**é—®é¢˜**: è¡Œ22ä½¿ç”¨å¸¸é‡ä½†å­—æ®µç±»å‹æ˜¯string

**ä¿®æ”¹** (è¡Œ19-22):
```go
// ä¿®æ”¹å‰
type OpenAIEmbeddingProvider struct {
    client *openai.Client
    model  string  // è¿™é‡Œæ˜¯string
}

func NewOpenAIEmbeddingProvider(apiKey string) *OpenAIEmbeddingProvider {
    return &OpenAIEmbeddingProvider{
        client: openai.NewClient(apiKey),
        model:  openai.SmallEmbedding3,  // âŒ ç±»å‹ä¸åŒ¹é…
    }
}

// ä¿®æ”¹å
func NewOpenAIEmbeddingProvider(apiKey string) *OpenAIEmbeddingProvider {
    return &OpenAIEmbeddingProvider{
        client: openai.NewClient(apiKey),
        model:  string(openai.SmallEmbedding3),  // âœ… æ˜¾å¼è½¬æ¢
    }
}
```

**æˆ–è€…æ”¹å­—æ®µç±»å‹**:
```go
type OpenAIEmbeddingProvider struct {
    client *openai.Client
    model  openai.EmbeddingModel  // ä½¿ç”¨æ­£ç¡®çš„ç±»å‹
}
```

---

### ä»»åŠ¡3.2: ç»Ÿä¸€ Vector/Embedding ç±»å‹å¤„ç† (15åˆ†é’Ÿ)

**é—®é¢˜**: `pgvector_store.go:56` å°è¯•å°† `[]float32` èµ‹å€¼ç»™ `string` å­—æ®µ

**åˆ†æ**: `KnowledgeChunk.Embedding` å®šä¹‰ä¸º `string` (å®é™…æ˜¯pgvector.Vectorçš„å­—ç¬¦ä¸²è¡¨ç¤º)

**æ–‡ä»¶**: `backend/internal/rag/pgvector_store.go`

**ä¿®æ”¹** (è¡Œ56):
```go
// ä¿®æ”¹å‰
Embedding:         vec.Embedding,  // []float32 â†’ string (ç±»å‹é”™è¯¯)

// ä¿®æ”¹å
Embedding:         vectorToString(vec.Embedding),  // ä½¿ç”¨è½¬æ¢å‡½æ•°
```

**æ·»åŠ è¾…åŠ©å‡½æ•°** (å·²å­˜åœ¨,è¡Œ235-244):
```go
// vectorToString å·²ç»å­˜åœ¨,ç›´æ¥ä½¿ç”¨
func vectorToString(vec []float32) string {
    // PostgreSQL vector æ ¼å¼: [0.1,0.2,0.3]
    parts := make([]string, len(vec))
    for i, v := range vec {
        parts[i] = fmt.Sprintf("%f", v)
    }
    return "[" + strings.Join(parts, ",") + "]"
}
```

---

## ğŸ“Š å®æ–½è®¡åˆ’æ€»è§ˆ

### æ–‡ä»¶åˆ›å»ºæ¸…å• (3ä¸ªæ–°æ–‡ä»¶)

1. `backend/pkg/types/pagination.go` (æ–°å»º)
2. `backend/pkg/types/common.go` (æ–°å»º)
3. `backend/pkg/aiinterface/factory.go` (æ–°å»º)

### æ–‡ä»¶ä¿®æ”¹æ¸…å• (11ä¸ªæ–‡ä»¶)

**modelsåŒ…** (4ä¸ª):
1. `backend/internal/models/audit_log.go` - æ·»åŠ import
2. `backend/internal/models/document.go` - æ·»åŠ import
3. `backend/internal/models/knowledge_base.go` - æ·»åŠ import
4. `backend/internal/models/discovery.go` - æ›´æ–°import

**agentåŒ…** (1ä¸ª):
5. `backend/internal/agent/models.go` - æ·»åŠ SystemPromptå­—æ®µ

**workflowåŒ…** (1ä¸ª):
6. `backend/internal/workflow/models.go` - ç»Ÿä¸€å­—æ®µå,æ·»åŠ CreatedBy

**templateåŒ…** (2ä¸ª):
7. `backend/internal/template/models.go` - ä¿®å¤å­—æ®µåå’Œç±»å‹
8. `backend/internal/template/service.go` - ä¿®å¤å­—æ®µå¼•ç”¨

**ragåŒ…** (3ä¸ª):
9. `backend/internal/rag/vector_store.go` - åˆ é™¤é‡å¤å®šä¹‰
10. `backend/internal/rag/models.go` - å®Œå–„KnowledgeChunkå­—æ®µ
11. `backend/internal/rag/openai_embeddings.go` - ä¿®å¤ç±»å‹è½¬æ¢

---

## âœ… éªŒæ”¶æ ‡å‡†

### Phase 1 éªŒæ”¶
- [ ] `go build ./pkg/types` æˆåŠŸ
- [ ] `go build ./pkg/aiinterface` æˆåŠŸ
- [ ] `go build ./internal/models` æˆåŠŸ
- [ ] `go build ./internal/rag` æˆåŠŸ (æ— é‡å¤å®šä¹‰é”™è¯¯)

### Phase 2 éªŒæ”¶
- [ ] `go build ./internal/agent` æˆåŠŸ
- [ ] `go build ./internal/workflow` æˆåŠŸ
- [ ] `go build ./internal/template` æˆåŠŸ

### Phase 3 éªŒæ”¶
- [ ] `go build ./internal/rag` æˆåŠŸ (æ— ç±»å‹é”™è¯¯)
- [ ] `go build ./...` å®Œå…¨æˆåŠŸ

### æœ€ç»ˆéªŒæ”¶
- [ ] æ— ç¼–è¯‘é”™è¯¯
- [ ] æ— ç±»å‹ä¸åŒ¹é…è­¦å‘Š
- [ ] æ•°æ®æ¨¡å‹å­—æ®µå®Œæ•´ä¸€è‡´
- [ ] æ‰€æœ‰importæ­£ç¡®

---

## âš ï¸ é£é™©æç¤º

1. **æ•°æ®åº“è¿ç§»**: æ·»åŠ æ–°å­—æ®µåéœ€è¦æ•°æ®åº“è¿ç§»
2. **APIå…¼å®¹æ€§**: å­—æ®µåå˜æ›´å¯èƒ½å½±å“ç°æœ‰API
3. **æµ‹è¯•æ›´æ–°**: ç›¸å…³å•å…ƒæµ‹è¯•éœ€è¦åŒæ­¥æ›´æ–°

---

## ğŸ“ å®æ–½é¡ºåº

**ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹é¡ºåºæ‰§è¡Œ**:

1. Phase 1.1 â†’ Phase 1.2 â†’ éªŒè¯ç¼–è¯‘
2. Phase 2.1 â†’ Phase 2.2 â†’ Phase 2.3 â†’ Phase 2.4 â†’ Phase 2.5 â†’ éªŒè¯ç¼–è¯‘
3. Phase 3.1 â†’ Phase 3.2 â†’ æœ€ç»ˆéªŒè¯

æ¯ä¸ªPhaseå®Œæˆåç«‹å³éªŒè¯,å‘ç°é—®é¢˜åŠæ—¶è°ƒæ•´ã€‚

---

**é¢„è®¡æ€»è€—æ—¶**: 2-3å°æ—¶  
**éš¾åº¦**: ä¸­ç­‰  
**é£é™©**: ä½ (éƒ½æ˜¯ä¿®å¤æ˜ç¡®çš„ç¼–è¯‘é”™è¯¯)