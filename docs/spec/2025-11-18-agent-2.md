## ğŸ” å½“å‰å®ç°åˆ†æ

### å·²å®ç°åŠŸèƒ½
âœ… Agent è§’è‰²ç³»ç»Ÿï¼ˆrole å­—æ®µï¼‰
âœ… å·¥ä½œæµæ¨¡æ¿ç³»ç»Ÿï¼ˆ6ä¸ªé¢„è®¾æ¨¡æ¿ï¼‰
âœ… æ¨¡æ¿åŠ è½½å™¨
âœ… å¿«é€Ÿåˆ›å»º API
âœ… Agent èƒ½åŠ›é…ç½®

### å‘ç°çš„é—®é¢˜

#### 1. **ç¼ºå°‘ fmt å¯¼å…¥** âš ï¸
`template_handler.go` ä¸­ä½¿ç”¨äº† `fmt.Sprintf` ä½†æœªå¯¼å…¥ `fmt` åŒ…

#### 2. **Agent åˆ›å»ºé€»è¾‘æœªæ”¯æŒè§’è‰²** âŒ
Registry çš„ `createAgent` æ–¹æ³•ä¸è¯†åˆ« `role` å’Œ `system_prompt_override`

#### 3. **æ¨¡æ¿å®ä¾‹åŒ–ä¸å®Œæ•´** âš ï¸
`InstantiateTemplate` æœªå®ç°å‚æ•°æ›¿æ¢é€»è¾‘

#### 4. **ç¼ºå°‘åˆå§‹åŒ–ä»£ç ** âŒ
åº”ç”¨å¯åŠ¨æ—¶æœªåŠ è½½æ¨¡æ¿å’Œèƒ½åŠ›é…ç½®

#### 5. **ç¼ºå°‘å·¥ä½œæµå®šä¹‰éªŒè¯** âš ï¸
API ä¸­éªŒè¯é€»è¾‘ä¸ºç©º

#### 6. **ç¼ºå°‘æ•°æ®åº“è¿ç§»è„šæœ¬** âŒ
æ–°å¢çš„è¡¨éœ€è¦åˆ›å»º

## ğŸ¯ ä¼˜åŒ–æ–¹æ¡ˆ

### ä¼˜åŒ– 1: ä¿®å¤å¯¼å…¥ç¼ºå¤±
**æ–‡ä»¶:** `template_handler.go`
```go
import (
    "fmt"  // æ·»åŠ æ­¤è¡Œ
    "net/http"
    // ...
)
```

### ä¼˜åŒ– 2: æ‰©å±• Agent åˆ›å»ºé€»è¾‘æ”¯æŒè§’è‰²
**æ–‡ä»¶:** `agent/runtime/registry.go`
**ä¿®æ”¹:** `createAgent` æ–¹æ³•

**å®ç°æ€è·¯:**
```go
func (r *Registry) createAgent(ctx context.Context, config *agentpkg.AgentConfig, stepDef *executor.StepDefinition) (Agent, error) {
    // è·å–æ¨¡å‹å®¢æˆ·ç«¯
    modelClient := ...
    
    // è½¬æ¢é…ç½®
    agentConfig := &AgentConfig{
        Name:         config.Name,
        Type:         config.AgentType,
        ModelID:      config.ModelID,
        SystemPrompt: config.SystemPrompt,
        // ...
    }
    
    // å¦‚æœæŒ‡å®šäº†è§’è‰²ï¼Œè¦†ç›– System Prompt
    if stepDef != nil {
        if stepDef.Role != "" {
            // ä»èƒ½åŠ›é…ç½®åŠ è½½è§’è‰²ç‰¹å®šçš„ System Prompt
            roleCapability := loadRoleCapability(config.AgentType, stepDef.Role)
            if roleCapability != nil {
                agentConfig.SystemPrompt = roleCapability.SystemPrompt
            }
        }
        
        // å¦‚æœæœ‰è‡ªå®šä¹‰ System Promptï¼Œä¼˜å…ˆçº§æœ€é«˜
        if stepDef.SystemPromptOverride != "" {
            agentConfig.SystemPrompt = stepDef.SystemPromptOverride
        }
    }
    
    // æ ¹æ®ç±»å‹åˆ›å»º Agent
    switch config.AgentType {
        // ...
    }
}
```

### ä¼˜åŒ– 3: å®ç°æ¨¡æ¿å‚æ•°æ›¿æ¢
**æ–‡ä»¶:** `workflow/template/loader.go`
**æ–¹æ³•:** `InstantiateTemplate`

**å®ç°æ€è·¯:**
```go
func (l *TemplateLoader) InstantiateTemplate(key string, params map[string]any) (map[string]any, error) {
    template := ...
    definition := deepCopyMap(template.Definition)
    
    // é€’å½’æ›¿æ¢æ‰€æœ‰ {{placeholder}}
    replaceParams(definition, params)
    
    return definition, nil
}

func replaceParams(data any, params map[string]any) {
    switch v := data.(type) {
    case map[string]any:
        for k, val := range v {
            if str, ok := val.(string); ok {
                v[k] = replacePlaceholders(str, params)
            } else {
                replaceParams(val, params)
            }
        }
    case []any:
        for i, val := range v {
            if str, ok := val.(string); ok {
                v[i] = replacePlaceholders(str, params)
            } else {
                replaceParams(val, params)
            }
        }
    }
}

func replacePlaceholders(str string, params map[string]any) string {
    // æ›¿æ¢ {{user_input.topic}} ç­‰å ä½ç¬¦
    re := regexp.MustCompile(`\{\{([^}]+)\}\}`)
    return re.ReplaceAllStringFunc(str, func(match string) string {
        key := strings.TrimSpace(match[2:len(match)-2])
        if val := getNestedValue(params, key); val != nil {
            return fmt.Sprint(val)
        }
        return match
    })
}
```

### ä¼˜åŒ– 4: æ·»åŠ åº”ç”¨åˆå§‹åŒ–ä»£ç 
**æ–‡ä»¶:** `backend/api/setup.go` æˆ– `main.go`

**å®ç°æ€è·¯:**
```go
func InitializeWorkflowSystem(db *gorm.DB) (*template.TemplateLoader, *template.AgentCapabilityLoader) {
    // åˆå§‹åŒ–æ¨¡æ¿åŠ è½½å™¨
    templateLoader := template.NewTemplateLoader()
    if err := templateLoader.LoadFromFile("config/workflow_templates.yaml"); err != nil {
        log.Printf("åŠ è½½å·¥ä½œæµæ¨¡æ¿å¤±è´¥: %v", err)
    }
    
    // åˆå§‹åŒ–èƒ½åŠ›åŠ è½½å™¨
    capabilityLoader := template.NewAgentCapabilityLoader()
    if err := capabilityLoader.LoadFromFile("config/agent_capabilities.yaml"); err != nil {
        log.Printf("åŠ è½½ Agent èƒ½åŠ›é…ç½®å¤±è´¥: %v", err)
    }
    
    return templateLoader, capabilityLoader
}
```

### ä¼˜åŒ– 5: å®ç°å·¥ä½œæµå®šä¹‰éªŒè¯
**æ–‡ä»¶:** `workflow/validator.go` (æ–°å»º)

**å®ç°æ€è·¯:**
```go
type WorkflowValidator struct {
    capabilityLoader *template.AgentCapabilityLoader
}

func (v *WorkflowValidator) Validate(definition map[string]any) []ValidationError {
    errors := []ValidationError{}
    
    // 1. æ£€æŸ¥å¿…éœ€å­—æ®µ
    steps := definition["steps"]
    if steps == nil {
        errors = append(errors, ValidationError{
            Field: "steps",
            Message: "ç¼ºå°‘ steps å­—æ®µ",
        })
        return errors
    }
    
    // 2. æ£€æŸ¥æ¯ä¸ªæ­¥éª¤
    stepList := steps.([]any)
    for i, step := range stepList {
        stepMap := step.(map[string]any)
        
        // æ£€æŸ¥ agent_type æ˜¯å¦æœ‰æ•ˆ
        agentType := stepMap["agent_type"].(string)
        if _, err := v.capabilityLoader.GetCapabilities(agentType); err != nil {
            errors = append(errors, ValidationError{
                Field: fmt.Sprintf("steps[%d].agent_type", i),
                Message: fmt.Sprintf("æ— æ•ˆçš„ Agent ç±»å‹: %s", agentType),
            })
        }
        
        // æ£€æŸ¥ role æ˜¯å¦æœ‰æ•ˆ
        if role, ok := stepMap["role"].(string); ok && role != "" {
            if _, err := v.capabilityLoader.GetRoleCapability(agentType, role); err != nil {
                errors = append(errors, ValidationError{
                    Field: fmt.Sprintf("steps[%d].role", i),
                    Message: fmt.Sprintf("æ— æ•ˆçš„è§’è‰²: %s/%s", agentType, role),
                })
            }
        }
    }
    
    // 3. æ£€æŸ¥ä¾èµ–å…³ç³»
    errors = append(errors, v.validateDependencies(stepList)...)
    
    return errors
}
```

### ä¼˜åŒ– 6: æ•°æ®åº“è¿ç§»è„šæœ¬
**æ–‡ä»¶:** `db/migrations/004_workflow_templates.sql` (æ–°å»º)

```sql
-- å·¥ä½œæµæ¨¡æ¿è¡¨
CREATE TABLE IF NOT EXISTS workflow_templates (
    id UUID PRIMARY KEY,
    tenant_id UUID,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    category VARCHAR(100),
    definition JSONB NOT NULL,
    is_system BOOLEAN DEFAULT FALSE,
    is_public BOOLEAN DEFAULT FALSE,
    usage_count INTEGER DEFAULT 0,
    created_by VARCHAR(100),
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW(),
    deleted_at TIMESTAMP
);

CREATE INDEX idx_workflow_templates_tenant ON workflow_templates(tenant_id);
CREATE INDEX idx_workflow_templates_category ON workflow_templates(category);

-- Agent èƒ½åŠ›è¡¨
CREATE TABLE IF NOT EXISTS agent_capabilities (
    id UUID PRIMARY KEY,
    agent_type VARCHAR(100) NOT NULL,
    role VARCHAR(100) NOT NULL,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    input_fields TEXT[],
    output_fields TEXT[],
    system_prompt_template TEXT,
    recommended_config JSONB,
    enabled BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE UNIQUE INDEX idx_agent_capabilities_type_role ON agent_capabilities(agent_type, role);
```

### ä¼˜åŒ– 7: æ·»åŠ ç¼“å­˜æœºåˆ¶
**æ–‡ä»¶:** `workflow/template/loader.go`

**ä¼˜åŒ–:**
```go
type TemplateLoader struct {
    templates       map[string]*Template
    instantiated    map[string]map[string]any  // ç¼“å­˜å®ä¾‹åŒ–ç»“æœ
    mu              sync.RWMutex
}

func (l *TemplateLoader) InstantiateTemplate(key string, params map[string]any) (map[string]any, error) {
    // ç”Ÿæˆç¼“å­˜é”®
    cacheKey := l.getCacheKey(key, params)
    
    // æ£€æŸ¥ç¼“å­˜
    l.mu.RLock()
    if cached, ok := l.instantiated[cacheKey]; ok {
        l.mu.RUnlock()
        return deepCopyMap(cached), nil
    }
    l.mu.RUnlock()
    
    // å®ä¾‹åŒ–
    definition := ...
    
    // ç¼“å­˜ç»“æœ
    l.mu.Lock()
    l.instantiated[cacheKey] = deepCopyMap(definition)
    l.mu.Unlock()
    
    return definition, nil
}
```

### ä¼˜åŒ– 8: æ·»åŠ ä½¿ç”¨ç¤ºä¾‹ä»£ç 
**æ–‡ä»¶:** `examples/custom_workflow_example.go` (æ–°å»º)

```go
package main

func main() {
    // ç¤ºä¾‹ 1: ä½¿ç”¨é¢„è®¾æ¨¡æ¿å¿«é€Ÿåˆ›å»º
    client := NewAPIClient(...)
    
    workflow, err := client.QuickCreateWorkflow(&QuickCreateRequest{
        Template: "outline-only",
        Name:     "æˆ‘çš„å¤§çº²å·¥ä½œæµ",
        Config: map[string]any{
            "topic": "AI æŠ€æœ¯è¶‹åŠ¿",
        },
    })
    
    // ç¤ºä¾‹ 2: è‡ªå®šä¹‰ Agent é“¾
    workflow, err = client.CustomCreateWorkflow(&CustomCreateRequest{
        Name: "è‡ªå®šä¹‰å·¥ä½œæµ",
        AgentChain: []AgentConfig{
            {AgentType: "planner", Role: "outline_generator"},
            {AgentType: "reviewer", Role: "outline_reviewer", ApprovalRequired: true},
        },
    })
    
    // ç¤ºä¾‹ 3: æ‰§è¡Œå·¥ä½œæµ
    result, err := client.ExecuteWorkflow(workflow.ID, map[string]any{
        "topic": "åŒºå—é“¾æŠ€æœ¯",
    })
}
```

## ğŸ“‹ å®æ–½ä¼˜å…ˆçº§

### P0 - å¿…é¡»ä¿®å¤ï¼ˆé˜»å¡åŠŸèƒ½ï¼‰
1. âœ… ä¿®å¤ fmt å¯¼å…¥ç¼ºå¤±
2. âœ… æ‰©å±• Agent åˆ›å»ºé€»è¾‘æ”¯æŒè§’è‰²
3. âœ… æ·»åŠ åº”ç”¨åˆå§‹åŒ–ä»£ç 

### P1 - é«˜ä¼˜å…ˆçº§ï¼ˆå½±å“ä½“éªŒï¼‰
4. âœ… å®ç°æ¨¡æ¿å‚æ•°æ›¿æ¢
5. âœ… å®ç°å·¥ä½œæµå®šä¹‰éªŒè¯
6. âœ… æ•°æ®åº“è¿ç§»è„šæœ¬

### P2 - ä¸­ä¼˜å…ˆçº§ï¼ˆä¼˜åŒ–æ€§èƒ½ï¼‰
7. â¸ï¸ æ·»åŠ ç¼“å­˜æœºåˆ¶
8. â¸ï¸ æ·»åŠ ä½¿ç”¨ç¤ºä¾‹ä»£ç 

## ğŸ”§ å®æ–½æ­¥éª¤

1. ä¿®å¤ template_handler.go çš„å¯¼å…¥
2. åˆ›å»º Agent è§’è‰²æ”¯æŒç»„ä»¶
3. å®ç°å‚æ•°æ›¿æ¢é€»è¾‘
4. åˆ›å»ºåˆå§‹åŒ–ä»£ç 
5. å®ç°å·¥ä½œæµéªŒè¯å™¨
6. åˆ›å»ºæ•°æ®åº“è¿ç§»è„šæœ¬
7. æ›´æ–°æ–‡æ¡£è¯´æ˜

æ˜¯å¦å¼€å§‹å®æ–½ä¼˜åŒ–ï¼Ÿ