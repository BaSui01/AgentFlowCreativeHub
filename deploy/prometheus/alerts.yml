# Prometheus 告警规则
# AgentFlowCreativeHub 监控告警

groups:
  # API 告警组
  - name: api_alerts
    interval: 30s
    rules:
      # API 错误率过高告警
      - alert: HighAPIErrorRate
        expr: |
          (
            rate(agentflow_api_requests_total{status=~"5.."}[5m]) 
            / 
            rate(agentflow_api_requests_total[5m])
          ) > 0.05
        for: 5m
        labels:
          severity: warning
          component: api
        annotations:
          summary: "API 错误率过高"
          description: "API 错误率 {{ $value | humanizePercentage }}，超过 5%。路径: {{ $labels.path }}"
          dashboard: "http://grafana:3000/d/agentflow/agentflow-monitoring"

      # API 延迟过高告警
      - alert: HighAPILatency
        expr: |
          histogram_quantile(0.95, 
            rate(agentflow_api_request_duration_seconds_bucket[5m])
          ) > 2
        for: 5m
        labels:
          severity: warning
          component: api
        annotations:
          summary: "API 延迟过高"
          description: "API P95 延迟 {{ $value | humanizeDuration }}，超过 2 秒。路径: {{ $labels.path }}"

      # API 请求量异常下降
      - alert: LowAPIRequestRate
        expr: |
          rate(agentflow_api_requests_total[5m]) < 0.1
        for: 10m
        labels:
          severity: info
          component: api
        annotations:
          summary: "API 请求量异常下降"
          description: "API QPS {{ $value | humanize }}，低于正常水平"

  # Agent 告警组
  - name: agent_alerts
    interval: 30s
    rules:
      # Agent 执行失败率过高
      - alert: HighAgentFailureRate
        expr: |
          (
            rate(agentflow_agent_executions_total{status="failed"}[5m])
            /
            rate(agentflow_agent_executions_total[5m])
          ) > 0.1
        for: 5m
        labels:
          severity: critical
          component: agent
        annotations:
          summary: "Agent 执行失败率过高"
          description: "Agent {{ $labels.agent_type }} 失败率 {{ $value | humanizePercentage }}，超过 10%。租户: {{ $labels.tenant_id }}"

      # Agent 执行耗时过长
      - alert: SlowAgentExecution
        expr: |
          histogram_quantile(0.95,
            rate(agentflow_agent_execution_duration_seconds_bucket[5m])
          ) > 60
        for: 5m
        labels:
          severity: warning
          component: agent
        annotations:
          summary: "Agent 执行耗时过长"
          description: "Agent {{ $labels.agent_type }} P95 耗时 {{ $value | humanizeDuration }}，超过 60 秒"

      # 运行中的 Agent 数量过多
      - alert: TooManyRunningAgents
        expr: |
          sum(agentflow_agent_executions_running) > 100
        for: 5m
        labels:
          severity: warning
          component: agent
        annotations:
          summary: "运行中的 Agent 数量过多"
          description: "当前运行中的 Agent 数量 {{ $value }}，可能存在资源瓶颈"

  # RAG 告警组
  - name: rag_alerts
    interval: 30s
    rules:
      # RAG 检索失败率过高
      - alert: HighRAGSearchFailureRate
        expr: |
          (
            rate(agentflow_rag_searches_total{status="failed"}[5m])
            /
            rate(agentflow_rag_searches_total[5m])
          ) > 0.1
        for: 5m
        labels:
          severity: warning
          component: rag
        annotations:
          summary: "RAG 检索失败率过高"
          description: "知识库 {{ $labels.kb_id }} 检索失败率 {{ $value | humanizePercentage }}，超过 10%"

      # RAG 检索延迟过高
      - alert: SlowRAGSearch
        expr: |
          histogram_quantile(0.95,
            rate(agentflow_rag_search_duration_seconds_bucket[5m])
          ) > 0.5
        for: 5m
        labels:
          severity: warning
          component: rag
        annotations:
          summary: "RAG 检索性能下降"
          description: "知识库 {{ $labels.kb_id }} P95 检索时间 {{ $value | humanizeDuration }}，超过 500ms"

  # 数据库告警组
  - name: database_alerts
    interval: 30s
    rules:
      # 数据库连接数过高
      - alert: HighDatabaseConnections
        expr: |
          agentflow_db_connections{state="open"} > 20
        for: 5m
        labels:
          severity: warning
          component: database
        annotations:
          summary: "数据库连接数过高"
          description: "当前打开的数据库连接数 {{ $value }}，接近上限（25）"

      # 数据库查询延迟过高
      - alert: SlowDatabaseQuery
        expr: |
          histogram_quantile(0.95,
            rate(agentflow_db_query_duration_seconds_bucket[5m])
          ) > 1
        for: 5m
        labels:
          severity: warning
          component: database
        annotations:
          summary: "数据库查询延迟过高"
          description: "数据库 P95 查询延迟 {{ $value | humanizeDuration }}，超过 1 秒。操作: {{ $labels.operation }}"

  # 系统资源告警组
  - name: system_alerts
    interval: 30s
    rules:
      # 内存使用过高
      - alert: HighMemoryUsage
        expr: |
          agentflow_go_memory_usage_bytes / (1024 * 1024 * 1024) > 2
        for: 5m
        labels:
          severity: warning
          component: system
        annotations:
          summary: "内存使用过高"
          description: "应用内存使用 {{ $value | humanize }}GB，超过 2GB"

      # Goroutine 数量过多
      - alert: TooManyGoroutines
        expr: |
          agentflow_go_goroutines > 10000
        for: 5m
        labels:
          severity: warning
          component: system
        annotations:
          summary: "Goroutine 数量过多"
          description: "当前 Goroutine 数量 {{ $value }}，可能存在 Goroutine 泄漏"

  # 工作流告警组
  - name: workflow_alerts
    interval: 30s
    rules:
      # 工作流执行失败率过高
      - alert: HighWorkflowFailureRate
        expr: |
          (
            rate(agentflow_workflow_executions_total{status="failed"}[5m])
            /
            rate(agentflow_workflow_executions_total[5m])
          ) > 0.2
        for: 5m
        labels:
          severity: critical
          component: workflow
        annotations:
          summary: "工作流执行失败率过高"
          description: "工作流 {{ $labels.workflow_id }} 失败率 {{ $value | humanizePercentage }}，超过 20%"

      # 工作流执行耗时过长
      - alert: SlowWorkflowExecution
        expr: |
          histogram_quantile(0.95,
            rate(agentflow_workflow_execution_duration_seconds_bucket[5m])
          ) > 300
        for: 5m
        labels:
          severity: warning
          component: workflow
        annotations:
          summary: "工作流执行耗时过长"
          description: "工作流 {{ $labels.workflow_id }} P95 耗时 {{ $value | humanizeDuration }}，超过 5 分钟"

  # 应用健康检查
  - name: health_alerts
    interval: 30s
    rules:
      # 应用宕机
      - alert: ApplicationDown
        expr: |
          up{job="agentflow-backend"} == 0
        for: 1m
        labels:
          severity: critical
          component: system
        annotations:
          summary: "应用宕机"
          description: "AgentFlow Backend 应用无法访问，持续时间超过 1 分钟"
